"use strict";var arloApp=angular.module("arloApp",["arloApp.filters","ui.bootstrap","ui.bootstrap.tooltip","ui.router","arloApp.services","arloApp.directives","arloApp.controllers","ngResource","localization","pasvaz.bindonce","arloPartials"]).constant("appProperties",{passwordHelpContext:"/passwordHelp",logoutContext:"/logout",devicesContext:"/users/devices",syncBaseStationContext:"/users/devices/update",notifyContext:"/users/devices/notify",notifyResponsesPushServiceContext:"/client/subscribe",claimDeviceContext:"/users/devices/claimDevice",streamContext:"/users/devices/startStream",stopStreamContext:"/users/devices/stopStream",startRecordContext:"/users/devices/startRecord",stopRecordContext:"/users/devices/stopRecord",takeSnapshotContext:"/users/devices/takeSnapshot",takeFullFrameSnapshotContext:"/users/devices/fullFrameSnapshot",takeUserFrameSnapshotContext:"/users/devices/userSnapshot",metadataContext:"/users/library/metadata",recordingsContext:"/users/library",libraryStateContext:"/users/library/state/v1",editContext:"/users/media",favoriteContext:"/users/library/favorite",profileContext:"/users/profile",registerContext:"/register",friendsContext:"/users/friends",friendsDeleteContext:"/users/friends/remove",queryPresentDevicesContext:"/locateDevice",updateNameContext:"/user",updatePasswordContext:"/users/changePassword",requestPasswordResetContext:"/requestPasswordReset",resetPasswordContext:"/resetPassword",updateUserIdContext:"/users/changeEmail",confirmUserIdContext:"/users/resend/confirm/email",jsonContext:"/json",recycleContext:"/users/library/recycle",getOffersContext:"/users/payment/offers",getOffersV1Context:"/users/payment/offers/v1",getOffersDetailsContext:"/users/payment/offersdetail",createPaymentAccountContext:"/users/payment/accounts",paymentQuotationContext:"/users/payment/quotations",paymentBillingContext:"/users/payment/billing",paymentRenewContext:"/users/payment/autoRenew",servicePlanContext:"/users/serviceLevel",servicePlansPaymentContext:"/users/payment/plans",upgradeContext:"/upgrade",checkEmailUsage:"/checkEmailUsage",cameraOrderContext:"/users/devices/displayOrder",deleteAccountContext:"/users/closeAccount",removeDeviceContext:"/users/devices/removeDevice",renameDeviceContext:"/users/devices/renameDevice",restartDeviceContext:"/users/devices/restart",preferencesContext:"/users/preferences",storageQuotaContext:"/users/quota",termsContext:"/termsAndConditions",policyContext:"/policy/v1",updateTermsContext:"/users/termsAndConditions",updatePolicyContext:"/users/policy",renewContext:"/renew",cancelContext:"/cancel",changeContext:"/change",allContext:"/all",_RESOURCE_UPDATE_:"_RESOURCE_UPDATE_",DEVICE_UPDATE:"DEVICE_UPDATE",BILLING_EVENT:"BILLING_EVENT",urlTld:".com",portNo:":8080",registerTokenText:"registrationtoken",resetPasswordTokenText:"passwordresetcode=",loginRoute:"/login",claimBaseStationRoute:"/claimBaseStation",accountRegistrationRoute:"/accountRegistration",billingInformationRoute:"/billingInformation",syncHardwareRoute:"/syncHardware",calendarRoute:"/calendar",camerasRoute:"/cameras",dayRoute:"/day",recordingRoute:"/recording",recordingSharedRoute:"/viewShared",settingsRoute:"/settings",cameraSettingsRoute:"/settings/camera",listFriendsRoute:"/friends/list",editFriendRoute:"/friends/edit/",personalInfoRoute:"/settings/personalInfo",modesRoute:"/modes",editModeRoute:"/modes/edit",rulesRoute:"/rules",editRuleRoute:"/rule",alertEmailsRoute:"/alerts/emails",editAlertsRoute:"/alerts",scheduleRoute:"/schedule",dailyScheduleRoute:"/schedule/daily",weeklyScheduleRoute:"/schedule/weekly",servicePlanRoute:"/plans/select",upgradeServicePlanRoute:"/plans/select/upgrade",upgradeStoragePlanRoute:"/plans/storage/upgrade",FREE_PLAN_TYPE:"BASIC",PAID_PLAN_TYPE:"SERVICE",STORAGE_PLAN_TYPE:"STORAGE",ONE_MEGA:1048576,videoFormat:"video/mp4",HTML5:"HTML5",JWPLAYER:"JWPLAYER",FLOWPLAYER:"FLOWPLAYER",REGISTRATION_TOKEN:"registrationToken",ACCEPTANCE_PENDING:"pending",BASE_STATION_DEVICE_TYPE:"basestation",CAMERA_DEVICE_TYPE:"camera",FAVORITE_STATE:"favorite",NEW_STATE:"new",REMOVED_STATE:"removed",DEACTIVATED_STATE:"deactivated",RECYCLE_STATE:"recycle",PROVISIONED_STATE:"provisioned",SYNCED_STATE:"synced",AVAILABLE_STATE:"available",UNAVAILABLE_STATE:"unavailable",DEVICE_ACTIONS:["recordActiveMotionVideo","recordSnapshot","sendEmailAlert"],DEVICE_TRIGGERS:["motionDetect","lowBattery","lowSignalStrength"],DEVICE_TRANSACTION_PREFIX:"basestation",WEB_TRANSACTION_PREFIX:"web",DEVICE_SETTINGS_ACTIVE:"active",DEVICE_SCHEDULE:"schedule",CAMERA_SETTINGS_ACTIVITYSTATE:"activityState",CAMERA_SETTINGS_ACTIVITYSTATE_POSITION_MODE:"startPositionStream",CAMERA_ACTIVITYSTATE_START_ALERT_STREAM:"startAlertStream",CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE:"alertStreamActive",CAMERA_ACTIVITYSTATE_ALERT_SNAPSHOT:"alertSnapshot",CAMERA_ACTIVITYSTATE_ALERT_WATCH:"alertStreamActiveWatchAlong",CAMERA_ACTIVITYSTATE_FULLFRAMESNAPSHOT:"fullFrameSnapshot",CAMERA_SETTINGS_ACTIVITYSTATE_MOTION_DETECTION_MODE:"setupMotionStart",CAMERA_SETTINGS_ACTIVITYSTATE_IDLE:"idle",CAMERA_SETTINGS_ACTIVITYSTATE_STREAM:"startUserStream",CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM:"userStreamActive",CONNECTION_STATE:"connectionState",CAMERA_CONNECTION_STATE:"connectionState",CAMERA_CONNECTION_STATE_AVAILABLE:"available",CAMERA_CONNECTION_STATE_BATTERY_CRITICAL:"batteryCritical",CAMERA_CONNECTION_STATE_UNAVAILABLE:"unavailable",POSITION_MODE_DURATION:3e5,CAMERA_SETTINGS_POWERSAVEMODE:"powerSaveMode",CAMERA_SETTINGS_POWERSAVEMODE_BEST_VIDEO:3,CAMERA_SETTINGS_POWERSAVEMODE_OPTIMIZED:2,CAMERA_SETTINGS_POWERSAVEMODE_BATTERY_LIFE:1,CAMERA_SETTINGS_BRIGHTNESS:"brightness",CAMERA_SETTINGS_MIRROR:"mirror",CAMERA_SETTINGS_FLIP:"flip",CAMERA_SETTINGS_ZOOM:"zoom",CAMERA_STATUS_BATTERY_LEVEL:"batteryLevel",CAMERA_STATUS_SIGNAL_STRENGTH:"signalStrength",CAMERA_STATUS_MOTION:"motion",SENSOR_MOTION_DETECTION_STATE:"pirMotionActive",CSS_CAMERA_MOTION_DISABLED:"0",CSS_CAMERA_MOTION_ACTIVE:"1",CSS_CAMERA_MOTION_ARMED:"2",USER_ROLE_OWNER:"OWNER",USER_ROLE_ADMIN:"ADMIN",USER_ROLE_USER:"USER",months:["January","February","March","April","May","June","July","August","September","October","November","December"],favoritesOptions:[{value:"all",text:"filter_label_all"},{value:"only",text:"filter_label_favorites"},{value:"non",text:"filter_label_non_favorites"}],timeZoneHash:[{offset:"660",location:"Pacific/Apia",id:"WST11"},{offset:"600",location:"Pacific/Honolulu",id:"HST10"},{offset:"540",location:"America/Anchorage",id:"AKST9AKDT,M3.2.0,M11.1.0"},{offset:"480",location:"America/Los_Angeles",id:"PST8PDT,M3.2.0,M11.1.0"},{offset:"420",location:"America/Phoenix",id:"MST7"},{offset:"360",location:"America/Chicago",id:"CST6CDT,M3.2.0,M11.1.0"},{offset:"300",location:"America/New_York",id:"EST5EDT,M3.2.0,M11.1.0"},{offset:"270",location:"America/Caracas",id:"VET4:30"},{offset:"240",location:"America/Santiago",id:"CLT"},{offset:"210",location:"America/St_Johns",id:"NST3:30NDT,M3.2.0/0:01,M11.1.0/0:01"},{offset:"180",location:"America/Sao_Paulo",id:"BRT3BRST,M10.3.0/0,M2.3.0/0"},{offset:"60",location:"Atlantic/Cape_Verde",id:"CVT1"},{offset:"0",location:"Europe/London",id:"GMT0BST,M3.5.0/1,M10.5.0"},{offset:"-60",location:"Europe/Paris",id:"CET-1CEST,M3.5.0,M10.5.0/3"},{offset:"-120",location:"Europe/Athens",id:"EET-2EEST,M3.5.0/3,M10.5.0/4"},{offset:"-180",location:"Europe/Moscow",id:"MSK-4"},{offset:"-210",location:"Asia/Tehran",id:"IRST"},{offset:"-240",location:"Asia/Dubai",id:"GST-4"},{offset:"-270",location:"Asia/Kabul",id:"AFT-4:30"},{offset:"-300",location:"Asia/Karachi",id:"PKT-5"},{offset:"-330",location:"Asia/Kolkata",id:"IST-5:30"},{offset:"-360",location:"Asia/Dhaka",id:"BDT-6"},{offset:"-390",location:"Asia/Rangoon",id:"MMT-6:30"},{offset:"-420",location:"Asia/Jakarta",id:"WIT-7"},{offset:"-480",location:"Asia/Shanghai",id:"CST-8"},{offset:"-540",location:"Asia/Tokyo",id:"JST-9"},{offset:"-570",location:"Australia/Adelaide",id:"CST-9:30CST,M10.1.0,M4.1.0/3"},{offset:"-600",location:"Australia/Sydney",id:"EST-10EST,M10.1.0,M4.1.0/3"},{offset:"-660",location:"Pacific/Noumea",id:"NCT-11"},{offset:"-720",location:"Pacific/Auckland",id:"NZST-12NZDT,M9.5.0,M4.1.0/3"},{offset:"-780",location:"Pacific/Tongatapu",id:"TOT-13"}],appEvents:{BODY_CLICK:"body_click",TAKE_SNAPSHOT:"take_snapshot",SNAPSHOT_LOADED:"snapshot_loaded",SHOW_ERROR:"show_error",HIDE_ERROR:"hide_error",CAMERA_BUSY:"camera_busy",SCROLL_TOP:"scrollTop",BRIGHTNESS_UPDATED:"brightness_updated",BS_REBOOTED:"bs_rebooted",MEDIA_UPLOAD_NOTIFICATION:"mediaUploadNotification"}}).value("localStorage",window.localStorage).value("sessionStorage",window.sessionStorage).config(["$sceProvider","$locationProvider","$compileProvider","$httpProvider","$logProvider",function(e,t,r,n,i){r.aHrefSanitizationWhitelist(/^\s*(https?|mailto|file):/),n.defaults.useXDomain=!0,delete n.defaults.headers.common["X-REQUESTED-WITH"],e.enabled(!1),window._DEBUG_&&i.debugEnabled(_DEBUG_),n.interceptors.push("authInterceptor")}]).config(["$stateProvider","$urlRouterProvider","appProperties",function(e,t,r){e.state("login",{url:"/login",templateUrl:"partials/loginView.html",controller:"LoginCtrl",authenticate:!1}).state("useMobile",{url:"/useMobile",templateUrl:"partials/useMobileView.html",authenticate:!1}).state("oldBrowser",{url:"/oldBrowser",templateUrl:"partials/oldBrowserView.html",controller:"ShutdownCtrl",authenticate:!1}).state("otherTab",{url:"/otherTab",templateUrl:"partials/otherTabView.html",controller:"ShutdownCtrl",authenticate:!1}).state("gettingStarted",{url:"/gettingStarted",templateUrl:"partials/gettingStartedView.html",authenticate:!1}).state("claimBaseStation",{url:"/claimBaseStation",templateUrl:"partials/claimBaseStationView.html",controller:"ClaimBaseStationCtrl",authenticate:!1}).state("passwordHelp",{url:r.passwordHelpContext,templateUrl:"partials/passwordHelpView.html",controller:"PasswordHelpCtrl",authenticate:!1}).state("accountRegistration",{url:"/accountRegistration",templateUrl:"partials/accountRegistrationView.html",controller:"AccountRegistrationCtrl",authenticate:!1}).state("servicePlan",{url:r.servicePlanRoute,templateUrl:"partials/selectServicePlanView.html",controller:"SelectServicePlanCtrl",authenticate:!1}).state("billingInformation",{url:r.billingInformationRoute,templateUrl:"partials/billingInformationView.html",controller:"BillingInformationCtrl",authenticate:!1}).state("syncHardware",{url:r.syncHardwareRoute,templateUrl:"partials/syncHardwareView.html",controller:"SyncHardwareCtrl",authenticate:!1}).state("modes",{url:r.modesRoute,templateUrl:"partials/footerModesView.html",controller:"FooterModesCtrl",authenticate:!0}).state("cameras",{url:r.camerasRoute,templateUrl:"partials/camerasView.html",controller:"CamerasCtrl",authenticate:!0}).state("calendar",{url:r.calendarRoute+"/:month/:favorites/:cameraIds/:day",templateUrl:"partials/calendarView.html",controller:"CalendarCtrl",authenticate:!0}).state("calendar.day",{url:"/day",templateUrl:"partials/dayView.html",controller:"DayCtrl",authenticate:!0}).state("calendar.recycled",{url:"/recycled",templateUrl:"partials/recycleView.html",controller:"RecycledCtrl",authenticate:!0}).state("defaultCalendar",{url:r.calendarRoute,templateUrl:"partials/calendarView.html",controller:"CalendarCtrl",authenticate:!0}).state("recordingsDefault",{url:r.dayRoute,templateUrl:"partials/dayView.html",controller:"DayCtrl",authenticate:!0}).state("defaultRecording",{url:r.recordingRoute,templateUrl:"partials/recordingView.html",controller:"RecordingCtrl",authenticate:!0}).state("recording",{url:r.recordingRoute+"/:favorites/:cameraIds/:recordingNumber",templateUrl:"partials/recordingView.html",controller:"RecordingCtrl",authenticate:!0}).state("recordingShared",{url:r.recordingSharedRoute+"/:token",templateUrl:"partials/sharedRecordingView.html",controller:"SharedRecordingCtrl",authenticate:!1}).state("recordingShared2",{url:"/shared/:token",templateUrl:"partials/sharedRecordingView.html",controller:"SharedRecordingCtrl",authenticate:!1}).state("settings",{url:r.settingsRoute,templateUrl:"partials/settingsView.html",controller:"SettingsCtrl",authenticate:!0}).state("settings.camera",{url:"/camera/:deviceId",templateUrl:"partials/cameraSettingsView.html",controller:"CameraSettingsCtrl",authenticate:!0}).state("settings.personalInfo",{url:"/personalInfo",templateUrl:"partials/personalInfoView.html",controller:"PersonalInfoCtrl",authenticate:!0}).state("settings.friends",{url:"/friends",templateUrl:"partials/friendsView.html",controller:"FriendsCtrl",authenticate:!0}).state("settings.editFriend",{url:"/friends/edit/:email",templateUrl:"partials/editFriendView.html",controller:"EditFriendCtrl",authenticate:!0}).state("settings.addFriend",{url:"/friends/edit",templateUrl:"partials/editFriendView.html",controller:"EditFriendCtrl",authenticate:!0}).state("settings.modes",{url:"/modes/:deviceId",templateUrl:"partials/modesView.html",controller:"ModesCtrl",authenticate:!0}).state("settings.editMode",{url:"/modes/edit/:deviceId/:modeId",templateUrl:"partials/editModeView.html",controller:"EditModeCtrl",authenticate:!0}).state("settings.addMode",{url:"/modes/edit/:deviceId",templateUrl:"partials/editModeView.html",controller:"EditModeCtrl",authenticate:!0}).state("settings.rules",{url:"/rules/:deviceId",templateUrl:"partials/rulesView.html",controller:"RulesCtrl",authenticate:!0}).state("settings.editModeRule",{url:"/modes/rule/edit/:baseStationId/:modeId/:ruleId",templateUrl:"partials/editRuleView.html",controller:"EditRuleCtrl",authenticate:!0}).state("settings.addModeRule",{url:"/modes/rule/add/:baseStationId/:modeId",templateUrl:"partials/editRuleView.html",controller:"EditRuleCtrl",authenticate:!0}).state("settings.editRule",{url:"/modes/rule/edit/:baseStationId/:ruleId",templateUrl:"partials/editRuleView.html",controller:"EditRuleCtrl",authenticate:!0}).state("settings.addRule",{url:"/modes/rule/add/:baseStationId",templateUrl:"partials/editRuleView.html",controller:"EditRuleCtrl",authenticate:!0}).state("settings.cameraOrder",{url:"/cameraOrder",templateUrl:"partials/cameraOrderView.html",controller:"CameraOrderCtrl",authenticate:!0}).state("settings.about",{url:"/about",templateUrl:"partials/settingsAboutView.html",controller:"AboutCtrl",authenticate:!0}).state("settings.baseStation",{url:"/baseStation/:baseStationId",templateUrl:"partials/settingsBaseStationView.html",controller:"BaseStationCtrl",authenticate:!0}).state("settings.baseStationUpdate",{url:"/baseStationUpdate/:deviceId",templateUrl:"partials/settingsBaseStationUpdateView.html",controller:"BaseStationUpdateCtrl",authenticate:!0}).state("settings.subscription",{url:"/subscription",templateUrl:"partials/settingsSubscriptionView.html",controller:"SubscriptionCtrl",reload:!0,authenticate:!0}).state("settings.plans",{url:"/subscription/plans",templateUrl:"partials/settingsSelectPlanView.html",controller:"SubscriptionPlansCtrl",reload:!0,authenticate:!0}).state("settings.billingInformation",{url:r.billingInformationRoute,templateUrl:"partials/billingInformationView.html",controller:"BillingInformationCtrl",authenticate:!0}).state("settings.servicePlan",{url:r.upgradeServicePlanRoute,templateUrl:"partials/selectServicePlanView.html",controller:"SelectServicePlanCtrl",authenticate:!0}).state("settings.preferences",{url:"/preferences",templateUrl:"partials/settingsPreferencesView.html",controller:"PreferencesCtrl",authenticate:!0}).state("settings.positionMode",{url:"/positionMode/:deviceId",templateUrl:"partials/positionModeView.html",controller:"CamerasCtrl",authenticate:!0}).state("settings.motionTest",{url:"/motionTest/:deviceId",templateUrl:"partials/motionTestView.html",controller:"motionTestCtrl",authenticate:!0}),t.otherwise("/login")}]).run(["$rootScope","$state","$http","urlService","calendarService","libraryService","appProperties","userService","appStateService","pushHandlerService","utilService",function(e,t,r,n,i,a,o,s,c,d,l){n.setWebUrl(),c.loadSessionData(),i.setDefaultMonth(),a.setFavorites(o.favoritesOptions[0]);var u=timezoneJS.timezone;u.loadingScheme=u.loadingSchemes.MANUAL_LOAD,u.transport=function(e){r.get(e.url).then(function(t){e.success(t.data)})},u.loadZoneJSONData("json/tz_cities.json?v=VERSION",!1),e.$on("$stateChangeStart",function(e,r,n,i){return r.authenticate&&!s.isLoggedIn()?(e.preventDefault(),t.go("login"),!1):r.authenticate&&s.isLoggedIn()&&l.checkMobile()?(e.preventDefault(),!1):void(i.abstract&&s.isLoggedIn()&&d.init())})}]);angular.module("arloApp.services",[]).factory("urlService",["appProperties","$location",function(e,t){return{ssoToken:null,webUrl:null,getLoginUrl:function(){return this.webUrl+e.loginRoute},getNotifyResponsesPushServiceUrl:function(){return this.webUrl+e.notifyResponsesPushServiceContext},getDeviceEventsPushServiceUrl:function(){return e.deviceEventsPushServiceUrl},getLanguageCodesUrl:function(){return this.staticAssetsUrl+e.jsonContext+"/languagecodes.json?v=VERSION"},getCountryCodesUrl:function(){return this.staticAssetsUrl+e.jsonContext+"/countrycodes.json?v=VERSION"},getStatesUSCodesUrl:function(){return this.staticAssetsUrl+e.jsonContext+"/usstatescodes.json?v=VERSION"},getStatesGBCodesUrl:function(){return this.staticAssetsUrl+e.jsonContext+"/ukstatescodes.json?v=VERSION"},getTimeZonesUrl:function(){return this.staticAssetsUrl+e.jsonContext+"/timezones.json?v=VERSION"},getSecretQuestionsUrl:function(){return this.staticAssetsUrl+e.jsonContext+"/secretquestions.json?v=VERSION"},getProfileUrl:function(){return this.webUrl+e.profileContext},getQueryPresentDevicesUrl:function(){return this.webUrl+e.queryPresentDevicesContext},getRegisterUserUrl:function(){return this.webUrl+e.registerContext},getOffersUrl:function(){return this.webUrl+e.getOffersContext},getOffersV1Url:function(){return this.webUrl+e.getOffersV1Context},getOffersDetailsUrl:function(){return this.webUrl+e.getOffersDetailsContext},getCreatePaymentAccountUrl:function(){return this.webUrl+e.createPaymentAccountContext},getUpgradePaymentPlanUrl:function(){return this.webUrl+e.upgradePaymentPlanContext},getModifyBillingUrl:function(t){return this.webUrl+e.paymentBillingContext+"/"+t},getCreateQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t},getChangeQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t+e.changeContext},getRenewQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t+e.renewContext},getCancelQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t+e.cancelContext},getCreatePlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t},getChangePlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t},getRenewPlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t+e.renewContext},getCancelPlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t+e.cancelContext},getPaymentBillingUrl:function(t){return this.webUrl+e.paymentBillingContext+"/"+t},getPaymentRenewUrl:function(t){return this.webUrl+e.paymentRenewContext+"/"+t},getClaimDeviceUrl:function(){return this.webUrl+e.claimDeviceContext},getFriendsUrl:function(){return this.webUrl+e.friendsContext},getFriendsDeleteUrl:function(){return this.webUrl+e.friendsDeleteContext},getUpdateUserIdUrl:function(){return this.webUrl+e.updateUserIdContext},getConfirmUserIdUrl:function(){return this.webUrl+e.confirmUserIdContext},getUpdatePasswordUrl:function(){return this.webUrl+e.updatePasswordContext},getRequestPasswordResetUrl:function(){return this.webUrl+e.requestPasswordResetContext},getResetPasswordUrl:function(){return this.webUrl+e.resetPasswordContext},getUpdateNameUrl:function(){return this.webUrl+e.updateNameContext},getLogoutUrl:function(){return this.webUrl+e.logoutContext},setWebUrl:function(){this.staticAssetsUrl=t.protocol()+"://"+t.host(),this.webUrl=this.staticAssetsUrl+"/hmsweb"},getDevicesUrl:function(t){return this.webUrl+e.devicesContext+(t?"/"+t:"")},getSyncBaseStationUrl:function(t){return this.webUrl+e.syncBaseStationContext+"/"+t},getNotifyUrl:function(t){return this.webUrl+e.notifyContext+"/"+t},getFullFrameSnapshotUrl:function(){return this.webUrl+e.takeFullFrameSnapshotContext},getUserFrameSnapshotUrl:function(){return this.webUrl+e.takeUserFrameSnapshotContext},getStartStreamUrl:function(){var t=this.webUrl+e.streamContext;return t},getStopStreamUrl:function(){var t=this.webUrl+e.stopStreamContext;return t},getStartRecordUrl:function(){var t=this.webUrl+e.startRecordContext;return t},getStopRecordUrl:function(){var t=this.webUrl+e.stopRecordContext;return t},getTakeSnapshotUrl:function(){var t=this.webUrl+e.takeSnapshotContext;return t},getMetadataUrl:function(){return this.webUrl+e.metadataContext},getRecordingsUrl:function(){return this.webUrl+e.recordingsContext},getDeviceUrl:function(t){return this.webUrl+e.devicesContext+"/"+t},getEditUrl:function(){return this.webUrl+e.editContext},getFavoriteUrl:function(){return this.webUrl+e.favoriteContext},getCheckEmailUrl:function(){return this.webUrl+e.checkEmailUsage},getRecycleUrl:function(){return this.webUrl+e.recycleContext},getShareUrl:function(){return this.webUrl+"/users/library/share"},getRecycleAllUrl:function(){return this.webUrl+e.recycleContext+e.allContext},getCameraOrderUrl:function(){return this.webUrl+e.cameraOrderContext},getDeleteAccountUrl:function(){return this.webUrl+e.deleteAccountContext},getRemoveDeviceUrl:function(){return this.webUrl+e.removeDeviceContext},getRenameDeviceUrl:function(){return this.webUrl+e.renameDeviceContext},getRestartDeviceUrl:function(){return this.webUrl+e.restartDeviceContext},getPreferencesUrl:function(){return this.webUrl+e.preferencesContext},getServicePlanUrl:function(){return this.webUrl+e.servicePlanContext},getStorageQuotaUrl:function(){return this.webUrl+e.storageQuotaContext},getLibraryStateUrl:function(){return this.webUrl+e.libraryStateContext},getTermsUrl:function(){return this.webUrl+e.termsContext},getPolicyUrl:function(){return this.webUrl+e.policyContext}}}]).factory("authInterceptor",["$q","$injector","$log","$cacheFactory","$rootScope","$filter",function(e,t,r,n,i,a){return{response:function(i){if(t.get("offlineService").isOffline=!1,401===i.status){r.info("Got 401 status from server"),t.get("gatewayPollingService").shutdown(),t.get("pushHandlerService").shutdown();var a=t.get("userService");a.setSsoToken(""),a.settings||(t.get("loginService").redirectError="Session expired. Please relog-in."),t.get("$state").go("login"),t.get("appStateService").clearSessionData(),n.get("$http").removeAll()}return i||e.when(i)},responseError:function(o){switch(o.status){case 0:o.data||t.get("offlineService").checkOffline();break;case 401:t.get("offlineService").isOffline=!1,r.info("Got 401 status from server on response error"),t.get("gatewayPollingService").shutdown(),t.get("pushHandlerService").shutdown();var s=t.get("userService");s.setSsoToken(""),t.get("$state").go("login"),t.get("appStateService").clearSessionData(),n.get("$http").removeAll(),s.settings||(t.get("loginService").redirectError="Session expired. Please relog-in.");break;case 500:case 501:case 502:case 503:i.$broadcast("show_error",{data:{message:a("i18n")("error_http_"+o.status)}})}return e.reject(o)}}}]).factory("utilService",["$state",function(e){return{id:0,isMobile:navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/Silk/i),previousState:{},s4:function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},guid:function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()},nextId:function(){return this.id++},checkMobile:function(){return this.isMobile?(e.go("useMobile"),!0):!1}}}]).factory("ajaxService",["$http","$log","userService",function(e,t,r){return{defaultTimeout:3e4,ajaxGet:function(e,t,r,n){ajaxCall("get",e,t,r,n)},ajaxPost:function(e,t,r,n,i){ajaxCall("post",e,t,r,n,i)},ajaxPut:function(e,t,r,n,i){ajaxCall("put",e,t,r,n,i)},ajaxDelete:function(e,t,r,n,i){ajaxCall("delete",e,t,r,n,i)},ajaxCall:function(n,i,a,o,s,c){var d={method:n,url:a,timeout:defaultTimeout,headers:{Authorization:r.ssoToken}};if((n.toUpperCase.match(/GET/)||i)&&(d.data=i),null==c)delete d.headers;else if(c)for(var l in c)c.hasOwnProperty(l)&&(d.headers[l]=c[l]);t.debug("calling server with config:"+JSON.stringify(d));var u=e(d).then(successCallback(result),s(result));return u}}}]).factory("loginService",["$http","$window","$timeout","$log","$q","urlService","userService","localStorage","appProperties",function(e,t,r,n,i,a,o,s,c){return{reLoggedIn:!1,checkCredentials:function(t,r,s){var c={email:t,password:r};s&&(c.registrationToken=s);var d={method:"POST",url:a.getLoginUrl(),data:c,timeout:3e5},l=this,u=e(d).then(function(e){if(1==e.data.success)n.debug("got result:"+JSON.stringify(e)),o.setSsoToken(e.data.data.token),l.ssoToken=e.data.data.token,o.setUserId(e.data.data.userId),o.setUserName(e.data.data.email),o.setPaymentId(e.data.data.paymentId),o.setCountryCode(e.data.data.countryCode),o.setValidEmail(e.data.data.validEmail),l.loginError=!1;else if(t!=r&&"undefined"!=t&&null!=t&&""!=t)return n.warn("login not successful"),i.reject(e.data);return e.data},function(e){return n.error("login error, server returned: "+JSON.stringify(e)),i.reject(e.data)});return u},updatePassword:function(t,r){var s={currentPassword:t,newPassword:r},c={method:"POST",url:a.getUpdatePasswordUrl(),data:s,timeout:3e4,headers:{Authorization:this.ssoToken||o.ssoToken}};n.debug("calling updatePassword with config:"+JSON.stringify(c));var d=e(c).then(function(e){return 1!=e.data.success?(n.warn("update password error: "+JSON.stringify(e)),i.reject(e.data)):(o.settings&&o.setSettings(r),void n.debug("update password result: "+JSON.stringify(e)))},function(e){return n.error("update password error: "+JSON.stringify(e)),i.reject(e.data)});return d},requestPasswordReset:function(t){var r={email:t},o={method:"POST",url:a.getRequestPasswordResetUrl(),data:r,timeout:3e4};n.debug("calling requestPasswordReset with config: "+JSON.stringify(o));var s=e(o).then(function(e){1==e.data.success?n.debug("Request password reset success:"+JSON.stringify(e)):n.warn("server returned error:"+r.code+r.message)},function(e){return n.error("Request password reset error, server returned: "+JSON.stringify(e)),i.reject(e.data)});return s},resetPassword:function(t,r){var i={newPassword:t,passwordResetCode:r},o={method:"POST",url:a.getResetPasswordUrl(),data:i,timeout:3e4};n.debug("calling resetPassword with config:"+JSON.stringify(o));var s=e(o).then(function(e){1==e.data.success?n.debug("Reset password success:"+JSON.stringify(e)):n.warn("server returned error:"+i.code+i.message)},function(e){n.error("Reset password error, server returned:"+JSON.stringify(e))});return s},updateTosVersion:function(t){var r={method:"POST",url:a.webUrl+c.updateTermsContext,data:{acceptedTermConditionVersion:t},timeout:3e4,headers:{Authorization:o.ssoToken}};n.debug("calling updateTosVersion with config:"+JSON.stringify(r));var s=e(r).then(function(e){return e.data&&e.data.success?e.data:i.reject(e.data)},function(e){return n.error("update updateTosVersion error: "+JSON.stringify(e)),i.reject(e)});return s},updatePolicyVersion:function(t){var r={method:"POST",url:a.webUrl+c.updatePolicyContext,data:{acceptedPolicyVersion:t},timeout:3e4,headers:{Authorization:o.ssoToken}};n.debug("calling updatePolicyVersion with config:"+JSON.stringify(r));var s=e(r).then(function(e){return e.data&&e.data.success?e.data:i.reject(e.data)},function(e){return n.error("update updatePolicyVersion error: "+JSON.stringify(e)),i.reject(e)});return s}}}]).factory("logoutService",["$rootScope","$http","$log","$injector","$modalStack","$q","urlService","appStateService","userService","recordingsService","calendarService","servicePlanService","cameraSettingsService","uiService","baseStationService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p){return{logoutError:null,logout:function(v){if(n.get("pushHandlerService").shutdown(),n.get("gatewayPollingService").shutdown(),i.dismissAll(),s.clearSessionData(),d.selectMode=!1,l.stateParams=null,u.purchasedPlans=null,u.billingInfo=null,f.gettingCameraSettings=null,g.scope=e.$new(!0),p.rebootingBS=[],n.get("gatewayPollingService").baseStationAlerts={},v)return s.clearSessionData(),a.when(1);var m={method:"PUT",url:o.getLogoutUrl(),timeout:3e5,headers:{Authorization:c.ssoToken}},h=this,S=t(m).then(function(e){r.debug("got result:"+JSON.stringify(e)),s.clearSessionData(),h.logoutError=!1},function(e){r.debug("got result:"+JSON.stringify(e)),s.clearSessionData(),h.logoutError=!0});return S}}}]).factory("jsonService",["$resource","$http","urlService",function(e,t,r){return{languageCodes:function(){var t=r.getLanguageCodesUrl();return e(t)},countryCodes:function(){var t=r.getCountryCodesUrl();return e(t)},stateUSCodes:function(){var t=r.getStatesUSCodesUrl();return e(t)},stateGBCodes:function(){var t=r.getStatesGBCodesUrl();return e(t)},timeZones:function(){var t=r.getTimeZonesUrl();return e(t)},secretQuestions:function(){var e=r.getSecretQuestionsUrl();return t.get(e)}}}]).factory("userService",["$http","$log","$window","$q","$location","localStorage","setupService","urlService","appProperties",function(e,t,r,n,i,a,o,s,c){return{userName:null,ssoToken:null,userId:null,firstName:null,lastName:null,password:null,preferences:null,fromLogout:null,validEmail:null,ignoreUpdates:null,calendarSessionPopup:null,calendarClientPopup:null,rulesSessionPopup:null,rulesClientPopup:null,paymentId:null,setCalendarSessionPopup:function(e){this.calendarSessionPopup=e,this.persistCalendarSessionPopup()},setCalendarClientPopup:function(e){this.calendarClientPopup=e,this.persistСalendarClientPopup()},setRulesSessionPopup:function(e){this.rulesSessionPopup=e,this.persistRulesSessionPopup()},setRulesClientPopup:function(e){this.rulesClientPopup=e,this.persistRulesClientPopup()},setUserId:function(e){this.userId=e,this.persistUserId()},setUserName:function(e){this.userName=e,this.persistUserName()},clearSettings:function(){this.settings=null,a.settings&&a.removeItem("settings")},setPaymentId:function(e){this.paymentId=e,this.persistPaymentId()},setFirstName:function(e){this.firstName=e,this.persistFirstName()},setLastName:function(e){this.lastName=e,this.persistLastName()},setSsoToken:function(e){this.ssoToken=e,this.persistSsoToken()},setCountryCode:function(e){this.countryCode=e,a.setItem("countryCode",this.countryCode)},clearFromLogout:function(){this.fromLogout=!1,a.fromLogout&&a.removeItem("fromLogout")},setFromLogout:function(){this.fromLogout=!0,a.setItem("fromLogout",this.fromLogout)},setValidEmail:function(e){this.validEmail=e.toString(),a.setItem("validEmail",this.validEmail)},setIgnoreUpdates:function(e){this.ignoreUpdates=e,e?a.setItem("ignoreUpdates","1"):a.ignoreUpdates&&a.removeItem("ignoreUpdates")},isLoggedIn:function(){return this.ssoToken&&!0},updateUserId:function(r,i){var a={email:r,currentPassword:i},o={method:"POST",url:s.getUpdateUserIdUrl(),data:a,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling updateUserId with config:"+JSON.stringify(o));var c=e(o).then(function(e){1==e.data.success?t.debug("got result: "+JSON.stringify(e)):(t.warn("update userId error: "+JSON.stringify(e)),n.reject(e.data))},function(e){t.error("update userId error: "+JSON.stringify(e)),n.reject(e.data)});return c},updateName:function(r,n){var i={firstName:r,lastName:n},a={method:"PUT",url:s.getProfileUrl(),data:i,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling updateName with config:"+JSON.stringify(a));var o=this,c=e(a).then(function(e){1==e.data.success?(t.debug("got result:"+JSON.stringify(e)),o.setFirstName(r),o.setLastName(n)):t.warn("server returned error:"+i.code+i.message)},function(e){t.error("update name error, server returned:"+JSON.stringify(e))});return c},getProfile:function(){var r={method:"GET",url:s.getProfileUrl(),headers:{Authorization:this.ssoToken}};
t.debug("accessing get profile with config:"+JSON.stringify(r));var n=this,i=e(r).then(function(e){1==e.data.success?(t.debug("got result:"+JSON.stringify(e)),"undefined"!=typeof e.data.data.userId&&n.setUserId(e.data.data.userId),n.setFirstName(e.data.data.firstName),n.setLastName(e.data.data.lastName),e.data.data.hasOwnProperty("validEmail")&&n.setValidEmail(e.data.data.validEmail),n.getProfileError=!1):t.warn("server returned error:"+e.data.code+e.data.message)},function(e){t.error("getProfile error, server returned:"+JSON.stringify(e)),n.getProfileError=!0});return i},register:function(r){var a;if(o.selectedBaseStation)a=o.selectedBaseStation.registrationToken;else{o.friendUser=!0;var d=i.absUrl(),l=d.split("?")[1];0===l.indexOf(c.REGISTRATION_TOKEN)&&-1===l.indexOf("&")&&(a=l.split("=")[1],a=a.split("#")[0],a=a.split("/")[0])}r.timeZone&&r.timeZone.ui&&delete r.timeZone.ui;var u={method:"POST",url:s.getRegisterUserUrl(),data:r,timeout:3e4,headers:{registrationToken:a}},f=this;t.debug("calling register user with config:"+JSON.stringify(u));var g=e(u).then(function(e){return 1!=e.data.success?(t.warn("server returned error:"+e.data.data.error+e.data.data.message),f.registerUserError=!0,n.reject(e.data)):(t.debug("got POST result:"+JSON.stringify(e)),f.setSsoToken(e.data.data.token),f.setUserId(e.data.data.userId),f.setUserName(r.email),e.data.data.paymentId&&f.setPaymentId(e.data.data.paymentId),f.setCountryCode(e.data.data.country),f.registerUserError=!1,o.accountRegistered=!0,o.baseStationClaimed=!0,void 0)},function(e){t.error("Register user error, server returned:"+JSON.stringify(e));var r="",i=e.data.data;return i&&i.validationErrors?angular.forEach(i.validationErrors.items,function(e){r+=e.message+"\n"}):r=e.data||"You are not connected to the internet",f.registerUserError=!0,n.reject(r)});return g},persistCalendarSessionPopup:function(){a.setItem("calendarSessionPopup",this.calendarSessionPopup)},"persistСalendarClientPopup":function(){a.setItem("calendarClientPopup",this.calendarClientPopup)},persistRulesSessionPopup:function(){a.setItem("rulesSessionPopup",this.rulesSessionPopup)},persistRulesClientPopup:function(){a.setItem("rulesClientPopup",this.rulesClientPopup)},persistUserId:function(){a.setItem("userId",this.userId)},persistPaymentId:function(){a.setItem("paymentId",this.paymentId)},persistUserName:function(){a.setItem("userName",this.userName)},setSettings:function(e){var t=_.times(e.length,function(t){return e.charCodeAt(t)+20});this.settings=!0,a.setItem("settings",JSON.stringify(t))},persistFirstName:function(){a.setItem("firstName",this.firstName)},persistLastName:function(){a.setItem("lastName",this.lastName)},persistSsoToken:function(){a.setItem("ssoToken",this.ssoToken)},loadSessionData:function(){_.each(["userId","userName","settings","firstName","lastName","ssoToken","paymentId","fromLogout","countryCode","validEmail","ignoreUpdates","calendarClientPopup","rulesClientPopup"],function(e){this[e]=a[e]||null},this)},clearSessionData:function(){_.each(["userId","firstName","lastName","ssoToken","paymentId","countryCode","validEmail","ignoreUpdates"],function(e){this[e]=null,a[e]&&a.removeItem(e)},this)},checkEmailUsage:function(r){var i={email:r},a={method:"POST",url:s.getCheckEmailUrl(),data:i,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling checkEmailUsage with config:"+JSON.stringify(a));var o=e(a).then(function(e){return 1==e.data.success&&t.debug("got result checkEmailUsage:"+JSON.stringify(e)),e},function(e){return t.error("checkEmailUsage error, server returned:"+JSON.stringify(e)),n.reject(e.data)});return o},deleteAccount:function(){var r={method:"POST",url:s.getDeleteAccountUrl(),headers:{Authorization:this.ssoToken}};t.debug("calling delete Account with config:"+JSON.stringify(r));var i=e(r).then(function(e){return 1==e.data.success&&t.debug("got result delete Account:"+JSON.stringify(e)),e},function(e){return t.error("delete Account error, server returned:"+JSON.stringify(e)),n.reject(e.data)});return i},updatePreferences:function(){var r={method:"GET",url:s.getPreferencesUrl(),headers:{Authorization:this.ssoToken}};t.debug("getting preferences with config:"+JSON.stringify(r));var i=this,a=e(r).then(function(e){1==e.data.success&&(t.debug("got result:"+JSON.stringify(e)),i.preferences=e.data.data)},function(e){return t.error("getPreferences error, server returned:"+JSON.stringify(e)),n.reject(e.data)});return a},getPreferences:function(){return this.preferences},setPreferences:function(r){var i={method:"POST",url:s.getPreferencesUrl(),data:r,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling setPreferences with config:"+JSON.stringify(i));var a=e(i).then(function(e){1==e.data.success&&t.debug("got result:"+JSON.stringify(e))},function(e){return t.error("update name error, server returned:"+JSON.stringify(e)),n.reject(e.data)});return a},updateStorageQuota:function(){var r={method:"GET",url:s.getStorageQuotaUrl(),headers:{Authorization:this.ssoToken}};t.debug("getting storage quota with config:"+JSON.stringify(r));var i=this,a=e(r).then(function(e){1==e.data.success&&(t.debug("got result:"+JSON.stringify(e)),i.storageQuota=e.data.data)},function(e){return t.error("updateStorage error, server returned:"+JSON.stringify(e)),n.reject(e.data)});return a},getSettings:function(){var e=a.settings;return e?_.reduce(JSON.parse(e),function(e,t){return e+String.fromCharCode(t-20)},""):null},confirmEmail:function(){var r={method:"GET",url:s.getConfirmUserIdUrl(),timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling confirmEmail with config: "+JSON.stringify(r));var i=e(r).then(function(e){return 1!=e.data.success?n.reject(e.data):void t.debug("got result: "+JSON.stringify(e))},function(e){return t.error("confirmEmail error: "+JSON.stringify(e)),n.reject(e.data)});return i}}}]).factory("friendsService",["$http","$log","$window","$q","userService","appProperties","localStorage","urlService",function(e,t,r,n,i,a,o,s){return{friends:null,addFriend:function(r){var n=(_.findWhere(this.friends,{email:r.email}),{method:"POST",url:s.getFriendsUrl(),data:r,timeout:3e4,headers:{Authorization:i.ssoToken}});t.debug("calling add friend with config:"+JSON.stringify(n));var a=this,o=e(n).then(function(e){1==e.data.success?(a.friends.push(r),t.debug("got POST result:"+JSON.stringify(e)),a.addFriendError=!1):(t.warn("server returned error:"+e.data.data.error+e.data.data.message),a.addFriendError=!0)},function(e){t.error("Add friend error, server returned:"+JSON.stringify(e)),a.addFriendError=!0});return o},editFriend:function(r){var n={method:"PUT",url:s.getFriendsUrl(),data:r,timeout:3e4,headers:{Authorization:i.ssoToken}};t.debug("calling edit friend with config:"+JSON.stringify(n));var a=this,o=e(n).then(function(e){if(1==e.data.success){var n=_.findWhere(a.friends,{email:r.email});"undefined"===n&&a.friends.push(r),t.debug("got PUT result:"+JSON.stringify(e)),a.editFriendError=!1}else t.warn("server returned error:"+e.data.data.error+e.data.data.message),a.editFriendError=!0},function(e){t.error("Edit friend error, server returned:"+JSON.stringify(e)),a.editFriendError=!0});return o},deleteFriend:function(r){var n={method:"POST",url:s.getFriendsDeleteUrl(),data:{email:r.email},timeout:3e4,headers:{Authorization:i.ssoToken}};t.debug("calling delete friend with config:"+JSON.stringify(n));var a=this,o=e(n).then(function(e){1==e.data.success?(t.debug("got DELETE friend result:"+JSON.stringify(e)),a.deleteFriendError=!1):(t.warn("server returned error:"+e.data.data.error+e.data.data.message),a.deleteFriendError=!0)},function(e){t.error("Delete friend error, server returned:"+JSON.stringify(e)),a.deleteFriendError=!0});return o},getFriends:function(){var r={method:"GET",url:s.getFriendsUrl(),timeout:3e4,headers:{Authorization:i.ssoToken}};t.debug("calling get friends with config:"+JSON.stringify(r));var n=this,a=e(r).then(function(e){1==e.data.success?(t.debug("got get friends result:"+JSON.stringify(e)),n.friends=e.data.data,n.getFriendError=!1):(t.warn("server returned error:"+e.data.data.error+e.data.data.message),n.getFriendError=!0)},function(e){t.error("Get friend error, server returned:"+JSON.stringify(e)),n.getFriendError=!0});return a},createFriendObject:function(e,t,r,n){return{email:e,firstName:t,lastName:r,devices:n,acceptanceState:a.ACCEPTANCE_PENDING}}}}]).factory("appStateService",["userService","devicesService","calendarService","metadataService","libraryService","dayService","recordingsService",function(e,t,r,n,i,a,o){return{loadSessionData:function(){e.loadSessionData(),t.loadSessionData(),n.loadSessionData(),i.loadSessionData(),a.loadSessionData(),o.loadSessionData()},clearSessionData:function(){e.clearSessionData(),t.clearSessionData(),n.clearSessionData(),i.clearSessionData(),a.clearSessionData(),o.clearSessionData()}}}]).factory("transactionService",function(){return{createTransactionId:function(){var e=Math.random()*Math.pow(2,32),t=new Date;return"web!"+e.toString(16)+"!"+t.getTime().toString()}}}).factory("pushHandlerService",["$interval","$log","$state","$rootScope","$injector","$filter","urlService","notifyService","devicesService","baseStationService","cameraSettingsService","userService","deviceEventsChannel","logoutService","camerasService","loginService","appProperties","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v,m,h){return{notifyResponsesSource:null,deviceEventsSource:null,cleanResponsesHandlersPromise:null,sseErrors:[],init:function(){this.notifyResponsesSource&&(this.notifyResponsesSource.close(),t.warn("Attempt to reinitialize the notifyResponsesSource subscribing twice"));var r=o.getNotifyResponsesPushServiceUrl()+"?token="+u.ssoToken;this.notifyResponsesSource=new EventSource(r);var n=this;this.notifyResponsesSource.addEventListener("message",function(e){n.notifyResponsesCallback(e)},!1),this.notifyResponsesSource.addEventListener("error",function(e){n.notifyResponsesErrorCallback(e)},!1);var n=this;this.cleanResponsesHandlersPromise=e(function(){n.cleanResponsesHandlerQueue()},s.cleanHandlerQueueInterval)},shutdown:function(){this.notifyResponsesSource&&(this.notifyResponsesSource.close(),this.notifyResponsesSource=null),this.deviceEventsSource&&(this.deviceEventsSource.close(),this.deviceEventsSource=null),this.responseHandlers=null,e.cancel(this.cleanResponsesHandlersPromise)},notifyResponsesCallback:function(e){if("connected"!=e.data){var r=JSON.parse(e.data);if(h.checkTransId(r)){t.debug("got sse message in notify response callback:"+e.data);var i;if(i="mediaUploadNotification"==r.resource?_.findWhere(c.allDevices,{deviceId:r.deviceId}):"diagnostics"==r.resource?_.findWhere(c.allDevices,{deviceId:r.from}):r.transId&&r.transId.split("!").length>1&&(_.findWhere(c.allDevices),{deviceId:r.transId.split("!")[0]}),i||r.transId||r.deviceId)if(r.error){if(4006==r.error.code||4011==r.error.code)n.$broadcast(m.appEvents.CAMERA_BUSY,{deviceId:r.resource.split("/")[1],message:a("i18n")("base_station_error_"+r.error.code)});else{switch(r.error.code){case 4e3:case 4003:case 4009:r.error.message=a("i18n")("base_station_error_"+r.error.code)}n.$broadcast("show_error",{data:r.error})}r.transId&&s.responseHandlers[r.transId]&&(s.responseHandlers[r.transId].failureHandler.call(d,r),t.debug("removing response handlers for transaction:"+r.transId),delete s.responseHandlers[r.transId])}else if("mediaUploadNotification"==r.resource){for(var o in r){var l=r[o];"deviceId"!=o&&"resource"!=o&&l&&(i[o]=l,"presignedLastImageUrl"==o&&c.updateLastDate(i))}n.$broadcast(m.appEvents.MEDIA_UPLOAD_NOTIFICATION)}else"diagnostics"==r.resource&&"reboot"==r.action?(d.rebootingBS[r.from]=!0,n.$broadcast(m.appEvents.BS_REBOOTED,r.from)):s.responseHandlers[r.transId]?(s.responseHandlers[r.transId].successHandler.call(d,r),t.debug("removing response handlers for transaction:"+r.transId),delete s.responseHandlers[r.transId]):0===r.transId.indexOf(m.DEVICE_TRANSACTION_PREFIX)||i?(t.debug("got sse message from device, transaction id:"+r.transId),this.deviceEventsCallback(e)):t.warn("Got sse message coming from unknown source");else t.error("SSE message transaction id missing or null")}}},notifyResponsesErrorCallback:function(){t.warn("Restarting SSE on error."),this.sseErrors.push((new Date).getTime()),h.checkOffline(),3==this.sseErrors.length&&this.sseErrors[2]-this.sseErrors[0]<4e4&&!h.isOffline?r.go("otherTab"):3==this.sseErrors.length&&(this.sseErrors=[])},cleanResponsesHandlerQueue:function(){var e=_.keys(s.responseHandlers),t=Date.now(),r=_.filter(e,function(e){var r=s.responseHandlers[e].notifyTime+s.responseHandlers[e].timeout;return t>r?!0:!1});_.each(r,function(e){s.responseHandlers[e].failureHandler(s.responseHandlers[e].query),delete s.responseHandlers[e]})},deviceEventsCallback:function(e){var i=JSON.parse(e.data);if(i.from){var o=c.getDeviceById(i.from);o&&(o.properties||(o.properties={}),o.properties.connectionState="available")}if("logout"===i.action)t.info("Got server logout event"),u.setFromLogout(),v.redirectError="You have been logged out because you have logged in on another device or browser.",g.logout(!0).then(function(){r.go("login")});else if(i.resource){var s=i.resource.split("/")[1]||i.from;if(i.action&&"new"==i.action&&"OWNER"==o.userRole){if(_.findWhere(c.devices,{deviceId:s}))return;var h=_.findWhere(c.allDevices,{deviceId:s});return h?(h.state="",c.devices.push(h)):(h={deviceId:s,parentId:i.from,properties:{connectionState:"available"}},c.devices.push(h),c.allDevices.push(h)),this.devices=a("orderBy")(this.devices,"displayOrder"),c.uiStateHash[s]={play:!1,record:!1,micLevel:0,showBright:!1},void c.getDevice(s).then(function(){var e=c.getDeviceById(s);l.getBaseStationCameraSettings(e.parentId),d.getBaseStationResource(e.parentId,"modes"),d.getBaseStationResource(e.parentId,"rules"),n.$broadcast("new_camera",i)})}if(i.action&&("fullFrameSnapshotAvailable"==i.action||"userSnapshotAvailable"==i.action)){var h=_.findWhere(c.allDevices,{deviceId:s});for(var S in i.properties)h[S]=i.properties[S];return void n.$broadcast(m.appEvents.SNAPSHOT_LOADED,{deviceId:s,presignedSnapshotUrl:h.presignedSnapshotUrl})}if(i.properties&&f.eventData(s,i.properties),"cameras"==i.resource.split("/")[0]){if(i.action)p.cameraEvent(s,i);else if(window._DEBUG_)throw"Got camera event with no action:"+JSON.stringify(e)}else"modes"==i.resource&&d.handleModesEvent(i)}else if(window._DEBUG_)throw"Got device event with no resource property:"+JSON.stringify(e)}}}]).factory("notifyService",["$log","$window","$http","$q","urlService","userService","transactionService","devicesService",function(e,t,r,n,i,a,o,s){return{result:null,responseHandlers:{},failureHandlers:{},cleanHandlerQueueInterval:1e3,notifyBaseStation:function(t,o,c,d){e.debug("************** In notifyBaseStation, processing transaction:"+t.transId),!t.to;var l,u=_.findWhere(s.devices,{deviceId:t.to});if(u)l=u.xCloudId;else{var f=s.findByParentId(t.to);if(!f&&window._DEBUG_)throw"Could not find friend device to notify";l=f[0].xCloudId}var g={method:"POST",url:i.getNotifyUrl(t.to),data:t,timeout:3e4,headers:{Authorization:a.ssoToken,xcloudId:l}},p=n.defer(),v=this;e.debug("setting response handlers for transaction:"+t.transId),v.responseHandlers[t.transId]={query:t,successHandler:o,failureHandler:c,notifyTime:Date.now(),timeout:d},e.debug("sending notify message:"+JSON.stringify(g));r(g).then(function(r){v.result=r,1==r.data.success?(e.debug("got notify result:"+JSON.stringify(r)),v.notifyError=!1):(e.warn("server returned error:"+r.data.data.error+r.data.data.message),v.notifyError=!0,delete v.responseHandlers[t.transId]),p.resolve(r)},function(r){v.result=r,e.error("Got notify error, server returned:"+JSON.stringify(r)),v.notifyError=!0,p.resolve(r),delete v.responseHandlers[t.transId]});return p.promise},createDeviceQuery:function(e,t,r,n){var i={from:a.userId,to:e,action:t,resource:r,responseUrl:"",publishResponse:!1,transId:o.createTransactionId()};if(n){i.properties={};for(var s in n)n.hasOwnProperty(s)&&(i.properties[s]=n[s])}return i},createResourceQuery:function(e,t,r,n){var i={from:a.userId,to:e,action:t,responseUrl:"",resource:r,transId:o.createTransactionId()};return i.publishResponse="get"===t?!1:!0,n&&(i.properties={},i.properties[r]=n),i},createSubresourceQuery:function(e,t,r,n){var i={from:a.userId,to:e,action:t,responseUrl:"",resource:r,transId:o.createTransactionId()};if(i.publishResponse="get"===t?!1:!0,n){i.properties={};for(var s in n)n.hasOwnProperty(s)&&(i.properties[s]=n[s])}return i}}}]).factory("deviceEventsChannel",["$rootScope","devicesService",function(e){var t="_DEVICE_EVENT_",r="_NEW_DEVICE_",n="_REFRESH_CAMERAS_",i=function(r,n){var i={deviceId:r};for(var a in n)n.hasOwnProperty(a)&&(i[a]=n[a]);e.$broadcast(t,i)},a=function(e,r){e.$on(t,function(e,t){r(t)})},o=function(t){e.$broadcast(r,t)},s=function(e,t){e.$on(r,function(e,r){t(r)})},c=function(){e.$broadcast(n,{})},d=function(e,t){e.$on(n,function(e,r){t(r)})};return{eventData:i,onEventData:a,refreshCameras:c,onRefreshCameras:d,newDevice:o,onNewDevice:s}}]).factory("setupService",function(){return{isSetup:null,setupPending:null,accountRegistered:null,baseStationClaimed:null,servicePlanSelected:null,servicePlanPaidFor:null,billingInformationGiven:null,selectedBaseStation:null,timeZone:null,friendUser:!1,start:function(){return this.isSetup?!1:(this.setupPending=!0,this.accountRegistered||(this.accountRegistered=!1),this.baseStationClaimed||(this.baseStationClaimed=!1),this.servicePlanSelected||(this.servicePlanSelected=!1),this.billingInformationGiven||(this.billingInformationGiven=!1),this.accountRegistered&&this.baseStationClaimed?(this.setupPending=!1,!1):void 0)},updateSetupState:function(){this.accountRegistered&&this.friendUser?(this.isSetup=!0,this.setupPending=!1,this.friendUser=!1):this.baseStationClaimed&&this.accountRegistered&&this.servicePlanSelected&&(this.setupPending=!1,this.isSetup=!0)},persistSetupState:function(){localStorage.setItem("isSetup",this.isSetup)},setSetupState:function(){localStorage.setItem("isSetup",!0)},loadSessionData:function(){_.each(["isSetup"],function(e){this[e]=localStorage[e]||null},this)}}}).factory("scheduleValidationService",["$q","$state","$rootScope","$modal","$log","appProperties","baseStationService","devicesService","userService","servicePlanService",function(e,t,r,n,i,a,o,s,c,d){return{modeArmsSensor:function(e,t){var r=s.getDeviceById(e);if(!r&&window._DEBUG_)throw"Sensor:"+e+" cannot be found";var n=s.getBaseStationById(r.parentId);if(!n&&window._DEBUG_)throw"Base station:"+r.parentId+" cannot be found";var i=_.findWhere(n.modes,{id:t});if(!i&&window._DEBUG_)throw"Mode:"+t+" cannot be found";if(!i)return!1;var o,c=i.rules;return o=_.some(c,function(t){var r=_.findWhere(n.rules,{id:t});return r?_.some(r.triggers,function(t){return t&&t.deviceId===e&&t.type===a.SENSOR_MOTION_DETECTION_STATE}):!1})},getAllEmails:function(){var e=_.reduce(s.getBaseStations(),function(e,t){return t.rules?_.union(e,t.rules):e},[]),t=_.reduce(e,function(e,t){if(t&&t.actions){var r=_.find(t.actions,function(e){return"sendEmailAlert"===e.type});if(r&&r.recipients){var n=_.map(r.recipients,function(e){return e==c.userName?"__OWNER_EMAIL__":e});return _.union(e,n)}return e}return e},[]);return t.length?t:["__OWNER_EMAIL__"]},canAddMode:function(){var e=d.getServicePlan(),t=e&&e.maxSmartHomeModes?e.maxSmartHomeModes:0,r=_.reduce(s.getBaseStations(),function(e,t){return e+(t.modes?t.modes.length:0)},0);return t>r},createDefaultEmailAction:function(){return{type:"sendEmailAlert",recipients:[]}},fixRule:function(e){if(e.triggers&&e.triggers.length)for(var t=0;t<e.triggers.length;t++)e.triggers[t].sensitivity&&"string"==typeof e.triggers[t].sensitivity&&(e.triggers[t].sensitivity=parseInt(e.triggers[t].sensitivity));if(e.actions&&e.actions.length)for(var t=0;t<e.actions.length;t++)e.actions[t].stopCondition&&e.actions[t].stopCondition.sensitivity&&"string"==typeof e.actions[t].stopCondition.sensitivity&&(e.actions[t].stopCondition.sensitivity=parseInt(e.actions[t].stopCondition.sensitivity)),e.actions[t].stopCondition&&e.actions[t].stopCondition.timeout&&"string"==typeof e.actions[t].stopCondition.timeout&&(e.actions[t].stopCondition.timeout=parseInt(e.actions[t].stopCondition.timeout))},validateRule:function(e,t){var r=!0,n=s.getDeviceById(e);if(!n&&window._DEBUG_)throw"Base station:"+e+"not found to validate rule";if(t&&t.name){if(!n.rules&&window._DEBUG_)throw"Base station:"+n.deviceId+" does not have rules";var i=_.filter(n.rules,function(e){return t.name.toLowerCase()===e.name.toLowerCase()});if(i.length>0){if(i.length>1&&window._DEBUG_)throw"Invalid rules for base station:"+e;r=t.id?t.id===i[0].id:!1}}else r=!1;return t&&t.triggers&&t.triggers.length&&t.triggers[0].deviceId||(r=!1),t&&t.actions&&t.actions.length&&t.actions[0].deviceId||(r=!1),r},validateMode:function(e,t){var r=!0,n=s.getDeviceById(e);if(!n&&window._DEBUG_)throw"Base station:"+e+"not found to validate mode";if(t&&t.name){if(!n.modes&&window._DEBUG_)throw"Base station:"+n.deviceId+" does not have modes";var i=_.filter(n.modes,function(e){return t.name.toLowerCase()===e.name.toLowerCase()});if(i.length>0){if(i.length>1&&window._DEBUG_)throw"Invalid modes for base station:"+e;r=t.id?t.id===i[0].id:!1}}else r=!1;return r},validateSchedule:function(e,t){function r(e){var t=_.groupBy(_.pluck(e,"startTime"),function(e){return Math.floor(e/864e5)});return 7===_.size(t)}if(2===arguments.length){var n=s.getBaseStationById(t);if(!n||!n.schedule&&window._DEBUG_)throw"Invalid schedule, no baseStation or no base station schedule, deviceId:"+deviceId;e=n.schedule}var i=this;if(!_.every(e,function(e){return i.scheduleEntryValid(e)})||!r(e)&&window._DEBUG_)throw"Invalid schedule:"+JSON.stringify(e)+(t?", deviceId:"+t:"");return!0},scheduleEntryValid:function(e){function t(e,t,r){return e>=t&&r>=e}var r=!0,n=0,a=/[\d\w]{1,15}/,o=6048e5;for(var s in e)e.hasOwnProperty(s)&&n++;return 2!=n?r=!1:"string"!=typeof e.modeId?r=!1:"number"!=typeof e.startTime?r=!1:a.test(e.modeId)?t(e.startTime,0,o)||(i.debug("invalid schedule, startTime invalid"+startTime),r=!1):(i.debug("invalid schedule, modeId invalid:"+modeId),r=!1),r||i.debug("invalid schedule, invalid entry:"+JSON.stringify(e)),r}}}]).factory("schedulingService",["$q","$state","$rootScope",function(e,t,r){return{editingModeInfo:null,editingRuleInfo:null,editingScheduleInfo:null,broadcastRuleAdded:function(){r.$broadcast("ruleAdded")},broadcastRuleDeleted:function(){r.$broadcast("ruleDeleted")},broadcastRuleEdited:function(){r.$broadcast("ruleEdited")},broadcastModeAdded:function(){r.$broadcast("modeAdded")},broadcastModeDeleted:function(){r.$broadcast("modeDeleted")},broadcastModeEdited:function(){r.$broadcast("modeEdited")},broadcastScheduleEdited:function(){r.$broadcast("scheduleEdited")}}}]).factory("camerasService",["$http","$window","$log","$q","devicesService","transactionService","userService","utilService","cameraSettingsService","urlService","appProperties","scheduleValidationService","baseStationService",function(e,t,r,n,i,a,o,s,c,d,l,u){return{refreshData:function(){i.getDevices()},isCameraOnline:function(e){return e.properties&&e.properties.connectionState==l.AVAILABLE_STATE},isMotionActive:function(e){var t=e.properties&&e.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]&&(e.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]===l.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM||e.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]===l.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE||e.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]===l.CAMERA_ACTIVITYSTATE_ALERT_SNAPSHOT);return t},isCameraArmed:function(e){var t=i.getBaseStationById(e.parentId);if(!t)return!1;if(t.activeMode){var r=e.properties&&e.properties[l.CAMERA_CONNECTION_STATE]&&!(e.properties[l.CAMERA_CONNECTION_STATE]===l.CAMERA_CONNECTION_STATE_UNAVAILABLE||e.properties[l.CAMERA_CONNECTION_STATE]===l.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL),n=u.modeArmsSensor(e.deviceId,t.activeMode.id);return r&&n}},cameraEvent:function(e,t){if(t.action&&"new"==t.action)i.getDevices().then(function(){});else if(t.properties)this.setPropertiesOnEvent(e,t.properties);else if(window._DEBUG_)throw"called cameraEvent with bad payload:"+JSON.stringify(t)},setPropertiesOnEvent:function(e,t){r.debug("Setting camera:"+e+"properties:"+JSON.stringify(t));var n=i.getDeviceById(e);if(n)for(var a in t)t.hasOwnProperty(a)&&(n.properties[a]=t[a])},getFullFrameSnapshot:function(t,a){var s=i.getDeviceById(t);if(s){var c={method:"POST",url:a?d.getFullFrameSnapshotUrl():d.getUserFrameSnapshotUrl(),timeout:35e3,data:this.createTakeFullFrameSnapshotPayload(s.parentId,t,a),headers:{Authorization:o.ssoToken,xcloudId:s.xCloudId}},l=e(c).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got full frame snapshot response:"+JSON.stringify(e.data))},function(e){return r.error("got full frame snapshot error:"+JSON.stringify(e.data)),n.reject(e.data)});return l}},startStream:function(t,a){var s=i.getDeviceById(t),c={method:"POST",url:d.getStartStreamUrl(),timeout:2e4,data:this.createStartStreamingPayload(s.parentId,t,a),headers:{Authorization:o.ssoToken,xcloudId:s.xCloudId}},l=e(c).then(function(e){if(1==e.data.success){r.debug("got startStream response:"+JSON.stringify(e.data));for(var a=0;a<i.devices.length;a++)if(i.devices[a].deviceId==t){i.devices[a].liveStreamUrl=e.data.data.url;break}return e.data}return r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)},function(e){return r.error("got startStream error:"+JSON.stringify(e.data)),n.reject(e.data)});return l},stopStream:function(t){var n=i.getDeviceById(t),a={method:"POST",url:d.getStartStreamUrl(),timeout:15e3,data:this.createStopStreamingPayload(n.parentId,t),headers:{Authorization:o.ssoToken,xcloudId:n.xCloudId}},s=e(a).then(function(e){1==e.data.success?r.debug("got stopStream response:"+JSON.stringify(e.data)):r.warn("server returned error:"+e.data.data.error+e.data.data.message)},function(e){r.error("got stopStream error:"+JSON.stringify(e.data))});return s},startRecord:function(t){var a=_.findWhere(i.devices,{deviceId:t.parentId}),s={method:"POST",url:d.getStartRecordUrl(),timeout:35e3,data:{parentId:t.parentId,deviceId:t.deviceId,olsonTimeZone:a.properties?a.properties.olsonTimeZone:""},headers:{Authorization:o.ssoToken,xcloudId:t.xCloudId}},c=e(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got startRecord response:"+JSON.stringify(e.data))},function(e){return r.error("got startRecord error:"+JSON.stringify(e.data)),n.reject(e.data)});return c},stopRecord:function(t){var a=i.getDeviceById(t),s={method:"POST",url:d.getStopRecordUrl(),timeout:35e3,data:{parentId:a.parentId,deviceId:t},headers:{Authorization:o.ssoToken,xcloudId:a.xCloudId}},c=e(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got stopRecording response:"+JSON.stringify(e.data))},function(e){return r.error("got stopRecording error:"+JSON.stringify(e.data)),n.reject(e.data)});return c},takeSnapshot:function(t){var a=_.findWhere(i.devices,{deviceId:t.parentId}),s={method:"POST",url:d.getTakeSnapshotUrl(),timeout:35e3,data:{parentId:t.parentId,deviceId:t.deviceId,olsonTimeZone:a.properties?a.properties.olsonTimeZone:""},headers:{Authorization:o.ssoToken,xcloudId:t.xCloudId}},c=e(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got takeSnapshot response:"+JSON.stringify(e.data))},function(e){return r.error("got takeSnapshot error:"+JSON.stringify(e.data)),n.reject(e.data)});return c},createTakeFullFrameSnapshotPayload:function(e,t,r){return{to:e,from:o.userId,resource:"cameras/"+t,action:"set",responseUrl:"",publishResponse:!0,transId:a.createTransactionId(),properties:{activityState:r?"fullFrameSnapshot":"userSnapshot"}}},createStartStreamingPayload:function(e,t,r){var n=r?l.CAMERA_SETTINGS_ACTIVITYSTATE_POSITION_MODE:l.CAMERA_SETTINGS_ACTIVITYSTATE_STREAM;return{to:e,from:s.guid(),resource:"cameras/"+t,action:"set",responseUrl:"",publishResponse:!0,transId:a.createTransactionId(),properties:{activityState:n}}},createStopStreamingPayload:function(e,t){return{to:e,from:s.guid(),resource:"cameras/"+t,action:"set",responseUrl:"",publishResponse:!0,transId:a.createTransactionId(),properties:{activityState:l.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE}}},getCameraOrder:function(){var t={method:"GET",url:d.getCameraOrderUrl(),timeout:3e4,headers:{Authorization:o.ssoToken}};r.debug("calling get camera order with config:"+JSON.stringify(t));var n=e(t).then(function(e){r.debug("got camera order result:"+JSON.stringify(e))},function(e){r.error("Get camera order error, server returned:"+JSON.stringify(e))});return n},setCameraOrder:function(t){for(var n={},i=0;i<t.length;i++)n[t[i].deviceId]=t[i].displayOrder;var a={method:"POST",url:d.getCameraOrderUrl(),timeout:3e4,headers:{Authorization:o.ssoToken},data:{devices:n}};r.debug("calling set camera order with config:"+JSON.stringify(a));var s=e(a).then(function(e){r.debug("got set camera order result:"+JSON.stringify(e))},function(e){r.error("Get error, server returned:"+JSON.stringify(e))});return s}}}]).factory("gatewayPollingService",["$rootScope","$q","$log","$interval","$state","appProperties","devicesService","userService","notifyService","baseStationService","cameraSettingsService","pushHandlerService","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(e){var t=e.deviceId;d.getBaseStationResource(t,"basestation"),l.getBaseStationCameraSettings(t);var r=i.current.name;-1!=r.indexOf("settings")?d.getBaseStationResource(t,"modes"):-1!=r.indexOf("cameras")&&(d.getBaseStationResource(t,"modes"),d.getBaseStationResource(t,"rules")),e.properties.connectionState=a.AVAILABLE_STATE,d.rebootingBS[t]=null}function p(e){var t=!1;_.each(_.where(o.devices,{parentId:e.deviceId}),function(e){o.uiStateHash[e.deviceId]&&o.uiStateHash[e.deviceId].play&&(t=!0)}),delete e.modes,delete e.activeMode,delete e.rules,delete e.schedule,delete e.scheduleOn,_.each(_.where(o.devices,{parentId:e.deviceId}),function(e){e.properties||(e.properties={}),e.properties.connectionState=a.UNAVAILABLE_STATE,o.uiStateHash[e.deviceId]={play:!1,record:!1,micLevel:0,showBright:!1}}),e.properties.connectionState=a.UNAVAILABLE_STATE}var v={pollingInterval:3e4,responseTimeout:2e4,gatewayPollingPromise:null,baseStationAlerts:{}};return v.start=function(){this.gatewayPollingPromise=n(function(){v.runPolling()},this.pollingInterval),v.runPolling()},v.runPolling=function(){var e="subscriptions/"+s.userId;_.each(o.getBaseStations(),function(t){if(t.state==a.PROVISIONED_STATE){var r=[];r.push(t.deviceId);var n=c.createDeviceQuery(t.deviceId,"set",e,{devices:r});c.notifyBaseStation(n,v.processPollResponse,v.processPollFailure,v.responseTimeout)}}),_.each(o.friendedBaseStations,function(t){var r=t.deviceId,n=o.findByParentId(r),i=_.pluck(n,"deviceId"),a=c.createDeviceQuery(r,"set",e,{devices:i});c.notifyBaseStation(a,v.processPollResponse,v.processPollFailure,v.responseTimeout)})},v.shutdown=function(){n.cancel(v.gatewayPollingPromise)},v.processPollResponse=function(e){if(!e||!e.from&&window._DEBUG_)throw"No from property in poll response";if(f.checkTransId(e)){r.debug("Got poll response from device:"+e.from),v.baseStationAlerts[e.from]=null;var t=o.getDeviceById(e.from)||_.findWhere(o.friendedBaseStations,{deviceId:e.from});t.properties||(t.properties={}),t.properties.connectionState&&t.properties.connectionState==a.AVAILABLE_STATE||g(t)}},v.processPollFailure=function(e){if(!e.to&&window._DEBUG_)throw"Expected to in poll query:"+JSON.stringify(e);if(f.checkTransId(e))return r.info("Timed out waiting for device:"+e.to+" to respond, for tansaction:"+e.transId),_.find(v.baseStationAlerts,function(e){return e&&1==e.restarted
})?v.baseStationAlerts={}:v.baseStationAlerts[e.to]||(v.baseStationAlerts[e.to]={failed:!0}),_.every(v.baseStationAlerts,_.isObject)&&_.findWhere(v.baseStationAlerts,{failed:!0})?(r.debug("Restarting SSE and Ping. Offline id: "+e.to),v.baseStationAlerts[e.to].restarted=!0,v.shutdown(),u.shutdown(),f.init(),u.init(),v.start(),void l.getAllCameraSettings()):void p(o.getDeviceById(e.to)||_.findWhere(o.friendedBaseStations,{deviceId:e.to}))},v}]).factory("baseStationService",["$rootScope","$q","$http","$log","$window","$interval","$injector","$filter","devicesService","userService","schedulingService","transactionService","notifyService","appProperties","urlService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v){return{rebootingBS:[],pollingInterval:3e4,responseTimeout:1e4,getAllCamerasOfBaseStation:function(e){return _.filter(c.getAllCameras(),function(t){return t.parentId==e})},isBaseStationAvailable:function(e){var t=c.getDeviceById(e);if(!t||!t.properties||!t.properties.connectionState||"available"!=t.properties.connectionState)return!1;var r=this.getAllCamerasOfBaseStation(e);return _.every(r,function(e){return!e.properties.activityState||"idle"===e.properties.activityState})},handleModesEvent:function(e){if(e.properties&&e.properties.activeMode){if(!e.from&&window._DEBUG_)throw"Payload has no from id:"+JSON.stringify(e);var t=c.getBaseStationById(e.from);if(!t&&window._DEBUG_)throw"Base station not found for id:"+e.from;var r=_.findWhere(t.modes,{id:e.properties.activeMode});if(!r&&window._DEBUG_)throw"Mode not found for id:"+e.properties.activeMode;t.activeMode=r}},isScheduleOn:function(e){return e.scheduleOn},syncBaseStation:function(e){var i,a=_.findWhere(c.devices,{deviceId:e});if(!a){n.error("Unable to sync "+e);var o=t.defer();return o.reject(),o.promise}i=a.xCloudId;var s={method:"POST",url:p.getSyncBaseStationUrl(e),timeout:3e4,headers:{Authorization:d.ssoToken,xcloudId:i}};n.debug("calling sync base station with config:"+JSON.stringify(s));var l=r(s).then(function(e){n.debug("got sync base station result:"+JSON.stringify(e))},function(e){n.error("Get sync base station error, server returned:"+JSON.stringify(e))});return l},getAllResources:function(){var e=[],r=this.getResource("basestation");e.push(r),r=this.getResource("schedule"),e.push(r),r=this.getResource("rules"),e.push(r),r=this.getResource("modes"),e.push(r);return t.all(e).then(function(e){for(var t=0;t<e.length;t++);})},getResource3:function(e,r,i){for(var a=[],o=c.getBaseStations(),s=0;s<o.length;s++)if(o[s].state!=g.REMOVED_STATE&&o[s].state!=g.DEACTIVATED_STATE){var d=f.createResourceQuery(o[s].deviceId,"get",e);if(n.debug("in getResource, query:"+JSON.stringify(d)),arguments.length<=1)var l=f.notifyBaseStation(d,this.attachResource,this.getResourceFailure,this.responseTimeout);else var l=f.notifyBaseStation(d,r,i,this.responseTimeout);a.push(l)}if("cameras"==e)for(var s=0;s<c.friendedBaseStationIds.length;s++){var d=f.createResourceQuery(c.friendedBaseStationIds[s],"get",e);n.debug("in get friended base station resource, query:"+JSON.stringify(d));var l=f.notifyBaseStation(d,r,i,this.responseTimeout);a.push(l)}return t.all(a).then(function(e){for(var t=0;t<e.length;t++)e[t].data&&1!=!e[t].data.success||n.warn("server returned error: "+JSON.stringify(e[t]))})},getBaseStationResource:function(e,t,r,i){var a=f.createResourceQuery(e,"get",t);n.debug("in getResource, query:"+JSON.stringify(a));var o;return o=arguments.length<=2?f.notifyBaseStation(a,this.attachResource,this.getResourceFailure,this.responseTimeout):f.notifyBaseStation(a,r,i,this.responseTimeout)},getResourceFailure:function(){},attachResource:function(t){var r=_.findWhere(c.devices,{deviceId:t.from});if(!r)return void _.each(t.properties,function(e){var t=c.getCameraById(e.serialNumber);t&&(t.properties=e)});switch("basestation"==t.resource?(r.properties?angular.extend(r.properties,t.properties):r.properties=t.properties,v.processBSUpdate(r)):r[t.resource]=t.properties[t.resource],t.resource){case"modes":_.each(r.modes,function(e){"*****_DEFAULT_MODE_ARMED_*****"==e.name?e.name=s("i18n")("default_mode_armed"):"*****_DEFAULT_MODE_DISARMED_*****"==e.name&&(e.name=s("i18n")("default_mode_disarmed"))}),r.activeMode=_.findWhere(r.modes,{id:t.properties.active});break;case"rules":_.each(r.rules,function(e){if(-1!=e.name.indexOf("**_DEFAULT_RULE_**")){var t=c.getDeviceName(e.triggers[0].deviceId);e.name=s("i18n")("default_rule_name").replace("{cameraName}",t)}});break;case"schedule":r.scheduleOn=t.properties.active}r.properties||(r.properties={}),r.properties.connectionState="available",e.$broadcast(g._RESOURCE_UPDATE_)},setResource:function(e,t,r,i,a){var o=f.createResourceQuery(e,"set",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;s.then(function(e){1==e.data.success?c.setResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error setting modes, server status "+e.status),c.setResourceError=!0)})},setSubresource:function(e,t,r,i,a){var o=f.createSubresourceQuery(e,"set",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;return s.then(function(e){1==e.data.success?c.setSubresourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error setting modes, server status "+e.status),c.setSubresourceError=!0)}),s},addSubresource:function(e,t,r,i,a){var o=f.createSubresourceQuery(e,"add",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;return s.then(function(e){1==e.data.success?c.addSubresourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error adding sub resource, server status "+e.status),c.addSubresourceError=!0)}),s},addResource:function(e,t,r,i,a){var o=f.createResourceQuery(e,"add",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;s.then(function(e){1==e.data.success?c.addResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error adding resource, server status "+e.status),c.addResourceError=!0)})},deleteResource:function(e,t,r,i,a){var o=f.createResourceQuery(e,"delete",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;s.then(function(e){1==e.data.success?c.deleteResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error deleting resource, server status "+e.status),c.deleteResourceError=!0)})},rebootResource:function(e,t,r,i){var a=f.createResourceQuery(e,"reboot",t),o=f.notifyBaseStation(a,r,i,this.responseTimeout),s=this;o.then(function(e){1==e.data.success?s.rebootResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error rebooting resource, server status "+e.status),s.rebootResourceError=!0)})},createDefaultMode:function(){return{name:"New mode",rules:[]}},createDefaultRule:function(e){return{name:s("i18n")("rule_label_default_value"),id:"ruleNew",triggers:[{deviceId:e,type:"pirMotionActive",sensitivity:80}],actions:[{type:"recordVideo",deviceId:e,stopCondition:{type:"timeout",timeout:10}},{type:"sendEmailAlert",recipients:["__OWNER_EMAIL__"]}]}},setSchedule:function(e,t){n.debug("setting schedule on base station:"+e),this.setResource(e,"schedule",t,this.setScheduleResponseHandler,this.setScheduleErrorHandler)},setScheduleResponseHandler:function(e){if("is"!==e.action);else{var t=c.getBaseStationById(e.from);t.schedule=e.properties.schedule,l.broadcastScheduleEdited()}},setScheduleErrorHandler:function(){},toggleScheduleOn:function(e,t){return n.debug("setting schedule active property on base station:"+e),this.setSubresource(e,g.DEVICE_SCHEDULE,t,this.toggleScheduleOnResponseHandler,this.toggleScheduleOnErrorHandler)},toggleScheduleOnResponseHandler:function(e){if("is"!==e.action);else{var t=c.getBaseStationById(e.from);t.scheduleOn=e.properties[g.DEVICE_SETTINGS_ACTIVE]}},toggleScheduleOnErrorHandler:function(){},setActiveModeResponseHandler:function(e){if(!e.properties||!e.properties.active&&window._DEBUG_)throw"Base station set active mode response does't contain active property";var t=c.getBaseStationById(e.from);t.activeMode=_.findWhere(t.modes,{id:e.properties.active})},setActiveMode:function(e,t){n.debug("setting active mode: "+t[g.DEVICE_SETTINGS_ACTIVE]),this.setSubresource(e,"modes",t,this.setActiveModeResponseHandler,this.setActiveModeErrorHandler)},setActiveModeErrorHandler:function(){},setModeResponseHandler:function(e){if("is"!==e.action);else{var t=c.getDeviceById(e.from);t.modes=_.reject(t.modes,function(t){return t.id===e.properties.id}),t.modes.push(e.properties),l.broadcastModeEdited()}},setMode:function(e,t){n.debug("setting mode:"+t.id),this.setSubresource(e,"modes/"+t.id,t,this.setModeResponseHandler,this.setModeErrorHandler)},setModeErrorHandler:function(){},addMode:function(e,t){n.debug("adding mode:"+t.name),this.addSubresource(e,"modes",t,this.addModeResponseHandler,this.addModeErrorHandler)},addModeResponseHandler:function(e){if("new"!==e.action);else if(e.from)if(e.hasOwnProperty("error"))n.error("got error adding mode:"+JSON.stringify(e.error));else{var t=c.getDeviceById(e.from);_.findWhere(t.modes,{id:e.properties.id})||t.modes.push(e.properties),l.editingModeInfo&&(l.editingModeInfo.addingModeId=e.properties.id),l.broadcastModeAdded()}else;},addModeErrorHandler:function(){},deleteMode:function(e,r){return n.debug("deleting mode: "+JSON.stringify(r)),this.deleteModePromise=t.defer(),this.deleteResource(e,"modes/"+r,null,this.deleteModeResponseHandler,this.deleteModeErrorHandler),this.deleteModePromise.promise},deleteModeResponseHandler:function(e){"deleted"!==e.action?this.deleteModePromise.reject("unexpected action in delete mode response"):e.from?e.error?this.deleteModePromise.reject(e.error):this.deleteModePromise.resolve(e):this.deleteModePromise.reject("unexpected no 'from' property in delete mode response")},deleteModeErrorHandler:function(){this.deleteModePromise&&this.deleteModePromise.reject("unexpected response in delete mode")},setRule:function(e,t){n.debug("setting rule:"+t.id),this.setSubresource(e,"rules/"+t.id,t,this.setRuleResponseHandler,this.setRuleErrorHandler)},setRuleResponseHandler:function(e){if("is"!==e.action);else{var t=c.getDeviceById(e.from),r=_.findWhere(t.rules,{id:e.properties.id});angular.extend(r,e.properties),l.broadcastRuleEdited()}},setRuleErrorHandler:function(){},addRule:function(e,t){n.debug("adding rule:"+t.name),this.addSubresource(e,"rules",t,this.addRuleResponseHandler,this.addRuleErrorHandler)},addRuleResponseHandler:function(e){if("new"!==e.action);else if(e.from)if(e.hasOwnProperty("error"))n.error("got error adding rule:"+JSON.stringify(e.error));else{var t=c.getDeviceById(e.from);_.findWhere(t.rules,{id:e.properties.id})||t.rules.push(e.properties),l.editingModeInfo&&(l.editingModeInfo.addingRuleId=e.properties.id),l.broadcastRuleAdded()}else;},addRuleErrorHandler:function(){},reboot:function(e){n.debug("rebooting BS: "+e),this.rebootResource(e,"basestation",this.rebootResponseHandler,this.rebootErrorHandler)},rebootResponseHandler:function(e){e.action},rebootErrorHandler:function(){},manualUpdate:function(e,t){var r=f.createResourceQuery(e,"manualUpgrade","basestation");r.properties={version:t};var n=f.notifyBaseStation(r,function(){},function(){},this.responseTimeout);n.then(function(e){1==e.data.success})},removeDevice:function(e,i){var a={method:"POST",url:p.getRemoveDeviceUrl(),data:{parentId:e,deviceId:i||e},timeout:3e4,headers:{Authorization:d.ssoToken}};n.debug("calling remove camera with config:"+JSON.stringify(a));var o=r(a).then(function(e){n.debug("got remove camera result:"+JSON.stringify(e))},function(e){return n.error("Get error, server returned:"+JSON.stringify(e)),t.reject(e.data)});return o},setTimeZone:function(e,t){n.debug("setting time zone:"+t.id),this.setSubresource(e,"basestation",{timeZone:t.id,olsonTimeZone:t.location},this.setTimeZoneResponseHandler,this.setTimeZoneErrorHandler)},setTimeZoneResponseHandler:function(e){"is"!==e.action},setTimeZoneErrorHandler:function(){},setAutoUpdate:function(e,t){n.debug("setting autoUpdateEnabled: "+t),this.setSubresource(e,"basestation",{autoUpdateEnabled:t},this.setAutoUpdateResponseHandler,this.setAutoUpdateErrorHandler)},setAutoUpdateResponseHandler:function(e){"is"!==e.action},setAutoUpdateErrorHandler:function(){},deleteRule:function(e,t){n.debug("deleting rule: "+t),this.deleteResource(e,"rules/"+t,null,this.deleteRuleResponseHandler,this.deleteRuleErrorHandler)},deleteRuleResponseHandler:function(e){if("deleted"!==e.action);else if(e.from){{c.getDeviceById(e.from),e.resource.split("/")[1]}l.broadcastRuleDeleted()}else;},deleteRuleErrorHandler:function(){},renameDevice:function(e){var i={method:"PUT",url:p.getRenameDeviceUrl(),data:{deviceId:e.deviceId,deviceName:e.deviceName,parentId:e.parentId||e.deviceId},timeout:3e4,headers:{Authorization:d.ssoToken}};n.debug("calling rename device with config:"+JSON.stringify(i));var a=r(i).then(function(e){n.debug("got result:"+JSON.stringify(e))},function(e){return n.error("Rename device error, server returned:"+JSON.stringify(e)),t.reject(e.data)});return a},restartBaseStation:function(e){var i={method:"POST",url:p.getRestartDeviceUrl(),data:{deviceId:e},headers:{Authorization:d.ssoToken}};n.debug("calling restart base station with config:"+JSON.stringify(i));var a=r(i).then(function(e){return n.debug("got restart base station result: "+JSON.stringify(e)),e.data&&e.data.success?void 0:t.reject(e.data)},function(e){return n.error("Get error, server returned:"+JSON.stringify(e)),t.reject(e.data)});return a}}}]).factory("cameraSettingsService",["$rootScope","$http","$window","$log","$timeout","devicesService","transactionService","baseStationService","userService","utilService","urlService","appProperties","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){return{positionModeActive:{},gettingCameraSettings:null,refreshData:function(){a.getDevices()},getAllCameraSettingsResponseHandler:function(t){if(this.gettingCameraSettings=!1,"is"!==t.action);else{if(!f.checkTransId(t))return;try{_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t&&(t.properties=e)})}catch(r){var i=a.getDeviceById(t.from);s.syncBaseStation(i.deviceId).then(function(){a.getDevices().then(function(){_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t?(n.info("Base station synced with backend"),t.properties=e):n.error("No camera found in list from web server corresponding to device from base station with deviceId: "+e.deviceId)})})})}e.$broadcast(u._RESOURCE_UPDATE_)}},getAllCameraSettings:function(){this.gettingCameraSettings||(n.debug("getting all camera settings"),this.gettingCameraSettings=!0,_.each(_.union(a.getBaseStations(),a.friendedBaseStations),function(e){s.getBaseStationResource(e.deviceId,"cameras")}))},getAllCameraSettingsErrorHandler:function(e){n.debug("Timeout getting camera settings"),this.gettingCameraSettings=!1;var t=e&&e.to;t&&f.checkTransId(e)&&_.each(a.devices,function(e){e&&e.deviceType==u.CAMERA_DEVICE_TYPE&&e.parentId==t&&(e.properties||(e.properties={}),e.properties.connectionState="unavailable")})},updateSettingsResponseHandler:function(t){if("is"!==t.action);else if(t.from)if(t.hasOwnProperty("error"))n.error("got error updating settings:"+JSON.stringify(t.error)),e.$broadcast("show_error",{data:4006==t.error.code?{message:"The camera is busy and can not perform requested action."}:t.error});else{var r="cameras/";if(t.resource.match(/^cameras\//)){var i=a.getDeviceById(t.resource.substring(r.length));for(var o in t.properties)i.properties[o]=t.properties[o];t.properties&&angular.isNumber(t.properties.brightness)&&e.$broadcast(u.appEvents.BRIGHTNESS_UPDATED,i.deviceId)}e.$broadcast(u._RESOURCE_UPDATE_)}else;},getCameraSettings:function(){n.info("Camera came on line, getting camera settings")},getBaseStationCameraSettings:function(e){n.info("Base station came on line, getting all camera settings"),s.getBaseStationResource(e,"cameras",this.getBaseStationCameraSettingsResponseHandler,this.getBaseStationCameraSettingsErrorHandler)},getBaseStationCameraSettingsResponseHandler:function(t){if("is"!==t.action);else{try{_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t&&(t.properties=e)})}catch(r){var i=a.getDeviceById(t.from);s.syncBaseStation(i.deviceId).then(function(){a.getDevices().then(function(){_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t?(n.info("Base station synced with backend"),t.properties=e):n.error("No camera found in list from web server corresponding to device from base station with deviceId: "+e.deviceId)})})})}e.$broadcast(u._RESOURCE_UPDATE_)}},getBaseStationCameraSettingsErrorHandler:function(){},updateSettings:function(e,t,r){n.debug("updating camera settings");var i=s.setSubresource(e,"cameras/"+t,r,this.updateSettingsResponseHandler,this.updateSettingsErrorHandler);return i},updateSettingsErrorHandler:function(){},isPositionMode:function(e){return this.positionModeActive[e]},togglePositionMode:function(e){if(this.isPositionMode(e))i.cancel(this.positionModeActive[e]),this.positionModeActive[e]=null;else{var t=this;this.positionModeActive[e]=i(function(){t.positionModeActive[e]=null},3e5)}},setMotionDetectionMode:function(){var e=$q.defer();return e.promise},setZoom:function(){var e=$q.defer();return e.promise},setInvert:function(){var e=$q.defer();return e.promise},setBrightness:function(){var e=$q.defer();return e.promise}}}]).factory("billingFlowService",["$q","$state","$rootScope","$modal","$log","appProperties","servicePlanService","setupService",function(e,t,r,n,i,a,o,s){return{params:null,inProgress:!1,processBillingEvent:function(t){var r=!0,n=e.defer();this.params=t;var a=this;return this.inProgress=r,this.makePayment().then(function(){return a.params=null,a.inProgress=!1,n.resolve()},function(e){i.debug("Billing error: "+JSON.stringify(e)),a.inProgress=!1;var t;return e&&e.error&&(t={data:e}),e&&e.data&&(t=e),n.reject(t)}),n.promise},makePayment:function(){var t=e.defer(),r=this;return this.handleQuotation().then(function(){o.changePlan(r.params).then(function(){return i.info("payment or refund successful"),t.resolve()},function(e){return i.info("payment or refund FAILED"),t.reject(e.data)})},function(e){return s.setupPending&&(s.servicePlanSelected=null),t.reject(e)}),t.promise},handleQuotation:function(){var t=e.defer(),r=this;return o.getQuotation(this.params).then(function(e){var a=e.html.match(/<\s*style[^>]*>.*?<\s*\/style>/)[0],o=e.html.match(/<\s*body[^>]*>(.*?)<\s*\/body>/)[1],s="partials/confirmPaymentDialog.html";r.params.cancel&&(s="partials/confirmCancelPlanDialog.html");var c=n.open({template:a+o,windowTemplateUrl:s,backdrop:"static"});c.result.then(function(r){return i.info("Quotation confirm closed"),"ok"==r?t.resolve(e):t.reject({cancel:!0})},function(){return r.inProgress=!1,t.reject()})},function(e){return t.reject(e)}),t.promise}}}]).factory("servicePlanService",["$log","$window","$http","$q","$filter","appProperties","urlService","userService","setupService",function(e,t,r,n,i,a,o,s){return{servicePlans:null,freePlanId:null,selectedServicePlan:null,purchasedPlans:null,getOffersPromise:null,billingInfo:null,paymentId:null,coupons:[],isFreePlan:function(e){return e.planType===a.FREE_PLAN_TYPE},isPaidServicePlan:function(e){return e.planType===a.PAID_PLAN_TYPE},isStoragePlan:function(e){return e.planType===a.STORAGE_PLAN_TYPE},getOffers:function(){var t={method:"GET",url:o.getOffersUrl(),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling get service plan offers with config:"+JSON.stringify(t));var a=this,c=r(t).then(function(t){if(1!=t.data.success)return e.warn("Get offers error:"+t.data.data.code+t.data.data.message),a.selectServicePlanError=!0,n.reject(t.data);a.servicePlans=i("orderBy")(t.data.data,["-groupNumber","-amount"]);var r=_.find(a.servicePlans,function(e){return a.isFreePlan(e)});a.freePlanId=r.planId},function(t){return e.error("Get offers error, server returned:"+JSON.stringify(t)),a.selectServicePlanError=!0,n.reject(t.data)});return c},getOffersV1:function(){var t={method:"GET",url:o.getOffersV1Url(),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling get service plan offers with config:"+JSON.stringify(t));var i=this,a=r(t).then(function(t){return 1==t.data.success?t.data:(e.warn("Get offers error:"+t.data.data.code+t.data.data.message),i.selectServicePlanError=!0,n.reject(t.data))},function(t){return e.error("Get offers error, server returned:"+JSON.stringify(t)),i.selectServicePlanError=!0,n.reject(t.data)});return a},getOffersDetails:function(){var t={method:"GET",url:o.getOffersDetailsUrl(),headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("get offers detail with config: "+JSON.stringify(t));var i=r(t).then(function(e){return 1==e.data.success?e.data:n.reject(e.data)},function(t){return e.error("Get offers detail error, server returned: "+JSON.stringify(t)),n.reject(t.data)});return i},getPurchasedPlans:function(){var t={method:"GET",url:o.getServicePlanUrl(),timeout:3e4,headers:{Authorization:s.ssoToken}};e.debug("calling get service plan with config:"+JSON.stringify(t));var i=this,a=r(t).then(function(e){return 1!=e.data.success?n.reject(e.data):void(i.purchasedPlans=e.data.data)},function(t){return e.error("Get service plan error, server returned:"+JSON.stringify(t)),n.reject(t.data)});return a},getServicePlan:function(){if(!this.purchasedPlans)return null;var e=_.filter(this.purchasedPlans,function(e){return e.planType&&(e.planType===a.FREE_PLAN_TYPE||e.planType===a.PAID_PLAN_TYPE)});return 0==e.length?null:e.length>1?_.findWhere(e,{planType:a.PAID_PLAN_TYPE}):e[0]},getStorageServicePlan:function(){if(!this.purchasedPlans)return null;var t=_.filter(this.purchasedPlans,function(e){return e.planType&&e.planType===a.STORAGE_PLAN_TYPE});return 0==t.length?null:t.length>1?(e.warn("More than one storage plan returned from get purchased plans"),_.findWhere(t,{planType:a.STORAGE_PLAN_TYPE})):t[0]},getBilling:function(){var t={method:"GET",url:o.getPaymentBillingUrl(this.paymentId||s.paymentId),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:"","Content-Type":"application/json"}};e.debug("calling get billing with config:"+JSON.stringify(t));var i=this,a=r(t).then(function(t){return 1==t.data.success?(i.billingInfo=t.data.data,t.data.data):(e.warn("server returned error:"+t.data.code+t.data.message),n.reject(t.data))},function(t){return e.error("Get billing error, server returned:"+JSON.stringify(t)),n.reject(t.data)});return a},modifyBilling:function(t){var i={method:"PUT",data:t,url:o.getModifyBillingUrl(this.paymentId||s.paymentId),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:"","Content-Type":"application/json"}};e.debug("calling modify billing with config:"+JSON.stringify(i));var a=r(i).then(function(t){return 1!=t.data.success?(e.warn("server returned error:"+t.data.data.code+t.data.data.message),n.reject(t.data)):(e.info("Successfully modified billing data"),t)},function(t){return e.error("Modify billing error, server returned:"+JSON.stringify(t)),n.reject(t.data)});return a},createAccount:function(t,n){var i={planId:t,modelId:n},a={method:"POST",url:o.getCreatePaymentAccountUrl(),data:i,timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling create free service plan with config:"+JSON.stringify(a));var c=this,d=r(a).then(function(t){return 1==t.data.success?t.data.data:(e.warn("server returned error:"+t.data.code+t.data.message),void(c.createServicePlanError=!0))},function(t){e.error("Create free service plan error, server returned:"+JSON.stringify(t)),c.createServicePlanError=!0});return d},getQuotation:function(t){var i,a={};t.cancel?i=o.getCancelQuotationUrl(this.paymentId||s.paymentId):(t.setupPlan?(a.planIds=[t.setupPlan.planId],t.setupPlan.couponCode&&(a.coupons=[t.setupPlan.couponCode])):a={planIds:t.toPlanId,coupons:this.coupons},i=o.getChangeQuotationUrl(this.paymentId||s.paymentId));var c={method:"POST",url:i,data:a,timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling get quotation with config:"+JSON.stringify(c));var d=this,l=r(c).then(function(t){return 1==t.data.success?t.data.data:(e.warn("server returned error: "+JSON.stringify(t.data)),d.getQuotationError=!0,n.reject(t.data))},function(t){return e.error("Get quotation error, server returned:"+JSON.stringify(t)),d.getQuotationError=!0,n.reject(t.data)});return l},changePlan:function(t){var i,a={};if(t.cancel)i=o.getCancelPlanUrl(this.paymentId||s.paymentId);else{if(t.setupPlan)a.planIds=[t.setupPlan.planId],t.setupPlan.couponCode&&(a.coupons=[t.setupPlan.couponCode]);else{if(!t.toPlanId.length){var c=[];c.push(t.toPlanId),t.toPlanId=c}a={planIds:t.toPlanId,coupons:this.coupons}}i=o.getChangePlanUrl(this.paymentId||s.paymentId)}var d={method:"PUT",url:i,data:a,timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling changePlan with config:"+JSON.stringify(d));var l=this,u=r(d).then(function(t){return 1==t.data.success?t.data.success:(e.warn("server returned error: "+JSON.stringify(t.data)),l.changePlanError=!0,n.reject(t.data))},function(t){return e.error("Change plan error, server returned:"+JSON.stringify(t)),l.changePlanError=!0,n.reject(t.data)});return u},changeRenew:function(t){var i={method:"PUT",data:{autoRenew:t},url:o.getPaymentRenewUrl(this.paymentId||s.paymentId),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:"","Content-Type":"application/json"}};e.debug("calling modify renew with config:"+JSON.stringify(i));var a=r(i).then(function(t){return 1!=t.data.success?(e.warn("Modify renew error, server returned: "+t.data.data.code+t.data.data.message),n.reject(t.data)):(e.info("Successfully modified renew"),t)},function(t){return e.error("Modify renew error, server returned: "+JSON.stringify(t)),n.reject(t.data)});return a}}}]).factory("devicesService",["$rootScope","$http","$log","$window","$q","$filter","$injector","localStorage","appProperties","setupService","urlService","loginService","userService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){return{devices:null,allDevices:[],friendedBaseStations:[],presentDevices:null,lastTimeHash:{},uiStateHash:{},getDevicesPromise:null,initDevicesPromise:null,queryPresentDevices:function(){var e={method:"GET",url:l.getQueryPresentDevicesUrl(),timeout:3e4,headers:{ContentType:"application/json"}};r.debug("calling query present devices with config:"+JSON.stringify(e));var n=this,a=t(e).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.code+e.data.data.message),n.queryPresentDevicesError=!0,i.reject(e.data)):void(n.presentDevices=e.data.data.items)},function(e){return r.error("Query present devices error, server returned:"+JSON.stringify(e)),n.queryPresentDevicesError=!0,i.reject(e.data)});return a},claimDevice:function(e,n,a){var o=angular.copy(a);o.ui&&delete o.ui,d.timeZone&&d.timeZone.ui&&delete d.timeZone.ui;var s={method:"POST",url:l.getClaimDeviceUrl(),data:{xCloudId:e||d.selectedBaseStation._id,deviceId:n||d.selectedBaseStation.hardwareId,timeZone:o||d.timeZone},timeout:3e4,headers:{Authorization:f.ssoToken}};r.debug("calling claim device with config:"+JSON.stringify(s));var c=this,u=t(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.code+e.data.message),c.baseStationClaimError=!0,i.reject(e.data)):(d.baseStationClaimed=!0,c.baseStationClaimError=!1,f.paymentId||f.setPaymentId(e.data.data.paymentId),void 0)},function(e){return r.error("Claim base station error, server returned:"+JSON.stringify(e)),c.baseStationClaimError=!0,i.reject(e.data)});return u},getDevices:function(n){if(this.getDevicesPromise)return this.getDevicesPromise;var a={method:"GET",url:l.getDevicesUrl()+"?t="+(new Date).getTime().toString(),timeout:35e3,headers:{Authorization:f.ssoToken}};r.debug("getting devices, config:"+JSON.stringify(a));var o=this;return this.getDevicesPromise=t(a).then(function(t){return o.getDevicesPromise=null,t.data&&t.data.success?(o.parseGetDevicesResponse(t.data,n),void o.extractFriendedBaseStations()):(r.error("get devices error, server returned: "+JSON.stringify(t.data)),t&&t.data&&t.data.data.message&&e.$broadcast("show_error",t.data),i.reject(t.data))},function(e){return r.error("get devices error, server returned: "+JSON.stringify(e.data)),o.getDevicesPromise=null,i.reject(e.data)}),this.getDevicesPromise},initDevices:function(e){if(this.devices)return i.when(1);if(this.initDevicesPromise)return this.initDevicesPromise;var t=this;return this.initDevicesPromise=this.getDevices(e).then(function(){o.get("gatewayPollingService").start()})["finally"](function(){t.initDevicesPromise=null}),this.initDevicesPromise},getBaseStations:function(){return _.filter(this.devices,function(e){return e.deviceType==c.BASE_STATION_DEVICE_TYPE&&(e.state==c.PROVISIONED_STATE||e.state==c.SYNCED_STATE)})},getBaseStationById:function(e){return _.findWhere(this.devices,{deviceId:e})},extractFriendedBaseStations:function(){var e=this,t=_.reduce(this.devices,function(t,r){return!r.parentId||_.findWhere(e.devices,{deviceId:r.parentId})||_.contains(t,r.parentId)||t.push(r.parentId),t},[]);this.friendedBaseStations=_.map(t,function(e){return{deviceId:e,properties:{}}})},hasOwnDevices:function(){return _.some(this.devices,function(e){return e.userId===e.owner.ownerId})},isPureUser:function(){return _.every(this.devices,function(e){return"USER"===e.userRole})},updateLastDate:function(e){var r={method:"GET",url:e.presignedLastImageUrl,timeout:3e4},n=this;t(r).then(function(t){t.headers("Last-Modified")&&(n.lastTimeHash[e.deviceId]=new Date(t.headers("Last-Modified")).getTime())},function(){n.lastTimeHash[e.deviceId]=e.lastModified})},getDevice:function(e){var n={method:"GET",url:l.getDevicesUrl(e),timeout:5e3,headers:{Authorization:f.ssoToken}};r.debug("getting device, config:"+JSON.stringify(n));var i=this,a=t(n).then(function(e){i.parseGetDeviceResponse(e.data)},function(e){r.error("get device error, server returned:"+JSON.stringify(e.data))});return a},getBaseStationDevices:function(e){return _.filter(this.devices,function(t){return t.parentId==e})},parseGetDevicesResponse:function(e,t){if(1==e.success){if(e.data.length&&_.each(e.data,function(e){e&&!e.properties&&(e.properties={}),e&&e.properties&&"basestation"==e.deviceType&&(delete e.properties.updateAvailable,delete e.properties.timeZone,delete e.properties.olsonTimeZone)}),e.data.length<this.allDevices.length&&(this.allDevices=_.filter(this.allDevices,function(t){return _.findWhere(e.data,{deviceId:t.deviceId})})),_.each(e.data,function(e){if("basestation"==e.deviceType&&e.state==c.DEACTIVATED_STATE){var t=_.findWhere(this.allDevices,{deviceId:e.deviceId});return void(t&&(t.state=c.DEACTIVATED_STATE))}var r=_.findWhere(this.allDevices,{deviceId:e.deviceId});if(r)for(var n in e)"properties"==n?(delete e[n].olsonTimeZone,angular.extend(r[n],e[n])):e.hasOwnProperty(n)&&(r[n]=e[n]);else this.allDevices.push(e)},this),this.devices=a("orderBy")(_.filter(this.allDevices,function(e){return e.state!=c.REMOVED_STATE&&e.state!=c.DEACTIVATED_STATE}),"displayOrder"),this.devices&&this.devices.length)for(var n=0;n<this.devices.length;++n)"camera"===this.devices[n].deviceType&&(this.uiStateHash[this.devices[n].deviceId]={play:!1,record:!1,micLevel:0,showBright:!1},t&&this.updateLastDate(this.devices[n]));r.debug("got devices:"+JSON.stringify(e))}else r.warn("Error:"+e.code+", "+e.message)},parseGetDeviceResponse:function(t){if(1==t.success){var n=this.getDeviceById(t.data.deviceId);if(n)for(var i in t.data)"properties"==i?angular.extend(n[i],t.data[i]):t.data.hasOwnProperty(i)&&(n[i]=t.data[i]);else r.warn("adding device which was not present!"),"camera"===t.data.deviceType&&(this.uiStateHash[t.data.deviceId]={play:!1,record:!1,micLevel:0,showBright:!1}),this.devices.push(t.data);
this.updateLastDate(n||this.getDeviceById(t.data.deviceId)),r.debug("got device:"+JSON.stringify(t))}else r.warn("Error: "+t.data.code+", "+t.data.message),e.$broadcast("show_error",t)},getAllCameras:function(){return this.devices?_.where(this.devices,{deviceType:c.CAMERA_DEVICE_TYPE,state:c.PROVISIONED_STATE}):[]},getOwnCameras:function(){return _.filter(this.devices,function(e){return e.deviceType==c.CAMERA_DEVICE_TYPE&&e.userId===e.owner.ownerId})},getAllCameraIds:function(){var e=[];if(this.allDevices)for(var t=0;t<this.allDevices.length;t++)this.allDevices[t].deviceType==c.CAMERA_DEVICE_TYPE&&e.push(this.allDevices[t].deviceId);return e},getDeviceName:function(e){var t=this.getDeviceById(e);return t?t.deviceName:""},findByParentId:function(e){return _.where(this.devices,{parentId:e})},getDeviceById:function(e){return _.findWhere(this.allDevices,{deviceId:e})},getCameraById:function(e){return _.findWhere(this.allDevices,{deviceId:e,deviceType:c.CAMERA_DEVICE_TYPE})},getCameraOwner:function(e){for(var t=!1,r=0,n=null;!t&&r<this.allDevices.length;)this.allDevices[r].deviceId==e?(n=this.allDevices[r].userId,t=!0):r++;return n},loadSessionData:function(){},clearSessionData:function(){this.devices=null,this.allDevices=[],this.friendedBaseStations=[]}}}]).factory("calendarService",["$state","appProperties","metadataService","libraryService","userService","localStorage","devicesService",function(e,t,r,n,i,a,o){return{month:null,calendarVals:null,weeks:null,setDefaultMonth:function(){var e=new Date,t=e.getMonth()+1,r=e.getFullYear();this.month=10>t?r.toString()+"0"+t.toString():r.toString()+t.toString(),this.persistMonth()},decrementMonth:function(){var e=new Number(this.month.substring(4))-1;if(0>=e){var t=new Number(this.month.substring(0,4))-1;this.month=t.toString()+"12"}else this.month=10>e?this.month.substring(0,4)+"0"+e.toString():this.month.substring(0,4)+e.toString()},incrementMonth:function(){var e=new Number(this.month.substring(4))+1;if(e>12){var t=new Number(this.month.substring(0,4))+1;this.month=t.toString()+"01"}else this.month=10>e?this.month.substring(0,4)+"0"+e.toString():this.month.substring(0,4)+e.toString()},getFromDate:function(e){var t=new Date(0);return e&&"string"==typeof e&&6===e.length&&(t.setUTCFullYear(new Number(e.substring(0,4))),t.setUTCMonth(new Number(e.substring(4,6))-1)),t.setUTCDate(1),t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0),t.getTime()+60*t.getTimezoneOffset()*1e3},getToDate:function(e){var t=new Date(0);return e&&"string"==typeof e&&6===e.length&&(t.setUTCFullYear(new Number(e.substring(0,4))),t.setUTCMonth(new Number(e.substring(4,6))-1),t.setUTCDate(this.getLastDayOfMonth(e))),t.setUTCHours(23),t.setUTCMinutes(59),t.setUTCSeconds(59),t.setUTCMilliseconds(999),t.getTime()+60*t.getTimezoneOffset()*1e3},getFirstDateOfMonth:function(e){e=null==e?this.month:e;var t=new Date(0);t.setUTCMonth(e.substring(4)-1),t.setUTCFullYear(e.substring(0,4));var r=new Date(t.getTime()+1e4);return r},refreshData:function(){if(i.ssoToken){var e=this,t=r.getMetadata(this.getStartOfMonthDateString(this.month),this.getEndOfMonthDateString(this.month));return t.then(function(){e.setCalendarVals(),e.setWeeks()}),t}this.setCalendarVals(),this.setWeeks()},getFirst:function(){if(i.ssoToken){var e=this,t=r.getFirstMetadata();return t.then(function(){var t=_.sample(_.keys(r.metadata));t&&8==t.length&&(e.month=t.substring(0,6)),e.setCalendarVals(),e.setWeeks()}),t}this.setCalendarVals(),this.setWeeks()},getStartOfMonthDateString:function(e){return e+"01"},getEndOfMonthDateString:function(e){return e+this.getLastDayOfMonth(e)},setCalendarVals:function(){for(var e=[],t=this.getLastDayOfMonth(this.month),r=this.getFirstDateOfMonth(),n=1;t>=n;n++){var i={dayOfMonth:n,dayOfWeek:r.getUTCDay(),numLibraryRecordings:this.getNumRecordingsOnDay(this.month+(10>n?"0"+n:n))};this.getNumRecordingsOnDay(this.month+(10>n?"0"+n:n))&&(this.lastRecordingDay=this.getDayDate(n)),e.push(i),r.setTime(r.getTime()+864e5)}this.calendarVals=e,this.persistCalendarVals()},getMostRecentRecordingsDay:function(){for(var e=(this.getLastDayOfMonth(this.month),this.getLastDayOfMonth(this.month)+1);--e;)if(this.getNumRecordingsOnDay(this.getDayDate(e)))return e;return e+1},getFirstRecordingsDay:function(){var e=1;do{var t=this.month+(10>e?"0"+e:e.toString());if(this.getNumRecordingsOnDay(t))return t;e++}while(32!=e);return this.month+"01"},getDayDate:function(e){return 10>e?this.month+"0"+e.toString():this.month+e.toString()},setWeeks:function(){for(var e=[],t=!1,r=!1,n=1,i=this.calendarVals.length;!r;){for(var a=[],o=0;7>o;o++)r||this.calendarVals[n-1].dayOfWeek!=o?a.push({dayOfMonth:null,dayOfWeek:o,numLibraryRecordings:null}):(a.push(this.calendarVals[n-1]),t=!0),t&&n++,n>i&&(r=!0);e.push(a)}this.weeks=e,this.persistWeeks()},getLastDayOfMonth:function(e){var t=0;switch(Number(e.substring(4))-1){case 1:t=Number(e.substring(0,4))%4==0?29:28;break;case 3:case 5:case 8:case 10:t=30;break;default:t=31}return t},getNumRecordingsOnDay:function(e){var t;if(null!=r.metadata&&(t=0,r.metadata[e]))for(var i in r.metadata[e])_.findWhere(n.selectedCameras,{deviceId:i})&&r.metadata[e].hasOwnProperty(i)&&(t+="all"==n.favorites.value?r.metadata[e][i].favorite+r.metadata[e][i].nonFavorite:"only"==n.favorites.value?r.metadata[e][i].favorite:r.metadata[e][i].nonFavorite);return t},persistMonth:function(){a.setItem("month",this.month)},persistCalendarVals:function(){a.setItem("calendarVals",JSON.stringify(this.calendarVals))},persistWeeks:function(){a.setItem("weeks",JSON.stringify(this.weeks))},loadSessionData:function(){a.month&&(this.month=a.month),a.calendarVals&&(this.calendarVals=JSON.parse(a.calendarVals)),a.weeks&&(this.weeks=JSON.parse(a.weeks))},clearSessionData:function(){this.month=null,this.calendarVals=null,this.weeks=null,a.month&&a.removeItem("month"),a.calendarVals&&a.removeItem("calendarVals"),a.weeks&&a.removeItem("weeks")},createStateParams:function(){this.setDefaultMonth(),this.stateParams={month:this.month,day:this.getDayDate((new Date).getDate()),favorites:t.favoritesOptions[0].value,cameraIds:o.getAllCameraIds().join(",")}},gotoCalendarView:function(){this.stateParams||this.createStateParams(),e.go("calendar.day",this.stateParams)}}}]).factory("metadataService",["$http","$log","$window","urlService","localStorage","userService","dayService",function(e,t,r,n,i,a){return{metadata:null,getMetadata:function(r,i){var o={dateFrom:r,dateTo:i},s={method:"post",url:n.getMetadataUrl(),data:o,timeout:5e3,headers:{Authorization:a.ssoToken}},c=this;t.debug("config:"+JSON.stringify(s));var d=e(s).then(function(e){1==e.data.success?(t.debug("got metadata:"+JSON.stringify(e.data.data)),c.metadata=e.data.data.meta,c.persistMetadata()):t.warn("metadata query success false")},function(e){t.error("on error, the server returned:"+e.data)});return d},getFirstMetadata:function(r){var i={method:"get",url:n.getMetadataUrl(),timeout:5e3,headers:{Authorization:a.ssoToken,ContentType:"application/json"}},o=this;t.debug("config:"+JSON.stringify(i));var s=e(i).then(function(e){if(1==e.data.success){if(t.debug("got metadata:"+JSON.stringify(e.data.data)),r)return e.data.data.dateFrom;o.metadata=e.data.data.meta,o.persistMetadata()}else t.warn("metadata query success false")},function(e){t.error("on error, the server returned:"+e.data)});return s},persistMetadata:function(){i.setItem("metadata",JSON.stringify(this.metadata))},loadSessionData:function(){i.metadata&&(this.metadata=JSON.parse(i.metadata))},clearSessionData:function(){this.metadata=null,i.metadata&&i.removeItem("metadata")}}}]).factory("libraryService",["$window","devicesService","appProperties","localStorage",function(e,t,r,n){return{favorites:null,cameras:null,selectedCameras:[],setFavorites:function(e){if(e){if("string"==typeof e)for(var t=0;t<r.favoritesOptions.length;t++)r.favoritesOptions[t].value==e&&(this.favorites=r.favoritesOptions[t]);else this.favorites=e;"string"==typeof e&&"undefined"==typeof this.favorites&&(this.favorites=r.favoritesOptions[0]),this.persistFavorites()}},initialize:function(){this.favorites=r.favoritesOptions[0];var e=t.getAllCameraIds();this.setCameras(e),this.setSelectedCamerasFromIds(e)},setCameras:function(e){this.cameras=[];for(var r=0;r<e.length;r++)this.cameras.push({deviceId:e[r],cameraName:t.getDeviceName(e[r]),ownerId:t.getCameraOwner(e[r])});this.persistCameras()},setSelectedCameras:function(e){this.selectedCameras=e,this.persistSelectedCameras()},setSelectedCamerasFromIds:function(e){for(var n=[],i=_.where(t.allDevices,{deviceType:r.CAMERA_DEVICE_TYPE}),a=0;a<e.length;a++)for(var o=0;o<i.length;o++)i[o].deviceId==e[a]&&n.push(i[o]);this.selectedCameras=n,this.persistSelectedCameras()},getSelectedCameraIds:function(){for(var e=[],t=0;t<this.selectedCameras.length;t++)e.push(this.selectedCameras[t].deviceId);return e.join(",")},persistFavorites:function(){n.setItem("favorites",JSON.stringify(this.favorites))},persistCameras:function(){n.setItem("cameras",JSON.stringify(this.cameras))},persistSelectedCameras:function(){n.setItem("selectedCameras",JSON.stringify(this.selectedCameras))},loadSessionData:function(){n.favorites&&(this.favorites=JSON.parse(n.favorites)),n.cameras&&(this.cameras=JSON.parse(n.cameras)),n.selectedCameras&&(this.selectedCameras=JSON.parse(n.selectedCameras))},clearSessionData:function(){this.favorites=null,this.cameras=null,this.selectedCameras=null,n.favorites&&n.removeItem("favorites"),n.cameras&&n.removeItem("cameras"),n.selectedCameras&&n.removeItem("selectedCameras")}}}]).factory("dayService",["$filter","userService","libraryService","recordingsService","localStorage",function(e,t,r,n,i){return{day:null,millisecondsInDay:864e5,setDefaultDay:function(e){var t=new Date,r=t.getDate();this.setDay(e+(10>r?"0"+r:r)),this.persistDay()},setDay:function(e){this.day=e,this.persistDay()},getToday:function(){return e("date")(new Date,"yyyyMMdd")},dateGreaterThan:function(e,t){return e>t},decrementDay:function(){var e=new Number(this.day.substring(6))-1;if(0>=e){var t=new Number(this.day.substring(4,6))-1,r=new Number(this.day.substring(0,4));if(0>=t){r--,t=12;var n=r.toString()+t.toString();e=this.getLastDayOfMonth(n),this.day=n+e.toString()}else if(10>t){var n=r.toString()+"0"+t.toString();e=this.getLastDayOfMonth(n),this.day=n+e.toString()}else{var n=r.toString()+t.toString();e=this.getLastDayOfMonth(n),this.day=n+e.toString()}}else this.day=10>e?this.day.substring(0,6)+"0"+e.toString():this.day.substring(0,6)+e.toString();this.persistDay()},incrementDay:function(){var e=new Number(this.day.substring(6))+1,t=this.getLastDayOfMonth(this.day.substring(0,6));if(e>t){var r=new Number(this.day.substring(4,6))+1,n=new Number(this.day.substring(0,4));r>12?(n++,this.day=n.toString()+"0101"):this.day=10>r?n.toString()+"0"+r.toString()+"01":n.toString()+r.toString()+"01"}else this.day=10>e?this.day.substring(0,6)+"0"+e.toString():this.day.substring(0,6)+e.toString();this.persistDay()},refreshData:function(){if(t.ssoToken){var e=n.getRecordings(this.day,this.day);return e.then(function(){}),e}},persistDay:function(){i.setItem("day",this.day)},getLastDayOfMonth:function(e){var t=0;switch(Number(e.substring(4))-1){case 1:t=Number(e.substring(0,4))%4==0?29:28;break;case 3:case 5:case 8:case 10:t=30;break;default:t=31}return t},loadSessionData:function(){i.day&&(this.day=i.day)},clearSessionData:function(){this.day=null,i.day&&i.removeItem("day")}}}]).factory("recordingsService",["$http","$q","$log","$window","$filter","$injector","$rootScope","appProperties","libraryService","urlService","localStorage","baseStationService","userService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){return{recordings:null,recycled:null,current:null,libraryState:null,getLibraryState:function(){var n={method:"GET",url:d.getLibraryStateUrl(),timeout:3e4,data:"",headers:{Authorization:f.ssoToken,"Content-Type":"application/json; charset=UTF-8"}},i=this;i.recycled=[],r.debug("getting library info: "+JSON.stringify(n));var a=e(n).then(function(e){return 1!=e.data.success?(r.warn("library info query success false"),t.reject(e.data)):(r.debug("got library info: "+JSON.stringify(e.data.data)),void(i.libraryState=e.data.data))},function(e){return r.error("on error, the server returned:"+e.data.message),t.reject(e.data)});return a},getRecordings:function(t,n){var a={dateFrom:t,dateTo:n},o={method:"POST",url:d.getRecordingsUrl(),data:a,timeout:3e4,headers:{Authorization:f.ssoToken}},s=this;s.recordings=[],r.debug("getting recordings, data:"+JSON.stringify(a));var c=e(o).then(function(e){1==e.data.success?(r.debug("got recordings:"+JSON.stringify(e.data.data)),s.recordings=_.sortBy(e.data.data,function(e){return-i("toBSTime")(e.utcCreatedDate,e.timeZone)}),s.persistRecordings()):r.warn("recordings query success false")},function(e){r.error("on error, the server returned:"+e.data.message)});return c},getRecycleRecordings:function(){var n={method:"GET",url:d.getRecycleUrl(),timeout:55e3,headers:{Authorization:f.ssoToken}},i=this;i.recycled=[],r.debug("getting recordings, data:"+JSON.stringify(n));var a=e(n).then(function(e){return 1!=e.data.success?(r.warn("recordings query success false"),o.$broadcast("show_error",{data:{message:"Request for recycled recordings failed!"}}),t.reject(e.data)):(r.debug("got recordings:"+JSON.stringify(e.data.data)),i.recycled=e.data.data,angular.forEach(i.recycled,function(e,t){i.recycled[t].recordingNumber=t}),void 0)},function(e){return r.error("Failed request getRecycleRecordings"),o.$broadcast("show_error",{data:{message:"Request for recycled recordings failed!"}}),t.reject(e.data)});return a},createFavoriteObject:function(){var e={};return e.utcCreatedDate=null,e.createdDate=null,e.deviceId=null,e},favoriteRecordings:function(n,i){for(var a=[],o=0;o<n.length;o++)if(angular.isDefined(n[o])){var s=this.createFavoriteObject();s.createdDate=i[o].createdDate,s.deviceId=i[o].deviceId,s.utcCreatedDate=i[o].utcCreatedDate,a.push(s)}var c={};c.data=a;var l={method:"POST",url:d.getFavoriteUrl(),data:c,timeout:3e4,headers:{Authorization:f.ssoToken}};r.debug("setting favorites, sending data:"+JSON.stringify(l));var u=e(l).then(function(e){1==e.data.success?r.debug("favorites set successfully"):r.warn("favorites not sent")},function(e){return r.error("Server failure:"+e.data),t.reject(e.data)});return u},recycleRecordings:function(n){var i=[];angular.forEach(n,function(e){if(e.selected&&!this.isFavorite(e)){var t={createdDate:e.createdDate,deviceId:e.deviceId,utcCreatedDate:e.utcCreatedDate};i.push(t)}},this);var a={method:"POST",url:d.getRecycleUrl(),data:{data:i},headers:{Authorization:f.ssoToken}};r.debug("setting recycle, sending data:"+JSON.stringify(a));var o=e(a).then(function(e){return 1!=e.data.success?(r.warn("recycle operation not sent"),t.reject(e.data)):void r.debug("recycle settings successful")},function(e){return r.error("Server failure:"+e.data),t.reject(e.data)});return o},shareRecordings:function(){var n=[];this.selectMode?_.each(this.recordings,function(e){e.selected&&n.push({deviceId:e.deviceId,utcCreatedDate:e.utcCreatedDate,createdDate:e.createdDate,timeZone:e.timeZone,mediaDuration:e.mediaDuration,name:e.name,contentType:e.contentType})}):n.push({deviceId:this.current.deviceId,utcCreatedDate:this.current.utcCreatedDate,createdDate:this.current.createdDate,timeZone:this.current.timeZone,mediaDuration:this.current.mediaDuration,name:this.current.name,contentType:this.current.contentType});var i={method:"POST",url:d.getShareUrl(),data:{sharedMediaList:n},headers:{Authorization:f.ssoToken}};r.debug("setting share, sending data:"+JSON.stringify(i));var a=e(i).then(function(e){return 1==e.data.success?(r.debug("share settings successful"),e.data):(r.warn("share operation not sent"),t.reject(e.data))},function(e){return r.error("Server failure: "+e.data),t.reject(e.data)});return a},getSharedRecordings:function(n){var i={method:"GET",url:d.getShareUrl()+"/"+n,headers:{Authorization:f.ssoToken||""}};r.debug("setting share, sending data:"+JSON.stringify(i));var a=e(i).then(function(e){return 1==e.data.success?(r.debug("share settings successful"),e.data):(r.warn("share operation not sent"),t.reject(e.data))},function(e){return r.error("Server failure: "+e.data),t.reject(e.data)});return a},restoreRecordings:function(n){var i=[];angular.forEach(n,function(e){if(e.selected){var t={createdDate:e.createdDate,deviceId:e.deviceId,utcCreatedDate:e.utcCreatedDate};i.push(t)}});var a={method:"PUT",url:d.getRecycleUrl(),data:{data:i},headers:{Authorization:f.ssoToken}};r.debug("restore recycled, sending data:"+JSON.stringify(a));var o=e(a).then(function(e){return 1!=e.data.success?(r.warn("restore recycled operation not sent"),t.reject(e.data)):void r.debug("restore recycled successful")},function(e){return r.error("Server failure:"+e.data),t.reject(e.data)});return o},deleteAllRecordings:function(){var n={method:"DELETE",url:d.getRecycleAllUrl(),data:"",headers:{Authorization:f.ssoToken,"Content-Type":"application/json; charset=UTF-8"}};r.debug("delete all recordings, sending data:"+JSON.stringify(n));var i=e(n).then(function(e){1==e.data.success?r.debug("recycle all successful"):r.warn("recycle all operation not sent")},function(e){return r.error("Server failure:"+e.data),t.reject(e.data)});return i},getNextContent:function(e){var t=!1,r=e,n=null,i=a.get("calendarService").stateParams;for(i&&(i=i.cameraIds.split(","));e<this.recordings.length-1&&!t;)e++,n=this.recordings[e],n.recycle||"only"==c.favorites.value&&!this.isFavorite(n)||"non"==c.favorites.value&&this.isFavorite(n)||i&&-1==_.indexOf(i,n.deviceId)||(t=!0);return t?n:this.recordings[r]},getPreviousContent:function(e){var t=!1,r=e,n=null,i=a.get("calendarService").stateParams;for(i&&(i=i.cameraIds.split(","));e>0&&!t;)e--,n=this.recordings[e],n.recycle||"only"==c.favorites.value&&!this.isFavorite(n)||"non"==c.favorites.value&&this.isFavorite(n)||i&&-1==_.indexOf(i,n.deviceId)||(t=!0);return t?n:this.recordings[r]},persistRecordings:function(){for(var e=0;e<this.recordings.length;e++)this.recordings[e].recordingNumber=e;l.setItem("recordings",JSON.stringify(this.recordings))},loadSessionData:function(){l.recordings&&(this.recordings=JSON.parse(l.recordings))},clearSessionData:function(){this.recordings=null,this.selectMode=!1,l.recordings&&l.removeItem("recordings")},setCurrent:function(e){this.current=e},isFavorite:function(e){return e&&e.currentState==s.FAVORITE_STATE},toggleFavorite:function(e){return e.currentState=e.currentState==s.FAVORITE_STATE?s.NEW_STATE:s.FAVORITE_STATE,e}}}]).factory("uiService",["$rootScope","$modal","$state","userService",function(e,t,r,n){return{scope:e.$new(!0),info:function(e){this.scope.infoMessage=e;var r=t.open({templateUrl:"partials/infoDialog.html",backdrop:!0,scope:this.scope});return r.result},processBSUpdate:function(e){if(!this.scope.bs&&!n.ignoreUpdates&&"OWNER"==e.userRole&&e.properties&&e.properties.updateAvailable&&!e.properties.autoUpdateEnabled){this.scope.notifiedBS||(this.scope.notifiedBS=[]);var i=e.deviceId+e.properties.updateAvailable.version;if(-1!=this.scope.notifiedBS.indexOf(i))return;this.scope.bs=e,this.scope.notifiedBS.push(i);var a=this;this.scope.remindChanged||(this.scope.remindChanged=this.remindChanged),this.scope.remindUpdate=!0;var o=t.open({templateUrl:"partials/confirmBSUpgradeDialog.html",backdrop:"static",scope:this.scope});o.result.then(function(){r.go("settings.baseStationUpdate",{deviceId:e.deviceId})})["finally"](function(){a.scope.bs=null})}},remindChanged:function(){n.setIgnoreUpdates(!this.remindUpdate)}}}]).factory("offlineService",["$rootScope","$http","$timeout","$state","$filter","$injector",function(e,t,r,n,i,a){return{isOffline:!1,startTime:(new Date).getTime(),init:function(){this.startTime=(new Date).getTime()},checkOffline:function(){var o="img2/drag_header.png?t="+(new Date).getTime(),s=this;this.promise||(this.promise=t({method:"GET",url:o,timeout:3e4}).then(function(){s.isOffline=!1},function(){s.isOffline=!0,a.get("userService").setFromLogout(),a.get("logoutService").logout(!0).then(function(){n.go("login")}),r(function(){e.$broadcast("show_error",{data:{message:i("i18n")("error_no_internet_connection")}})},500)}).finally(function(){s.promise=null}))},checkTransId:function(e){if(this.startTime){if("mediaUploadNotification"==e.resource||"diagnostics"==e.resource)return!0;var t=e.transId&&e.transId.split("!"),r=t&&parseInt(t[2],10);return r>this.startTime}return!1}}}]),angular.module("arloApp.controllers",[]).controller("LoginCtrl",["$scope","$rootScope","$location","$log","$state","$timeout","$modal","$q","appProperties","loginService","logoutService","setupService","devicesService","userService","urlService","cameraSettingsService","baseStationService","gatewayPollingService","pushHandlerService","libraryService","calendarService","dayService","servicePlanService","appStateService","localStorage","utilService","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v,m,h,S,y,I,E,T,b,A,C,_){e.init=function(){if(n.debug("Initializing login view"),e.isFriendUser()||e.resettingPassword()||!C.checkMobile()){if(g.isLoggedIn())return void i.go("cameras");g.settings&&(e.userId=g.userName,e.rememberMe=!0,g.fromLogout?e.password=g.getSettings():e.attemptLogin(!0)),u.setupPending=!0,d.redirectError&&a(function(){t.$broadcast(c.appEvents.SHOW_ERROR,{data:{message:d.redirectError}}),d.redirectError=null})}},e.attemptLogin=function(r){if(!C.checkMobile()&&(e.loginError=null,e.userId&&e.password||r)){e.inProgress=!0,e.rememberMe||g.clearSettings();var n;if(e.isFriendUser()){var a=R().split("=")[1],l=a.search("#");l>-1&&(a=a.substr(0,l)),l=a.search("/"),l>-1&&(a=a.substr(0,l)),n=d.checkCredentials(e.userId,e.password,a)}else n=d.checkCredentials(e.userId,r?g.getSettings():e.password);n.then(function(n){if(g.isLoggedIn()){t.$broadcast(c.appEvents.HIDE_ERROR,null),e.inProgress=!0,e.viewMode=!1;var a,l=n.data.accountStatus;if(n.data.tocUpdate&&n.data.policyUpdate)a=o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.tocLink,scope:e,backdrop:"static"}).result.then(function(t){return"ok"==t?d.updateTosVersion(n.data.tocVersion).then(function(){return o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.policyLink,scope:e,backdrop:"static"}).result.then(function(e){return"ok"==e?d.updatePolicyVersion(n.data.policyVersion):s.reject()})},function(){return s.reject()}):s.reject()});else if(n.data.policyUpdate)a=o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.policyLink,scope:e,backdrop:"static"}).result.then(function(e){return"ok"==e?d.updatePolicyVersion(n.data.policyVersion):s.reject()});else if(n.data.tocUpdate)a=o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.tocLink,scope:e,backdrop:"static"}).result.then(function(e){return"ok"==e?d.updateTosVersion(n.data.tocVersion):s.reject()});else{var f=s.defer();a=f.promise,f.resolve()}a.then(function(){g.clearFromLogout(),u.setupPending=!1,e.rememberMe&&!r&&g.setSettings(e.password),_.init(),S.init(),i.go("verifyBilling"==l?"settings.billingInformation":"cameras")},function(e){g.setSsoToken(""),e&&t.$broadcast(c.appEvents.SHOW_ERROR,e)})["finally"](function(){e.inProgress=!1})}},function(t){e.inProgress=!1,e.loginError=t&&t.data&&t.data.message?t.data.message:$filter("i18n")("login_error_validation_username")})}},e.systemSetup=function(){b.clearSessionData();var e;if(u.start(),u.setupPending)if(u.baseStationClaimed){if(u.accountRegistered)throw"Unknown system setup state";e="accountRegistration"}else e="gettingStarted";else e="cameras";u.updateSetupState(),i.go(e)},e.createAccount=function(){var e=c.accountRegistrationRoute;r.path(e)},e.resetPassword=function(){var t=r.absUrl(),n=t.match(new RegExp("/[?&]"+c.resetPasswordTokenText+"([^&#]*)?[/#]","i")),i=n&&n[1]?n[1]:null,a=d.resetPassword(e.newPassword,i);a.then(function(){location.href=r.protocol()+"://"+r.host()+(r.port()?":"+r.port():"")})},e.isFriendUser=function(){var e=r.absUrl(),t=e.toLowerCase().indexOf(c.registerTokenText);return 0>t?!1:!0},e.isSystemSetup=function(){return A.isSetup};var R=function(){var e=r.absUrl().toLowerCase(),t=e.indexOf(c.registerTokenText);return 0>t?"":e.substr(t)};e.resettingPassword=function(){var e=r.absUrl().toLowerCase(),t=e.indexOf(c.resetPasswordTokenText);return 0>t?!1:!0},e.gotoLogin=function(){location.href=r.protocol()+"://"+r.host()+(r.port()?":"+r.port():"")}}]).controller("PasswordHelpCtrl",["$scope","loginService",function(e,t){e.submit=function(){e.inProgress=!0,e.error=null;var r=t.requestPasswordReset(e.email);r.then(function(){e.inProgress=!1,e.sent=!0},function(t){e.error=t.data.message})}}]).controller("CamerasCtrl",["$scope","$rootScope","$state","$stateParams","$log","$timeout","$q","$filter","appProperties","pushHandlerService","devicesService","camerasService","dayService","libraryService","calendarService","deviceEventsChannel","cameraSettingsService","servicePlanService","baseStationService","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v,m,h,S,y){function I(){var t=s("i18n")("marketing_how_to_sync_camera_content"),r=t.split("\n");e.syncSteps=[],_.each(r,function(t){t&&e.syncSteps.push(0==t.indexOf("o ")?t.substr(2):t)})}var E={},T={};e.sliderClick=function(t,r){var n=100*(t.layerX-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setPercent(n,r)},e.setPercent=function(t,r){e.uiStates[r].brightness=Math.round(t/25)-2},e.showBrightness=function(t){angular.extend(e.uiStates[t.deviceId],{brightnessUpdating:!1,brightness:t.properties.brightness,showBright:!0})},e.getCameras=function(){return l.getAllCameras()},e.getCamera=function(){return l.getDeviceById(e.deviceId)},e.getSyncedCameras=function(){var e=_.findWhere(l.devices,{deviceType:c.CAMERA_DEVICE_TYPE,state:c.SYNCED_STATE});return e?[e]:[]},e.getCameraState=function(t){return e.isCameraConnecting(t)?"connecting":"upgradeInProgress"==t.properties.activityState?"upgrade":t.properties.connectionState==c.UNAVAILABLE_STATE?"offline":t.properties.connectionState==c.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL?"critical":e.startErrors[t.deviceId]?"start_error":e.uiStates[t.deviceId].loading?"loading":e.startErrors[t.deviceId]||e.stopTimeouts[t.deviceId]||!e.devicesLoaded||e.uiStates[t.deviceId].play||-1==_.indexOf([c.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE,c.CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM,c.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM,c.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE,c.CAMERA_ACTIVITYSTATE_ALERT_WATCH],t.properties.activityState)?null:t.properties.hasStreamed?"idle":"idle_new"},e.getOfflineMessage=function(e){if(y.isOffline)return s("i18n")("error_no_internet_connection");var t=l.getDeviceById(e.parentId)||_.findWhere(l.friendedBaseStations,{deviceId:e.parentId});if(t&&t.properties&&t.properties.connectionState){if(t.properties.connectionState==c.UNAVAILABLE_STATE)return s("i18n")("camera_state_gateway_offline");if(e.properties&&e.properties.connectionState==c.UNAVAILABLE_STATE)return s("i18n")("camera_state_offline")}return""};var b=function(){if(null!=navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"]&&!0;if(~navigator.userAgent.toLowerCase().indexOf("webtv"))return!0;if(~navigator.appVersion.indexOf("MSIE")&&!~navigator.userAgent.indexOf("Opera"))try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")&&!0}catch(e){}return!1};e.init=function(){if(i.debug("initializing cameras controller"),-1!=window.location.href.toLowerCase().indexOf(c.registerTokenText))return void(window.location.href="/#/cameras");if(e.scrollable=!1,e.isOfferShown=!1,e.stopTimeouts={},e.startErrors={},e.deviceId=n.deviceId||null,e.deviceId&&(e.positionMode=!0,!l.devices))return void r.go("settings");if(e.offChangeStart=t.$on("$stateChangeStart",function(t,n,i,o){if(e.offChangeStart(),o.name==r.current.name){e.go=!0,a.cancel(e.positionTimeout);for(var s in e.uiStates){var c=e.uiStates[s];c.play&&e.stopPlay(s),c.loading&&(c.loading=!1)}}}),!e.deviceId){e.devicesLoaded=!1;var o=l.initDevices();if(o.then(function(){v.onEventData(e,A),_.each(e.getCameras(),function(t){e.lastTimeHash[t.deviceId]||l.updateLastDate(t)}),_.each(l.getBaseStations(),function(e){e.properties&&e.properties.connectionState==c.AVAILABLE_STATE&&(e.modes||S.getBaseStationResource(e.deviceId,"modes"),e.rules||S.getBaseStationResource(e.deviceId,"rules"))}),e.devicesLoaded=!0}),h.purchasedPlans)e.servicePlan=h.getServicePlan();else{var o=h.getPurchasedPlans();o.then(function(){e.servicePlan=h.getServicePlan()})}}if(e.ownDisplayed=[],e.isSafari=-1!=navigator.userAgent.indexOf("Safari/534.57.2"),e.isIE10=null!=navigator.userAgent.match(/MSIE [6789]/),e.isSafari||e.isIE10)return void r.go("oldBrowser");a(function(){b()||t.$broadcast(c.appEvents.SHOW_ERROR,{data:{message:"Adobe ShockwaveFlash plug-in not installed!"}}),e.deviceId&&(e.play(e.deviceId),e.positionTimeout=a(function(){e.stopPlay(e.deviceId)},3e5))});try{e.shutter=new Audio("/mp3/camera-shutter.mp3")}catch(d){}e.lastTimeHash=l.lastTimeHash,e.uiStates=l.uiStateHash,e.Modernizr=Modernizr,document.onkeyup=function(t){var r;if(!t)var t=window.event;t.keyCode?r=t.keyCode:t.which&&(r=t.which),27==r&&e.isOfferShown&&e.showOfferView()},s("i18n")("marketing_how_to_sync_camera_content")?I():e.$on("localizeResourcesUpdated",I)},e.$on(c.appEvents.BODY_CLICK,function(t,r){("cameraViews"==r.target.id||r.target.classList.contains("header")||r.target.classList.contains("footer"))&&e.isOfferShown&&e.showOfferView()}),e.canRecord=function(e){return"USER"!=e.userRole},e.canTakeSnapshot=function(e){return"USER"!=e.userRole},e.numOwnCameras=function(){return _.reduce(e.getCameras(),function(e,t){return e+(t.userId===t.owner.ownerId?1:0)},0)},e.isNoCameras=function(){return l.devices&&!_.findWhere(e.getCameras(),{state:c.PROVISIONED_STATE})},e.isScrollable=function(){return e.scrollable=!!(document.body.clientHeight-document.getElementById("cameraViews").scrollHeight-120)},e.showOfferView=function(){e.isOfferShown=!e.isOfferShown},e.hasServicePlan=function(){return e.servicePlan&&l.devices?!0:!1},e.servicePlanCameraCount=function(){return e.servicePlan?e.servicePlan.maxCameras:0};var A=function(t){var r=l.getDeviceById(t.deviceId);if(r&&r.properties){var n=!1;r.properties.activityState!=c.CAMERA_SETTINGS_ACTIVITYSTATE_STREAM&&r.properties.activityState!=c.CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM||t.activityState!=c.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE&&t.connectionState!=c.UNAVAILABLE_STATE||!T[t.deviceId]||T[t.deviceId].stopped||(n=!0),T[t.deviceId]&&T[t.deviceId].gettingUrl&&t.activityState==c.CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM&&(T[t.deviceId].streamActive=!0);for(var i in t)"deviceId"!=i&&(r.properties[i]=t[i]);n&&e.deviceId?e.stopPlay(e.deviceId):n&&e.uiStates[r.deviceId]&&e.uiStates[r.deviceId].play&&e.stopPlay(r.deviceId),n&&e.uiStates[r.deviceId].play&&(e.startErrors[r.deviceId]=t.stateChangeReason,E[r.deviceId]&&(E[r.deviceId].resolve({canceled:!0}),E[r.deviceId]=null))}};e.$on("$destroy",function(){C(),T={}});var C=e.$on(c.appEvents.CAMERA_BUSY,function(t,r){var n=r.deviceId;e.startErrors[n]=r.message,e.uiStates[n].loading&&(e.uiStates[n].loading=!1),E[n]&&(E[n].resolve({canceled:!0}),E[n]=null)});e.$on(c.appEvents.BRIGHTNESS_UPDATED,function(t,r){e.uiStates[r].showBright=!1,e.uiStates[r].brightnessSaved=!0,a(function(){e.uiStates[r].brightnessSaved=!1},4e3)}),e.clearStartError=function(t){e.startErrors[t]=null},e.setCameraBright=function(t){m.updateSettings(t.parentId,t.deviceId,{brightness:e.uiStates[t.deviceId].brightness}),e.uiStates[t.deviceId].brightnessUpdating=!0},e.isCameraConnecting=function(e){return e.properties&&!e.properties.connectionState},e.isCameraOnline=function(e){var t=l.getDeviceById(e.parentId);return t?t.properties&&t.properties.connectionState==c.AVAILABLE_STATE&&e.properties&&(e.properties.connectionState==c.AVAILABLE_STATE||e.properties.connectionState==c.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL):e.properties&&(e.properties.connectionState==c.AVAILABLE_STATE||e.properties.connectionState==c.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL)
},e.play=function(t){i.debug("Start play pressed.");var r=l.getDeviceById(t);e.uiStates[r.deviceId].loading=!0;var n=o.defer();E[t]=n,T[t]={gettingUrl:!0},u.startStream(t,e.positionMode).then(function(e){return n.resolve(e)},function(e){return n.reject(e)}),n.promise.then(function(n){return e.$$destroyed||n.canceled?void u.stopStream(t):(r=l.getDeviceById(t),i.debug(new Date+": got live stream dynamically:"+r.liveStreamUrl),(e.isSafari||e.isIE10)&&(e.uiStates[r.deviceId].play=!0,e.uiStates[r.deviceId].loading=!1,e.clearStartError(r.deviceId)),void R(r))},function(n){return e.$$destroyed||e.uiStates[t].play?void u.stopStream(t):(r=l.getDeviceById(t),n&&!e.startErrors[r.deviceId]&&(e.startErrors[r.deviceId]="Error "+(n.data.error||"")+": "+n.data.message),e.uiStates[r.deviceId].play=!1,e.uiStates[r.deviceId].loading=!1,void(T[r.deviceId]&&T[r.deviceId].streamActive?e.play(r.deviceId):r.properties.activityState="idle"))})};var R=function(t){{var r={key:"#$47cc9f6a88604d203d3",debug:!1,log:{level:"error",filter:"*"},onBeforeFullscreen:function(){return this.isFullscreen()||e.maximizeId||e.deviceId?(this.isFullscreen()||(e.maximizeId=null),!0):(e.maximizeId=t.deviceId,!1)},play:{opacity:0},clip:{autoPlay:!0,autoBuffering:!0,url:t.liveStreamUrl.slice(-27),live:!0,provider:"influxis",connectionProvider:"secure",bufferLength:1,onBufferEmpty:function(){i.debug("flowplayer buffer empty on device:"+t.deviceId)},onStart:function(){i.debug(new Date+": flowplayer started on device: "+t.deviceId),E[t.deviceId]&&(E[t.deviceId].resolve({canceled:!0}),E[t.deviceId]=null);var r=l.getDeviceById(t.deviceId);e.uiStates[r.deviceId].loading=!1,e.uiStates[r.deviceId].play=!0,e.clearStartError(r.deviceId)},onStop:function(){i.debug("flowplayer onStop called on device:"+t.deviceId),this.stop(),this.isFullscreen()&&this.toggleFullscreen()},onBufferStop:function(){i.debug("flowplayer stop buffering called on device:"+t.deviceId)},onPause:function(){i.debug("flowplayer onPause called on device:"+t.deviceId),this.stop()}},plugins:{influxis:{url:"flowplayer/flowplayer.rtmp-3.2.12.swf",proxyType:"best",netConnectionUrl:encodeURIComponent(t.liveStreamUrl)},secure:{url:"flowplayer/flowplayer.securestreaming-3.2.9.swf",token:"PgtFksiOpsIyWZsfejCohmtqGszDkb8REbL3yZLOF6uSUIyFH9etV7QYuLuZ5MA"},controls:{url:"flowplayer/flowplayer.controls-3.2.16.swf",top:"10px",right:"25px",height:"34px",width:"34px",background:"transparent",backgroundGradient:"none",all:!1,fullscreen:!0,tooltips:{buttons:!1,fullscreen:"Enter fullscreen mode"}}},onError:function(r,n){i.debug("Flowplayer error "+r+": "+n),this.stop();var a=r&&n?"Error "+r+": "+n:"Flowplayer: unknown error";e.startErrors[t.deviceId]=a,i.debug(a),e.stopPlay(t.deviceId)}};$f(t.deviceId,{src:"flowplayer/flowplayer.commercial-3.2.18.swf",wmode:"opaque",onFail:function(){e.uiStates[t.deviceId].loading=!1,e.startErrors[t.deviceId]=s("i18n")("camera_player_plugin_not_installed"),i.debug("Flash not installed.")}},r).play()}};e.stopPlay=function(t){if(!e.uiStates[t].recordRequest&&!e.uiStates[t].snapshotRequest){e.normalExit=!0,T[t].stopped=!0;var n=l.getDeviceById(t);if(n){e.uiStates[t].play=!1,e.uiStates[t].record=!1,e.uiStates[t].showBright=!1,e.uiStates[t].loading=!0,e.stopTimeouts[t]=!0,a(function(){e.stopTimeouts[t]=null},1e3);var o=$f(t);o&&(o.pause(),o.unload()),e.uiStates[n.deviceId].loading=!1,e.maximizeId=null,i.info("stream on camera:"+t+" successfully stopped"),e.deviceId&&!e.go&&r.go("settings.camera",{deviceId:e.deviceId})}}},e.startRecord=function(r){var n=l.getDeviceById(r);e.uiStates[n.deviceId].recordRequest=!0;var a=u.startRecord(n);a.then(function(){i.debug("started recording"),n=l.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,e.uiStates[n.deviceId].record=!0},function(i){n=l.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,t.$broadcast(c.appEvents.SHOW_ERROR,i)})},e.stopRecord=function(r){var n=l.getDeviceById(r);e.uiStates[n.deviceId].recordRequest=!0;var a=u.stopRecord(r);a.then(function(){i.debug("stop recording call returned "),n=l.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,e.uiStates[n.deviceId].record=!1},function(i){n=l.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,e.uiStates[n.deviceId].record=!1,t.$broadcast(c.appEvents.SHOW_ERROR,i)})},e.takeSnapshot=function(r){e.shutter&&e.shutter.play();var n=l.getDeviceById(r);e.uiStates[n.deviceId].snapshotRequest=!0;var a=u.takeSnapshot(n);a.then(function(){n=l.getDeviceById(r),e.uiStates[n.deviceId].snapshotRequest=!1,i.debug("snapshot taken")},function(i){n=l.getDeviceById(r),e.uiStates[n.deviceId].snapshotRequest=!1,t.$broadcast(c.appEvents.SHOW_ERROR,i)})},e.filterByCamera=function(e){p.createStateParams(),p.stateParams.cameraIds=[e.deviceId],p.gotoCalendarView()},e.toggleFullscreen=function(t){e.maximizeId=e.maximizeId?null:t.deviceId}}]).controller("CalendarCtrl",["$scope","$rootScope","$stateParams","$state","$location","$modal","$filter","$log","devicesService","calendarService","libraryService","appProperties","dayService","utilService","metadataService","recordingsService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v){function m(t){e.month=d.month,e.currentMonth=f.getToday().substring(0,6),d.decrementMonth(),e.nextMonth=d.month==e.currentMonth,d.incrementMonth(),e.lastMonth=!1,e.firstMonth=!1,e.firstMonthNav=!1,e.lastDayOfMonth=f.getToday()==e.month+d.getLastDayOfMonth(e.month);var r=p.getFirstMetadata(!0);r.then(function(t){e.firstMonth=t?t.substring(0,6)==e.month:!0,e.firstMonthNav=t?+t.substring(0,6)>=+e.month:!0,e.lastMonth=t?e.month==o("date")(new Date,"yyyyMM"):!0}),e.loading=!0;var n=d.refreshData();return n.then(function(){if(e.weeks=d.weeks,e.favorites=l.favorites,e.favoritesOptions=u.favoritesOptions,e.cameras=l.cameras,e.selectedCameras=l.selectedCameras,(!d.stateParams.day||t||0==d.getNumRecordingsOnDay(d.stateParams.day))&&!e.recycleModeEnable){var r=t?d.getFirstRecordingsDay():d.getDayDate(d.getMostRecentRecordingsDay());d.stateParams.day=r,d.gotoCalendarView()}e.loading=!1}),n}e.init=function(){s.debug("entering init of calendar controller"),e.month="",e.$parent.selectMode=!1,t.selectAllMode=!1,e.lastMonth=!1,e.firstMonth=!1,e.firstMonthNav=!1,c.initDevices().then(function(){r.favorites&&l.setFavorites(r.favorites),e.favorites=l.favorites;var t;r.cameraIds&&(t=r.cameraIds.split(","),e.deviceIds=r.cameraIds,l.setSelectedCamerasFromIds(t)),e.selectedCameras=l.selectedCameras,e.month=r.month?d.month=r.month:d.month,m()})},e.goToRecycle=function(){n.go("calendar.recycled",angular.copy(r))},e.getDay=function(t){var r=e.month+(10>t?"0"+t:t);return r},e.getDayType=function(t){var r="calendar-day";return t.numLibraryRecordings>0&&(e.isFiltered()&&(r+=" calendar-day-filter"),r+=" calendar-day-video"),r},e.getCameras=function(){return e.selectedCameras?e.selectedCameras:c.devices?(e.cameras=_.filter(c.devices,function(e){return e.deviceType==u.CAMERA_DEVICE_TYPE&&(e.state==u.PROVISIONED_STATE||e.state==u.SYNCED_STATE)}),e.sortDevices(),e.cameras):[]},e.reloadCalendar=function(){e.$parent.selectMode&&e.toggleSelectMode(),m()},e.getCellType=function(t,r){var n="";if(t.dayOfMonth){var i=f.getToday(),a=e.month+(t.dayOfMonth<10?"0":"")+t.dayOfMonth;t&&a==i?n+=" calendar-day-white calendar-day-today":(!e.lastMonth||parseInt(i)>parseInt(a))&&(n+=" calendar-day-white")}else e.lastMonth&&0!=r||(n+=" calendar-day-white");return n},e.getRecordings=function(){return v.recordings&&e.favorites&&e.selectedCameras?_.filter(v.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==u.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=u.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e.toggleSelectMode=function(){if(e.$parent.selectMode=!e.$parent.selectMode,v.selectMode=e.$parent.selectMode,!e.$parent.selectMode){for(var r=e.getRecordings(),n=0;n<r.length;n++)r[n].selected=!1;t.selectAllMode=!1}},e.isFiltered=function(){if(!e.favorites)return!1;var t=c.getAllCameraIds().length;return e.favorites.value!=u.favoritesOptions[0].value||t!=e.selectedCameras.length},e.isRecords=function(){return p.metadata&&p.metadata[d.stateParams.day]},e.prev=function(){if(!e.firstMonthNav||e.nextMonth){var r=g.nextId();t.$broadcast("queueStatus",{id:r,type:"progress",text:"loading previous month"}),d.decrementMonth(),d.stateParams.month=d.month,d.stateParams.day="",m().then(function(){t.$broadcast("dequeueStatus",r)})}},e.next=function(){if(!e.lastMonth||e.lastDayOfMonth){if(e.nextMonth)return;var r=g.nextId();t.$broadcast("queueStatus",{id:r,type:"info",text:"loading next month"}),d.incrementMonth(),d.stateParams.month=d.month,d.stateParams.day="",m().then(function(){t.$broadcast("dequeueStatus",r)})}},e.removeFilter=function(){d.stateParams=null,d.gotoCalendarView()},e.first=function(){var e=d.getFirst();e.then(function(){var e=d.getFirstRecordingsDay();d.month=d.stateParams.month=e.substring(0,6),d.stateParams.day=e,d.gotoCalendarView()})},e.today=function(){var e=f.getToday();d.month=d.stateParams.month=e.substring(0,6),d.stateParams.day=e,d.gotoCalendarView()},e.getDayDisplay=function(e){return e?o("dayText")(e):"Please select date"},e.gotoDay=function(t){t.numLibraryRecordings>0&&(e.$parent.selectMode&&e.toggleSelectMode(),d.stateParams.day=e.getDay(t.dayOfMonth),d.gotoCalendarView())}}]).controller("DayCtrl",["$scope","$rootScope","$state","$stateParams","$location","$modal","$log","appProperties","dayService","libraryService","calendarService","recordingsService","devicesService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){e.init=function(){o.debug("entering init of day controller"),l.stateParams=angular.copy(n),e.libraryMode=!0,c.day=l.stateParams.day,f.initDevices().then(function(){g()}),c.day==c.getToday()&&e.$on(s.appEvents.MEDIA_UPLOAD_NOTIFICATION,function(){c.refreshData()})};var g=function(){t.$broadcast("recycleModeDisable"),u.selectMode=!1,e.day=l.stateParams.day,d.setFavorites(n.favorites);var r;if(r=n.cameraIds?n.cameraIds.split(","):[],d.setSelectedCamerasFromIds(r),e.favorites=d.favorites,e.favoritesOptions=s.favoritesOptions,e.month=l.month,0==r.length)e.selectedCameras=d.selectedCameras;else{var i=c.refreshData();i.then(function(){e.selectedCameras=d.selectedCameras,e.selectedRecordings=[];for(var r=e.getRecordings(),n=0;n<r.length;n++)r[n].friendRecording=e.isFriendRecording(r[n])?!0:!1,t.noRecordigsOnPage=!1,e.selectedRecordings[n]=!1})}};e.getRecordings=function(){return u.recordings&&e.favorites&&e.selectedCameras?_.filter(u.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==s.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=s.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e.getSelectableRecordings=function(){var t=e.getRecordings();return _.filter(t,function(e){return 0==e.friendRecording})},e.getSelectedCount=function(){return _.reduce(u.recordings,function(e,t){return t.selected&&e++,e},0)},e.selectRecording=function(n){var i=u.recordings;if(e.$parent.selectMode)e.isFriendRecording(i[n])||(i[n].selected=!i[n].selected,e.getSelectableRecordings().length==e.getSelectedCount()&&(t.selectAllMode=!0),i[n].selected||(t.selectAllMode=!1));else{for(var a="",o=0;o<d.selectedCameras.length;o++)a+=o?","+d.selectedCameras[o].deviceName:d.selectedCameras[o].deviceName;r.go("recording",{recordingNumber:n,favorites:e.favorites.value,cameraIds:a})}},e.canSelect=function(){return!f.isPureUser()},e.isVideo=function(e){return e.contentType==s.videoFormat},e.isFavorite=function(e){return e.currentState==s.FAVORITE_STATE},e.isFriendRecording=function(e){var t=_.findWhere(f.allDevices,{deviceId:e.deviceId});return!t||t.userRole==s.USER_ROLE_USER},e.isSelectMode=function(){return u.selectMode},e.showFilter=function(){a.open({templateUrl:"partials/calendarFilterView.html",controller:"CalendarFilterCtrl",backdrop:"static"})}}]).controller("SelectAllCtrl",["$scope","$rootScope","$state","$stateParams","$filter","$interval","appProperties","recordingsService","devicesService",function(e,t,r,n,i,a,o,s,c){e.getRecordings=function(){return s.recordings&&e.favorites&&e.selectedCameras?_.filter(s.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==o.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=o.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e.isFriendRecording=function(e){var t=_.findWhere(c.allDevices,{deviceId:e.deviceId});return!t||t.userRole==o.USER_ROLE_USER},e.getSelectableRecordings=function(){for(var t=e.getRecordings(),r=0;r<t.length;r++)t[r].friendRecording=e.isFriendRecording(t[r])?!0:!1;return _.filter(t,function(e){return 0==e.friendRecording})},e.toggleSelectAll=function(){if(e.getSelectableRecordings().length){t.selectAllMode=!t.selectAllMode;for(var r=e.getRecordings(),n=0;n<r.length;n++)e.isFriendRecording(r[n])||(r[n].selected=t.selectAllMode?!0:!1)}},e.isSelectMode=function(){return s.selectMode},e.isFriendRecording=function(e){var t=_.findWhere(c.allDevices,{deviceId:e.deviceId});return!t||t.userRole==o.USER_ROLE_USER}}]).controller("RecycleSelectAllCtrl",["$scope","$filter",function(e){e.init=function(){e.selectAllRecycledMode=!1},e.isSelectAllRecycledMode=function(){return e.selectAllRecycledMode}}]).controller("RecordingCtrl",["$scope","$rootScope","$state","$stateParams","$filter","$interval","$timeout","appProperties","recordingsService","calendarService","libraryService","devicesService",function(e,t,r,n,i,a,o,s,c,d,l,u){e.init=function(){(!Modernizr.video||-1!=navigator.userAgent.toLowerCase().indexOf("mac")&&-1!=navigator.userAgent.toLowerCase().indexOf("firefox"))&&(e.oldBrowser=!0),e.time=0,e.duration=0,e.timePercent=0,e.playbackRate=1,e.recordings=c.recordings,e.recordingNumber=n.recordingNumber,e.recording=c.recordings[e.recordingNumber],c.setCurrent(e.recording),e.recordingImageUrl=e.recording.presignedThumbnailUrl;var t=i("toBSTime")(e.recording.utcCreatedDate,e.recording.timeZone);e.videoDate=i("dayText")(i("date")(t,"yyyyMMdd")),e.isLoadingVideo=e.loaded=!1,e.recordingNext=c.getNextContent(e.recordingNumber),e.recordingPrev=c.getPreviousContent(e.recordingNumber),e.playing=!1,e.pause(),e.screenfull=screenfull},e.$on("recording-deleted",function(t,n){t.stopPropagation(),e.playing=!1,e.pause(),e.setVideoPosition(0);for(var i="",a=0;a<l.selectedCameras.length;a++)i+=a?i+=","+l.selectedCameras[a].deviceName:l.selectedCameras[a].deviceName;n[1]-n[0]>1?r.go("recording",{recordingNumber:n[1]-1,favorites:l.favorites.value,cameraIds:i}):e.init()}),e.setSliderPosition=function(t){if(e.playing){var r=document.getElementById("recordedVideo");r.duration?(e.time=t*r.duration/100,e.timePercent=t):(e.time=0,e.timePercent=0),e.setVideoPosition(t)}},e.getRecordingDuration=function(){return e.duration?i("secToString")(e.duration):"00:00:00"},e.sliderClick=function(t){if(e.playing&&e.duration>0){var r=100*(t.layerX-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setSliderPosition(r);var n=document.getElementById("recordedVideo");n.currentTime=r*n.duration/100}},e.setVideoPosition=function(t){if(e.duration>0){var r=document.getElementById("recordedVideo");r.currentTime=t*r.duration/100}},e.isVideo=function(){return e.recording.contentType==s.videoFormat},e.prevContent=function(){e.isVideo()&&e.playing&&e.pause();var t=c.getPreviousContent(e.recordingNumber);r.go("recording",{recordingNumber:t.recordingNumber})},e.play=function(){e.loaded||(e.isLoadingVideo=e.loaded=!0,e.recordingVideoUrl=e.recording.presignedContentUrl);var t=document.getElementById("recordedVideo");e.playbackRate=1,t.playbackRate=e.playbackRate,o(function(){t.play(),e.playing=!0})},e.pause=function(){var t=document.getElementById("recordedVideo");t.pause(),e.playing=!1},e.nextContent=function(){e.isVideo()&&e.playing&&e.pause();var t=c.getNextContent(e.recordingNumber);r.go("recording",{recordingNumber:t.recordingNumber})},e.gotoCalendarView=function(){u.initDevices().then(function(){d.gotoCalendarView()})},e.fullScreen=function(){var e=document.getElementById("recordedVideo");screenfull.enabled&&screenfull.request(e)}}]).controller("SharedRecordingCtrl",["$scope","$rootScope","$stateParams","$filter","$timeout","appProperties","recordingsService","calendarService","devicesService",function(e,t,r,n,i,a,o){function s(){e.playing=!1,e.time=0,e.duration=0,e.timePercent=0,e.playbackRate=1,e.isLoadingVideo=e.loaded=!1,e.isVideo(e.recording)||(e.recordingImageUrl=e.recording.presignedContentUrl)}e.init=function(){e.loading=!0,(!Modernizr.video||-1!=navigator.userAgent.toLowerCase().indexOf("mac")&&-1!=navigator.userAgent.toLowerCase().indexOf("firefox"))&&(e.oldBrowser=!0),e.token=r.token,o.getSharedRecordings(e.token).then(function(t){e.recordings=t.data,e.recording=t.data[0],s()},function(r){e.error=!0,t.$broadcast(a.appEvents.SHOW_ERROR,r.data)})["finally"](function(){e.loading=!1}),e.screenfull=screenfull},e.setSliderPosition=function(t){if(e.playing){var r=document.getElementById("recordedVideo");r.duration?(e.time=t*r.duration/100,e.timePercent=t):(e.time=0,e.timePercent=0),e.setVideoPosition(t)}},e.getRecordingDuration=function(){return e.duration?n("secToString")(e.duration):"00:00:00"},e.sliderClick=function(t){if(e.playing&&e.duration>0){var r=100*(t.layerX-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setSliderPosition(r);var n=document.getElementById("recordedVideo");n.currentTime=r*n.duration/100}},e.setVideoPosition=function(t){if(e.duration>0){var r=document.getElementById("recordedVideo");r.currentTime=t*r.duration/100}},e.isVideo=function(e){return e&&-1!=e.presignedContentUrl.indexOf(".mp4?")},e.play=function(){e.loaded||(e.isLoadingVideo=e.loaded=!0,e.recordingVideoUrl=e.recording.presignedContentUrl);var t=document.getElementById("recordedVideo");e.playbackRate=1,t.playbackRate=e.playbackRate,i(function(){t.play(),e.playing=!0})},e.pause=function(){var t=document.getElementById("recordedVideo");t.pause(),e.playing=!1},e.selectRecording=function(t){t!=e.recording&&(e.playing?(e.pause(),e.recording=t,i(function(){s(),i(function(){e.play()})})):(e.recording=t,i(function(){s()})))},e.fullScreen=function(){var e=document.getElementById("recordedVideo");screenfull.enabled&&screenfull.request(e)},e.goHome=function(){location.href="/"}}]).controller("SettingsCtrl",["$scope","$rootScope","$state","$location","appProperties","baseStationService","devicesService","cameraSettingsService","friendsService","userService","servicePlanService",function(e,t,r,n,i,a,o,s,c,d,l){e.init=function(){var e=o.initDevices();e.then(function(){l.getPurchasedPlans(),c.getFriends(),_.each(o.getBaseStations(),function(e){!e.modes&&e.properties&&e.properties.connectionState==i.AVAILABLE_STATE&&a.getBaseStationResource(e.deviceId,"modes")})})},e.scrollTopPosition=function(e){t.settingsOffsetTopPosition=e,t.$broadcast("settingsScrollingOn",null)},e.getBaseStations=function(){return o.getBaseStations()},e.isOwnerBS=function(e){return e.userRole==i.USER_ROLE_OWNER},e.getCameras=function(){return o.devices?o.getAllCameras():[]},e.getServicePlan=function(){return l.getServicePlan()},e.gotoCamera=function(e){e.properties&&"unavailable"!=e.properties.connectionState&&r.go("settings.camera",{deviceId:e.deviceId})},e.isOwnCamera=function(e){return e.userId===e.owner.ownerId},e.isNonOwner=function(){return!d.paymentId},e.canSetPreferences=function(){return o.hasOwnDevices()},e.hasOwnCameras=function(){return e.getCameras()?e.getCameras().length>0&&_.reduce(e.getCameras(),function(e,t){return e||t.userId===t.owner.ownerId},!1):!1},e.hasServicePlan=function(){return!!e.getServicePlan()},e.getFriendsCount=function(){return c.friends?"("+c.friends.length+")":""}}]).controller("CameraSettingsCtrl",["$scope","$rootScope","$state","$stateParams","$timeout","cameraSettingsService","camerasService","devicesService","baseStationService","pushHandlerService","appProperties","deviceEventsChannel",function(e,t,r,n,i,a,o,s,c,d,l,u){e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"\'\}]+$/,e.init=function(){if(e.bestVideo=l.CAMERA_SETTINGS_POWERSAVEMODE_BEST_VIDEO,e.optimized=l.CAMERA_SETTINGS_POWERSAVEMODE_OPTIMIZED,e.batteryLife=l.CAMERA_SETTINGS_POWERSAVEMODE_BATTERY_LIFE,e.takingSnapshot=null,e.$on(l.appEvents.SNAPSHOT_LOADED,function(t,r){r.deviceId==n.deviceId&&(i.cancel(e.takingSnapshot),e.takingSnapshot=null,e.camera.presignedFullFrameSnapshotUrl=s.getCameraById(n.deviceId).presignedFullFrameSnapshotUrl)}),n.deviceId&&(e.camera=angular.copy(s.getCameraById(n.deviceId))),e.camera)e.camera.presignedFullFrameSnapshotUrl||e.takeSnapshot(),e.selectPowerSaveMode(e.camera.properties.powerSaveMode);else{s.initDevices()}u.onEventData(e,f),e.$on(l._RESOURCE_UPDATE_,function(){if(!e.camera||!e.camera.properties||!e.camera.properties.powerSaveMode){var t=s.getCameraById(n.deviceId);t&&t.properties&&t.properties.powerSaveMode&&(e.camera=angular.copy(t),e.selectPowerSaveMode(e.camera.properties.powerSaveMode),e.camera.presignedFullFrameSnapshotUrl||e.takeSnapshot())}})},e.isLoading=function(){var t=s.getDeviceById();return t&&t.properties&&t.properties.connectionState==l.UNAVAILABLE_STATE&&r.go("settings"),!e.camera||!e.camera.properties||!e.camera.properties.powerSaveMode};e.$on(l.appEvents.CAMERA_BUSY,function(e,r){t.$broadcast(l.appEvents.SHOW_ERROR,{data:r})});e.$on(l.appEvents.TAKE_SNAPSHOT,function(t,r){r==n.deviceId&&e.takeSnapshot()});var f=function(t){return e.camera&&t.deviceId==n.deviceId?t.connectionState==l.UNAVAILABLE_STATE?void r.go("settings"):void(t.activityState&&(e.camera.properties.activityState=t.activityState)):void 0};e.takeSnapshot=function(){i.cancel(e.takingSnapshot),e.takingSnapshot=null,o.getFullFrameSnapshot(n.deviceId,!0).then(function(){e.takingSnapshot=i(function(){e.takingSnapshot=null},2e4)})},e.isCameraAvailable=function(){var t=s.getCameraById(n.deviceId);return!e.cameraNameForm.$invalid&&t&&t.properties&&t.properties.connectionState&&t.properties.connectionState!=l.UNAVAILABLE_STATE},e.positionMode=function(){var e=s.getCameraById(n.deviceId);return e&&e.properties&&e.properties.connectionState==l.UNAVAILABLE_STATE&&r.go("settings"),a.isPositionMode(n.deviceId)},e.motionDetectionMode=function(){return e.camera&&e.camera.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]===l.CAMERA_SETTINGS_ACTIVITYSTATE_MOTION_DETECTION_MODE},e.selectPowerSaveMode=function(t){e.camera.properties.powerSaveMode=t},e.isSelected=function(t){return e.camera&&t==e.camera.properties.powerSaveMode},e.done=function(){var t=s.getCameraById(n.deviceId);if(t&&t.deviceName!=e.camera.deviceName){var i=c.renameDevice(e.camera);i.then(function(){t.deviceName=e.camera.deviceName})}e.camera.properties.mirror=e.camera.properties.flip;var o=a.updateSettings(e.camera.parentId,e.camera.deviceId,_.pick(e.camera.properties,l.CAMERA_SETTINGS_BRIGHTNESS,l.CAMERA_SETTINGS_ZOOM,l.CAMERA_SETTINGS_MIRROR,l.CAMERA_SETTINGS_FLIP,l.CAMERA_SETTINGS_POWERSAVEMODE));o.then(function(){}),r.go("settings")},e.toggleInvertMode=function(){e.camera&&(e.camera.properties.flip=!e.camera.properties.flip)},e.togglePositionMode=function(){e.isCameraBusy()||r.go("settings.positionMode",{deviceId:e.camera.deviceId})},e.toggleMotionDetectionMode=function(){return void(e.isCameraBusy()||r.go("settings.motionTest",{deviceId:e.camera.deviceId}))},e.isCameraBusy=function(){return!e.camera||!e.camera.properties||e.camera.properties.connectionState==l.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL||e.camera.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]==l.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM||e.camera.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]==l.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE||e.camera.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]==l.CAMERA_ACTIVITYSTATE_ALERT_WATCH||e.camera.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]==l.CAMERA_ACTIVITYSTATE_FULLFRAMESNAPSHOT},e.isCameraIdle=function(){return e.camera&&e.camera.properties&&e.camera.properties[l.CAMERA_SETTINGS_ACTIVITYSTATE]==l.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE}}]).controller("PersonalInfoCtrl",["$scope","$rootScope","$q","$location","$modal","$state","appProperties","userService","loginService","uiService",function(e,t,r,n,i,a,o,s,c,d){e.init=function(){e.loading=!0,e.password="",e.oldUserId=s.userName,s.getProfile().then(function(){e.userId=e.oldUserId,e.firstName=s.firstName,e.lastName=s.lastName,e.validEmail="true"==s.validEmail,e.modifyUserId=!1,e.modifyPassword=!1,e.modifyName=!1,e.loading=!1})},e.done=function(){e.modifyUserId=e.personalInfoForm.userId.$dirty&&e.userId!=e.oldUserId,e.modifyPassword=e.personalInfoForm.newPassword.$dirty,e.modifyName=e.personalInfoForm.firstName.$dirty||e.personalInfoForm.lastName.$dirty,e.loading=!0;var n,i,a;e.modifyUserId&&(n=s.updateUserId(e.userId,e.password),n.then(function(){s.userName=e.userId,s.settings&&s.setUserName(e.userId)})),e.modifyPassword&&(i=c.updatePassword(e.password,e.newPassword).then(function(){s.settings&&s.setSettings(e.newPassword)})),e.modifyName&&(a=s.updateName(e.firstName,e.lastName),a.then(function(){s.firstName=e.firstName,s.lastName=e.lastName})),r.all([n,i,a]).then(function(){e.loading=!1},function(r){e.loading=!1,t.$broadcast(o.appEvents.SHOW_ERROR,r)})},e.confirmEmail=function(){e.confirmMessage="Send",e.message="Send email confirmation to "+s.userName+"?";var r=i.open({templateUrl:"partials/confirmDialog.html",controller:"ConfirmCtrl",scope:e,backdrop:!0});r.result.then(function(){s.confirmEmail().then(function(){d.info("A link to confirm your email address has been emailed to you.")},function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e)})})}}]).controller("ClaimBaseStationCtrl",["$scope","$rootScope","$location","$state","$log","$modal","setupService","devicesService","jsonService","servicePlanService","appProperties","userService",function(e,t,r,n,i,a,o,s,c,d,l,u){e.init=function(){u.isLoggedIn()||(o.setupPending=!0),e.setupPending=o.setupPending;var r=s.queryPresentDevices();r.then(function(){e.devices=s.presentDevices,e.devices&&e.devices.length>0&&(e.device=e.devices[0].hardwareId)},function(e){e&&t.$broadcast(l.appEvents.SHOW_ERROR,e)}),o.setupPending||d.getPurchasedPlans(),e.timeZones=c.timeZones().query(function(){var t=new Date,r=new Date(t.getFullYear(),0,1).getTimezoneOffset(),n=new Date(t.getFullYear(),6,1).getTimezoneOffset(),i=Math.max(r,n),a=_.findWhere(l.timeZoneHash,{offset:i.toString()});e.timeZone=a?_.findWhere(e.timeZones,{id:a.id}):e.timeZones[0]})},e.cancel=function(){n.go(o.setupPending?"login":d.getServicePlan()?"settings.subscription":"settings")},e["continue"]=function(){var r=_.findWhere(e.devices,{hardwareId:e.device});if(o.isSetup||!o.setupPending)e.claimInProgress=!0,s.claimDevice(r._id,r.hardwareId,e.timeZone).then(function(){e.claimInProgress=!1,d.getServicePlan()?n.go("settings.subscription"):(o.setupPending=!0,n.go("servicePlan"))},function(r){e.claimInProgress=!1,t.$broadcast(l.appEvents.SHOW_ERROR,r||"Error occurred.")});else{if(o.accountRegistered)throw"Unknown system setup state";o.selectedBaseStation=r,o.timeZone=angular.copy(e.timeZone),n.go("accountRegistration")}}}]).controller("AccountRegistrationCtrl",["$scope","$location","$state","$q","$modal","$stateParams","appProperties","$resource","setupService","devicesService","jsonService","urlService","userService","servicePlanService","pushHandlerService","localStorage",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v){e.init=function(){(c.accountRegistered||c.isSetup)&&t.path(o.camerasRoute);var r=l.secretQuestions();r.then(function(t){e.secretQuestions=t.data})},e.displayTos=function(){e.viewMode=!1,i.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:u.getTermsUrl(),scope:e,backdrop:"static"}).result.then(function(t){e.agreeTos="ok"==t})},e.displayPrivacy=function(){i.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:u.getPolicyUrl(),scope:e,backdrop:"static"}).result.then(function(t){e.agreePrivacy="ok"==t})},e["continue"]=function(){if(!e.agreeTos)return e.agreeTosError=!0,!1;if(!e.agreePrivacy)return e.agreePrivacyError=!0,!1;var t={email:e.userId,password:e.password,firstName:e.firstName,lastName:e.lastName,secretQuestion:e.secretQuestion==e.secretQuestions[e.secretQuestions.length-1]?e.ownSecretQuestion:e.secretQuestion,secretAnswer:e.secretAnswer,phone:e.phone,agreeTos:e.agreeTos,agreePrivacyPolicy:e.agreePrivacy,agreePrivacyPolicyDate:(new Date).getTime()};c.timeZone&&(t.timeZone=c.timeZone),e.loading=!0;var i=f.register(t);i.then(function(){f.registerUserError||c.updateSetupState()},function(t){return e.loading=!1,e.registerError=t&&t.data?t.data.message:t,e.accountRegistrationForm.$setPristine(),n.reject(t)}).then(function(){if(c.updateSetupState(),v.setItem("isSetup","true"),c.isSetup){var e=d.getDevices();e.then(function(){p.init(),r.go("cameras")})}else r.go("servicePlan")})}}]).controller("SelectServicePlanCtrl",["$scope","$rootScope","$location","$modal","$state","setupService","servicePlanService","billingFlowService","devicesService","appProperties",function(e,t,r,n,i,a,o,s,c,d){e.init=function(){s.pendingPlan=null,e.setupPending=a.setupPending,e.loadingMessage="Loading service plans...",e.loading=!0,e.servicePlanSelected=a.servicePlanSelected;var r=o.getOffersV1();r.then(function(r){e.$on("plan_selected",function(t,r){e.select(r)}),t.$broadcast("offers",r.data),e.loading=!1},function(r){t.$broadcast(d.appEvents.SHOW_ERROR,r),e.loading=!1})},e.select=function(t){return"paid"!=t.planType.toLowerCase()?void i.go("syncHardware"):(a.servicePlanSelected=!0,e.loadingMessage="",s.pendingPlan={setupPlan:t},void i.go("billingInformation"))},e.isBillingInProgress=function(){return s.inProgress}}]).controller("BillingInformationCtrl",["$scope","$rootScope","$state","$log","$filter","$timeout","appProperties","jsonService","setupService","servicePlanService","urlService","userService","billingFlowService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(t){var r=t.data;if(r.hasOwnProperty("formReLoaded")){if(n.debug("Form of payment response reloaded"),r.params)if("0"==r.params.errors)n.debug("Setting formOfPaymentResponse"),e.formOfPaymentResponse=r.params;else{var a=p(r.params);if(a.length>=1){var o=parseInt(a[0]);e.errorMessage=i("i18n")("aria_directpost_error_"+o)}else e.errorMessage=i("i18n")("card_error");e.formOfPaymentResponse={error:!0}}else n.debug("Form of payment returned no params in message");e.$apply()}}function p(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&r.indexOf("error_code")>-1&&t.push(e[r]);return t}function v(){e.loading=!1,e.errorMessage=i("i18n")("billing_timeout_error")}e.init=function(){if(!Modernizr.postmessage)return void r.go("oldBrowser");e.setupPending=c.setupPending,e.countries=s.countryCodes().query(function(){e.country=_.findWhere(e.countries,{code:u.countryCode||"US"}),e.setVatPattern()}),e.statesUS=s.stateUSCodes().query(function(){if(d.billingInfo&&"US"==d.billingInfo.billing.countryCode){var t=_.findWhere(e.statesUS,{code:d.billingInfo&&d.billingInfo.billing.state||"CA"});t&&(e.stateUS=t)}}),e.statesGB=s.stateGBCodes().query(function(){if(d.billingInfo&&"GB"==d.billingInfo.billing.countryCode){var t=_.findWhere(e.statesGB,{code:d.billingInfo&&d.billingInfo.billing.state||"GB-LND"});t&&(e.stateGB=t)}}),window.addEventListener("message",g),e.vatNumber="";var n=(new Date).getFullYear();if(e.creditCard={expirationYear:n.toString()},d.billingInfo&&!e.setupPending)m();else if(e.setupPending)e.billingInfo={firstName:"",lastName:"",companyName:"",address1:"",address2:"",city:"",state:"",postalCode:"",countryCode:""},e.autoRenew=!0;else{var i=d.getBilling();i.then(function(){m()},function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e)})}e.years=_.map(_.range(n,n+9),function(e){return e.toString()})};var m=function(){e.billingInfo=angular.copy(d.billingInfo.billing),d.billingInfo.creditCard.cardNumber&&(e.creditCard=angular.copy(d.billingInfo.creditCard),e.creditCard.cardNumber=e.creditCard.cardNumber?"************"+e.creditCard.cardNumber:"",e.creditCard.cvv=e.creditCard.cardNumber?"***":""),e.autoRenew=d.billingInfo.autoRenew,e.vatNumber=d.billingInfo.vatNumber,delete e.billingInfo.vatNumber,d.billingInfo.creditCard.cardNumber||(e.showRenew=!0)
};e.vatRequired=function(){return e.country&&e.country.vat},e.zipPattern=function(){var t=e;return{test:function(e){return t.country&&("US"==t.country.code||"GB"==t.country.code)&&t.country.zip?new RegExp(t.country.zip).test(e):!0}}}(),e.setVatPattern=function(){e.country?e.vatRegExp=new RegExp(e.country.vat):e.billingInfo&&e.billingInfo.country&&(e.vatRegExp=new RegExp(e.billingInfo.country.vat))},e.setVatNumber=function(t){e.vatNumber=t},e.getCountry=function(){return e.country?e.country.name:u.countryCode},e["continue"]=function(){e.loading=!0,e.errorMessage=!1,e.billingInfo.countryCode=u.countryCode,e.country&&(e.billingInfo.state="US"==e.country.code?e.stateUS.code:"GB"==e.country.code?e.stateGB.code:"");var n={billing:e.billingInfo,autoRenew:e.autoRenew,vatNumber:e.vatNumber};e.billingError="",d.modifyBilling(n).then(function(n){e.loading=!1;var i=n.data.data,s=document.getElementById("formOfPayment").contentWindow;if(e.cardInformationForm.$dirty){var d={sessionId:i.sessionId,clientNo:i.client_no,cardNumber:e.creditCard.cardNumber,expirationMonth:e.creditCard.expirationMonth,expirationYear:e.creditCard.expirationYear,cvv:e.creditCard.cvv,url:i.url};e.timeoutId&&a.cancel(e.timeoutId),e.timeoutId=a(v,8e4),e.$watch("formOfPaymentResponse",function(){e.formOfPaymentResponse&&(e.loading=!1,a.cancel(e.timeoutId),e.formOfPaymentResponse.error?document.getElementById("formOfPayment").src=document.getElementById("formOfPayment").src:c.setupPending?f.pendingPlan&&f.processBillingEvent(f.pendingPlan.setupPlan?f.pendingPlan:{toPlanId:f.pendingPlan.toPlans}).then(function(){f.selectServicePending=!1,r.go("syncHardware")},function(t){t&&(e.errorMessage=angular.isString(t)?t:t.data.message)}):f.selectServicePending?f.processBillingEvent({toPlanId:f.pendingPlan.toPlans}).then(function(){f.selectServicePending=!1,r.go("settings.subscription")},function(e){f.selectServicePending=!1,angular.isString(e)&&t.$broadcast(o.appEvents.SHOW_ERROR,{data:{message:e}}),r.go("settings.plans")}):r.go("settings.subscription"),e.formOfPaymentResponse=null)},!0),e.loading=!0,s.postMessage(d,l.staticAssetsUrl),e.cardInformationForm.$setPristine()}else c.setupPending?f.pendingPlan&&f.processBillingEvent(f.pendingPlan.setupPlan?f.pendingPlan:{toPlanId:f.pendingPlan.toPlans}).then(function(){f.selectServicePending=!1,r.go("syncHardware")},function(t){t&&(e.errorMessage=angular.isString(t)?t:t.data.message)}):r.go("settings.subscription");e.billingInformationForm.$setPristine()},function(r){e.loading=!1,r.data?e.billingError=r.data.message:t.$broadcast(o.appEvents.SHOW_ERROR,{data:{message:"Unknown error in modify billing occurred"}}),e.billingInformationForm.$setPristine(),e.cardInformationForm.$setPristine()})},e.isBillingInProgress=function(){return f.inProgress}}]).controller("ConfirmCtrl",["$scope","$modalInstance",function(e,t){e.confirmButton=e.confirmMessage,e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}]).controller("SyncHardwareCtrl",["$scope","$state","setupService","devicesService","calendarService","dayService","pushHandlerService","libraryService","baseStationService","cameraSettingsService",function(e,t,r,n,i,a,o,s){e.init=function(){},e["continue"]=function(){r.setupPending&&(o.init(),r.setupPending=!1),r.hardwareSynced=!0,r.updateSetupState();var e=n.initDevices();e.then(function(){i.setDefaultMonth(),a.setDefaultDay(i.month),s.initialize(),t.go("cameras")})}}]).controller("FriendsCtrl",["$scope","$state","$q","friendsService","devicesService","servicePlanService",function(e,t,r,n,i,a){e.loading=!0,e.init=function(){var t=[i.initDevices(),n.getFriends(),a.getPurchasedPlans()];r.all(t).then(function(){e.friends=n.friends,e.maxAccounts=a.getServicePlan().maxAccounts,e.isBasic=a.isFreePlan(a.getServicePlan()),e.expired=!a.getServicePlan().sharing})["finally"](function(){e.loading=!1})},e.add=function(){t.go("settings.editFriend")},e.isDevices=function(){return i.devices&&i.devices.length>0&&e.maxAccounts&&(-1==e.maxAccounts||e.maxAccounts>e.friends.length)}}]).controller("EditFriendCtrl",["$scope","$state","$stateParams","$location","$modal","$filter","devicesService","friendsService","servicePlanService","uiService",function(e,t,r,n,i,a,o,s,c,d){function l(e,t){e.message="Are you sure you want to delete friend?",e.confirmButton=a("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(){if(r.email){if(e.friend=angular.copy(_.findWhere(s.friends,{email:r.email})),!e.friend)return void t.go("settings.friends");e.oldEmail=e.friend.email,e.editMode=!0}else e.friend={adminUser:!1},e.editMode=!1;o.initDevices().then(function(){e.cameras=o.getOwnCameras(),e.selection={},e.selection.ids={},_.each(e.cameras,function(t){var r=_.findWhere(e.friend.devices,{deviceId:t.deviceId});e.selection.ids[t.deviceId]="undefined"!=typeof r})});var n=c.getServicePlan();n?e.isBasic=c.isFreePlan(n):c.getPurchasedPlans().then(function(){e.isBasic=c.isFreePlan(c.getServicePlan())})},e.emailUnique=function(t){e.editFriendForm.firstName.$setViewValue(e.editFriendForm.firstName.$viewValue),e.editFriendForm.lastName.$setViewValue(e.editFriendForm.lastName.$viewValue);var r=_.findWhere(s.friends,{email:t});return e.editFriendForm.email.$error.email||!e.editMode&&r||e.editMode&&r&&r.email!=e.oldEmail?e.editFriendForm.email.$setValidity("unique",!1):e.editFriendForm.email.$setValidity("unique",!0)},e.done=function(r){e.loading=!0,e.friend.devices={},_.each(e.selection.ids,function(t,r){e.selection.ids[r]&&(e.friend.devices[r]=o.getDeviceById(r).deviceName)});var n;if(e.editMode){var i=angular.copy(e.friend);delete i.createdDate,delete i.status,n=r?s.addFriend(i)["finally"](function(){e.loading=!1}):s.editFriend(i)["finally"](function(){e.loading=!1})}else n=s.addFriend(e.friend)["finally"](function(){e.loading=!1,e.isBasic&&d.info(a("i18n")("marketing_label_warning_basic_friend_usage"))});n.then(function(){t.go("settings.friends")})},e.deviceSelected=function(){return e.selection&&_.some(e.selection.ids,function(e){return e})},e.deleteFriend=function(){var r=i.open({templateUrl:"partials/confirmDialog.html",controller:l,scope:e,backdrop:!0,resolve:{}});r.result.then(function(){var r=s.deleteFriend(e.friend);r.then(function(){t.go("settings.friends")})})},l.$inject=["$scope","$modalInstance"],e.toggleCamera=function(t){e.selection.ids[t.deviceId]=!e.selection.ids[t.deviceId]},e.toggleAdminUser=function(){e.friend.adminUser=!e.friend.adminUser}}]).controller("ModesCtrl",["$scope","$state","$stateParams","pushHandlerService","scheduleValidationService","devicesService","baseStationService","appProperties","servicePlanService",function(e,t,r,n,i,a,o,s,c){e.init=function(){e.deviceId=decodeURIComponent(r.deviceId),a.initDevices().then(function(){var r=a.getBaseStationById(e.deviceId);r||t.go("settings"),r.modes||o.getBaseStationResource(e.deviceId,"modes")}),e.predicate="name"},e.isLoading=function(){var t=a.getBaseStationById(e.deviceId);return!t||!t.hasOwnProperty("modes")},e.getModes=function(){var t=a.getBaseStationById(e.deviceId);return t&&t.modes?t.modes:[]},e.getDeviceName=function(){var t=a.getBaseStationById(e.deviceId);return t?t.deviceName:""},e.canAddMode=function(){var t=c.getServicePlan(),r=t&&t.maxSmartHomeModes?t.maxSmartHomeModes:0;if(-1==r)return!0;var n=e.baseStation&&e.baseStation.modes?e.baseStation.modes.length:0;return r>n},e.add=function(){t.go("settings.addMode",{deviceId:e.deviceId})}}]).controller("EditModeCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$filter","appProperties","schedulingService","scheduleValidationService","baseStationService","devicesService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u){function f(e,t){e.message="Are you sure you want to delete mode?",e.confirmButton=a("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}var g;e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"\'\}]+$/,e.init=function(){e.baseStationId=decodeURIComponent(n.deviceId),n.modeId&&(g=decodeURIComponent(n.modeId),e.editMode=!0),l.initDevices().then(function(){var t=l.getBaseStationById(e.baseStationId);t||r.go("settings"),t.rules||d.getBaseStationResource(e.baseStationId,"rules"),t.modes||d.getBaseStationResource(e.baseStationId,"modes"),g||(e.newMode=d.createDefaultMode())})},e.isLoading=function(){var t=l.getBaseStationById(e.baseStationId);return!t||!e.getMode()||!t.hasOwnProperty("rules")},e.getMode=function(){if(e.newMode)return e.newMode;if(e.mode)return e.mode;var t=l.getBaseStationById(e.baseStationId);return t&&t.modes?(e.mode=angular.copy(_.findWhere(t.modes,{id:g})),e.mode):null},e.getRules=function(){var t=l.getBaseStationById(e.baseStationId),r=e.getMode();return t&&t.rules&&r?_.filter(t.rules,function(e){return _.contains(r.rules,e.id)}):[]},e.getAvailableRules=function(){var t=e.getMode(),r=l.getBaseStationById(e.baseStationId);return t&&r&&r.rules?r.rules:[]},e.isRuleSelected=function(t){var r=e.getMode();return r?_.contains(r.rules,t.id):!1},e.isModeValid=function(t){var t=e.getMode();return t?c.validateMode(e.baseStationId,t):!1},e.deviceName=function(e){var t=l.getDeviceName(e);return t},e.deleteRule=function(t){e.getMode().rules=_.without(e.getMode().rules,t)},e.toggleSelectRule=function(t){if(e.isRuleSelected(t))e.deleteRule(t.id);else{p(t);var r=e.getMode();r.rules.push(t.id)}};var p=function(t){var r=_.find(t.actions,function(e){return e.deviceId}).deviceId,n=e.getMode(),i=l.getBaseStationById(e.baseStationId);_.each(n.rules,function(n){var a=_.findWhere(i.rules,{id:n});a&&t.triggers[0].deviceId==a.triggers[0].deviceId&&_.findWhere(a.actions,{deviceId:r})&&e.deleteRule(a.id)})};e.selectRule=function(){if(e.newRuleId){var t=e.getMode();t.rules.push(e.newRuleId),e.newRuleId=""}},e.addRule=function(){r.go("settings.addModeRule",{baseStationId:e.baseStationId,modeId:g})},e.deleteMode=function(){var n=l.getBaseStationById(e.baseStationId);if(n.activeMode.id==g)return void u.info("Active mode could not be deleted");var a=i.open({templateUrl:"partials/confirmDialog.html",controller:f,scope:e,backdrop:!0,resolve:{}});a.result.then(function(){var i=d.deleteMode(e.baseStationId,g);i.then(null,function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e?{data:e}:{data:{message:"Server returned null on delete mode request."}})}),n.modes=_.reject(n.modes,function(e){return e.id===g}),delete n.schedule,r.go("settings.modes",{deviceId:e.baseStationId})})},f.$inject=["$scope","$modalInstance"],e.done=function(){g?d.setMode(e.baseStationId,e.getMode()):d.addMode(e.baseStationId,e.getMode()),r.go("settings.modes",{deviceId:e.baseStationId})},e.isRuleAction=function(e,t){switch(t){case"email":return _.findWhere(e.actions,{type:"sendEmailAlert"});case"record":return _.findWhere(e.actions,{type:"recordVideo"})}}}]).controller("RulesCtrl",["$scope","$state","$stateParams","pushHandlerService","baseStationService","devicesService",function(e,t,r,n,i,a){e.init=function(){e.deviceId=decodeURIComponent(r.deviceId),a.initDevices().then(function(){var r=a.getBaseStationById(e.deviceId);r||t.go("settings"),r.rules||i.getBaseStationResource(e.deviceId,"rules")})},e.isLoading=function(){var t=a.getBaseStationById(e.deviceId);return!t||!t.hasOwnProperty("rules")},e.getRules=function(){var t=a.getBaseStationById(e.deviceId);return t&&t.rules?t.rules:[]},e.getDeviceName=function(){var t=a.getBaseStationById(e.deviceId);return t?t.deviceName:""}}]).controller("EditRuleCtrl",["$scope","$stateParams","$state","$modal","$log","$timeout","$filter","appProperties","userService","pushHandlerService","baseStationService","devicesService","scheduleValidationService","camerasService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){function p(e,t){e.message="Are you sure you want to delete rule?",e.confirmButton=o("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}var v,m,h,S;e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"\'\}]+$/,e.goBack=function(){return e.isEditAlerts?void(e.isEditAlerts=!1):void(h?r.go("settings.editMode",{deviceId:v,modeId:h}):r.go("settings.rules",{deviceId:v}))},e.isLoading=function(){var t=u.getBaseStationById(v);return!t||!e.getRule()},e.getOwnerEmail=function(){return c.userName},e.getRule=function(){if(e.newRule)return e.newRule;if(e.rule)return e.rule;var t=u.getBaseStationById(v);return t&&t.rules?(e.rule=angular.copy(_.findWhere(t.rules,{id:S})),e.rule.name.length>32&&(e.rule.name=e.rule.name.substring(0,32)),e.rule&&e.rule.actions[0]&&(!e.rule.actions[0].stopCondition||e.rule.actions[0].stopCondition.motionDetectionZone)&&(e.rule.actions[0].stopCondition={type:"timeout",timeout:10}),e.rule):null},e.getCameras=function(){var e=_.filter(l.getAllCamerasOfBaseStation(v),function(e){return"provisioned"===e.state});return e||[]},e.init=function(){e.takingSnapshot=null,v=decodeURIComponent(t.baseStationId),t.ruleId&&(S=t.ruleId),u.initDevices().then(function(){m=u.getBaseStationById(v),m||r.go("settings"),m.rules||l.getBaseStationResource(v,"rules")}),e.actions=[{type:"recordVideo",description:"Record Video"}],S?e.editMode=!0:e.newRule=l.createDefaultRule(),t.modeId&&(h=t.modeId)};e.isRuleValid=function(){var t=e.getRule(),r=u.getBaseStationById(v);return t&&r?f.validateRule(r.deviceId,t):!1},e.triggerChanged=function(t){t&&!e.getRule().actions[0].deviceId&&(e.getRule().actions[0].deviceId=t,e.deviceChanged(t))},e.deviceChanged=function(){},e.getDetector=function(t){if(!e.getRule()||!e.getRule().actions||!e.getRule().actions.length)return"";var t=e.getRule().actions[0].deviceId,r=u.getDeviceById(t);return r&&r.properties?r.properties.presignedSnapshotUrl:""},e.detectorSensitivity=function(e){var t=Math.floor(e/100*100);return isNaN(t)?50:t},e.cameraName=function(e){return u.getDeviceName(e)},e.done=function(){e.isEditAlerts?e.doneAlerts():e.doneRule()},e.doneRule=function(){if(f.fixRule(e.getRule()),"recordVideo"==e.getRule().actions[0].type?e.getRule().actions[0].stopCondition.deviceId=e.getRule().actions[0].deviceId:delete e.getRule().actions[0].stopCondition,S){{_.find(e.getRule().actions,function(e){return"sendEmailAlert"===e.type})}l.setRule(v,e.getRule())}else l.addRule(v,e.getRule());e.goBack()},e.editAlerts=function(){var t=_.find(e.getRule().actions,function(e){return"sendEmailAlert"===e.type});e.alertEmails=[],t&&t.recipients&&(e.alertEmails=angular.copy(t.recipients)),e.allAlertEmails=f.getAllEmails(),e.isEditAlerts=!0},e.deleteRule=function(){var t=n.open({templateUrl:"partials/confirmDialog.html",controller:p,scope:e,backdrop:!0,resolve:{}});t.result.then(function(){S&&(l.deleteRule(v,S),m.rules=_.reject(m.rules,function(e){return e.id===S}),delete m.modes),e.goBack()})},p.$inject=["$scope","$modalInstance"],e.select=function(t){_.contains(e.alertEmails,t)?e.alertEmails=_.without(e.alertEmails,t):e.alertEmails.push(t)},e.addAlert=function(){if(!e.alertsForm.newEmail.$error.email){var t=e.newEmail.trim();return t.toLowerCase()==e.getOwnerEmail().toLowerCase()?(e.newEmail=null,void e.alertsForm.$setPristine()):void(_.find(e.allAlertEmails,function(e){return t.toLowerCase()==e.toLowerCase()})?e.alertEmails=_.union(e.alertEmails,t):(e.alertEmails.push(t),e.allAlertEmails.push(t),e.newEmail=null,e.alertsForm.$setPristine()))}},e.cancel=function(){e.isEditAlerts?e.isEditAlerts=!1:r.go("settings.editModeRule",{baseStationId:v,modeId:h,ruleId:S})},e.doneAlerts=function(){var t=_.find(e.getRule().actions,function(e){return"sendEmailAlert"===e.type});if(t&&!e.alertEmails.length){var r=e.getRule().actions.indexOf(t);e.getRule().actions.splice(r,1)}else e.alertEmails.length&&(t||(t=f.createDefaultEmailAction(),e.getRule().actions.push(t)),t.recipients=e.alertEmails);e.isEditAlerts=!1},e.isSelected=function(t){return _.contains(e.alertEmails,t)}}]).controller("AlertEmailsCtrl",["$scope","$state","$stateParams","$location","$modal","$log","userService","appProperties","devicesService","baseStationService","scheduleValidationService",function(e,t,r,n,i,a,o,s,c,d,l){var u,f,g,p;e.init=function(){f=c.getBaseStationById(decodeURIComponent(r.baseStationId)),r.ruleId?(p=r.ruleId,e.rule=_.find(f.rules,function(e){return e.id===p})):e.rule=f.addRuleObject;var t=_.find(e.rule.actions,function(e){return"sendEmailAlert"===e.type});e.alertEmails=[],t&&t.recipients&&(e.alertEmails=angular.copy(t.recipients)),e.allAlertEmails=l.getAllEmails(),r.modeId&&(g=r.modeId),u=f.deviceId},e.select=function(t){_.contains(e.alertEmails,t)?e.alertEmails=_.without(e.alertEmails,t):e.alertEmails.push(t)},e.addAlert=function(){e.alertsForm.newEmail.$error.email||(_.contains(e.allAlertEmails,e.newEmail)?e.alertEmails=_.union(e.alertEmails,e.newEmail):(e.alertEmails.push(e.newEmail),e.allAlertEmails.push(e.newEmail),e.newEmail=null))},e.cancel=function(){t.go("settings.editModeRule",{baseStationId:u,modeId:g,ruleId:p})},e.done=function(){var r=_.find(e.rule.actions,function(e){return"sendEmailAlert"===e.type});r||(r=l.createDefaultEmailAction(),e.rule.actions.push(r)),r.recipients=e.alertEmails,t.go("settings.editModeRule",{baseStationId:u,modeId:g,ruleId:p})},e.isSelected=function(t){return _.contains(e.alertEmails,t)}}]).controller("FooterCtrl",["$scope","$rootScope","$state","$modal","$filter","$timeout","appProperties","userService","calendarService","logoutService","dayService","libraryService","recordingsService","baseStationService","gatewayPollingService","pushHandlerService","devicesService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,v,m,h){function S(e,t){e.confirmButton=i("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(t){e.mode=t,e.showModes=!1,m.initDevices(),f.selectMode=!1,a(function(){var t=new ZeroClipboard(document.getElementById("copy-button"));t.on("ready",function(){t.on("aftercopy",function(){e.email=null})})})},e.canChangeMode=function(){return _.findWhere(m.getBaseStations(),{state:o.PROVISIONED_STATE})},e.canSelect=function(){var e=!m.isPureUser()&&(!f.selectMode||_.findWhere(f.recordings,{selected:!0}));return e},e.gotoCalendarView=function(){c.gotoCalendarView()},e.gotoLogout=function(){s.setFromLogout();var e=d.logout();e.then(function(){r.go("login")})},e.getRecording=function(){return f.current},e.isCurrentFavorite=function(){return f.isFavorite(e.getRecording())},e.onlyFavoriteSelected=function(){for(var t=0,r=0;r<f.recordings.length;r++)f.recordings[r].selected&&f.isFavorite(f.recordings[r])&&t++;var n=_.where(f.recordings,{selected:!0}).length==t;if(!f.selectMode){var i=e.getRecording();n=f.isFavorite(i)}return n},e.isFavorite=function(){if(f.selectMode){for(var t=!1,r=0;r<f.recordings.length;++r)if(t=t||f.recordings[r].selected,f.recordings[r].selected&&!f.isFavorite(f.recordings[r]))return!1;return t}return e.isCurrentFavorite()},e.favorite=function(){var r=new Array(f.recordings.length),n=!1;if(f.selectMode){for(var i=!e.isFavorite(),a=0;a<f.recordings.length;++a)f.recordings[a].selected&&(r[a]=i,n=!0);t.selectAllMode=!1}else{var o=f.recordings.indexOf(e.getRecording());r[o]=!f.isFavorite(e.getRecording()),n=!0}if(n){var s=f.favoriteRecordings(r,f.recordings);s.then(function(){f.selectMode?l.refreshData():f.toggleFavorite(e.getRecording())},function(){f.selectMode&&l.refreshData()})}},e.share=function(){e.emailLoading=!0,e.email=null;var r=f.shareRecordings();r.then(function(t){e.email=t.data.email,e.link=e.email.content.match(/https:\/\/.*arlo.*[\r\n]/g)[0]},function(e){e&&t.$broadcast(o.appEvents.SHOW_ERROR,e)})["finally"](function(){e.emailLoading=!1})},e.download=function(){if(f.selectMode){for(var r=0;r<f.recordings.length;++r)f.recordings[r].selected&&e.downloadLink(f.recordings[r]);t.selectAllMode=!1}else e.downloadLink(e.getRecording())},e.downloadLink=function(e){if(!Modernizr.adownload)return window.open(e.presignedContentUrl,"_blank"),!1;var t=document.createElementNS("http://www.w3.org/1999/xhtml","a");t.href=e.presignedContentUrl,t.download=e.reason+"."+e.contentType.split("/")[1],t.target="_blank";var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(r)},e.getRecordings=function(){return f.recordings&&e.favorites&&e.selectedCameras?_.filter(f.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==o.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=o.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e["delete"]=function(){if(f.selectMode){if(this.onlyFavoriteSelected())return;for(var a=0,o=!1,s=0,d=f.recordings,u=e.getRecordings().length,g=0;g<d.length;++g)d[g].selected&&++a,d[g].selected&&f.isFavorite(d[g])&&(++s,o=!0);if(a){e.message=i("i18n")("library_label_confirm_delete_media"),o&&(e.message+="<br/>"+i("i18n")("subscription_label_delete_all_unlocked_files_note"));var p=n.open({templateUrl:"partials/confirmDialog.html",controller:S,scope:e,backdrop:!0,resolve:{}});p.result.then(function(){var r=f.recycleRecordings(f.recordings),n=a-s;r.then(function(){var r=1==a?"File has been deleted.":n+" files have been deleted.";h.info(r),l.refreshData(),t.selectAllMode=!1,n==u&&e.reloadCalendar()})})}}else{var v=e.getRecording();if(v.selected=!0,!f.isFavorite(v)){e.message=i("i18n")("library_label_confirm_delete_media");var p=n.open({templateUrl:"partials/confirmDialog.html",controller:S,scope:e,backdrop:!0,resolve:{}});p.result.then(function(){var n=f.recycleRecordings([v]);n.then(function(){var n="File has been deleted.",i=h.info(n);i.then(function(){var n=_.indexOf(f.recordings,f.current),i=_.indexOf(f.recordings,f.getNextContent(n)),a=_.indexOf(f.recordings,f.getPreviousContent(n));f.recordings.splice(n,1),f.persistRecordings(),v.recordingNumber!=i?e.$emit("recording-deleted",[n,i]):v.recordingNumber!=a?r.go("recording",{recordingNumber:a}):c.gotoCalendarView(),t.noRecordigsOnPage=!1})})})}}},S.$inject=["$scope","$modalInstance"],e.isVideo=function(){return e.getRecording().contentType==o.videoFormat},e.isRecordingMode=function(){return"recording"==e.mode||f.selectMode},e.sendEmail=function(){var t="mailto:?subject="+encodeURIComponent(e.email.subject)+"&body="+encodeURIComponent(e.email.content);e.email=null,window.location.href=t.length>2e3?t.substr(0,2e3):t}}]).controller("CalendarFilterCtrl",["$scope","$rootScope","$state","appProperties","calendarService","devicesService",function(e,t,r,n,i,a){e.init=function(){e.favoritesOptions=n.favoritesOptions,e.favorites=_.findWhere(n.favoritesOptions,{value:i.stateParams.favorites});var t=i.stateParams.cameraIds.split(",");e.selectedCameras=_.filter(e.getCameras(),function(e){return-1!=t.indexOf(e.deviceId)})},e.getCameras=function(){return _.filter(a.allDevices,function(e){return e.deviceType==n.CAMERA_DEVICE_TYPE&&e.state!=n.REMOVED_STATE})},e.favoritesChanged=function(t){e.favorites=t},e.camerasSelectionChanged=function(t){var r=e.selectedCameras.indexOf(t);r>-1?e.selectedCameras.splice(r,1):e.selectedCameras.push(t)},e.done=function(){i.stateParams.favorites=e.favorites.value,i.stateParams.cameraIds=_.map(e.selectedCameras,function(e){return e.deviceId}).join(","),i.gotoCalendarView()},e.isCameraSelected=function(t){return _.findWhere(e.selectedCameras,{deviceId:t})?!0:!1}}]).controller("RecycledDateCtrl",["$scope","$rootScope","$filter","$element","recordingsService",function(e,t,r,n,i){function a(){e.loading=!0,e.currentPage=1,o=_.where(i.recycled,{createdDate:e.createdDate}),e.pageCount=Math.ceil(o.length/d),s=o.slice(0,d)}var o,s,c,d=200;e.init=function(t,r){e.selectedAllRecycleRecordings=!1,e.expanded=!1,e.createdDate=t,e.promise.then(function(){r&&(e.expanded=!0,a())})["finally"](function(){e.loading=!1})},e.expand=function(){e.promise.then(function(){a()})["finally"](function(){e.loading=!1,e.expanded=!e.expanded})},e.getRecordings=function(){return s},e.nextPage=function(t){e.currentPage+=t,s=o.slice(d*(e.currentPage-1),d*e.currentPage),c=_.where(s,{selected:!0}),e.selectedAllRecycleRecordings=s.length==c.length?!0:!1},e.selectRecording=function(t){e.utcDate=i.recycled[t].utcCreatedDate,i.recycled[t].selected=!i.recycled[t].selected,c=_.where(s,{selected:!0}),e.selectedAllRecycleRecordings=c.length==s.length?!0:!1},e.toggleRecycleSelectAll=function(){e.selectedAllRecycleRecordings=!e.selectedAllRecycleRecordings,e.$emit(e.selectedAllRecycleRecordings?"selectAllRecycleRecordings":"unselectAllRecycleRecordings");for(var t=0;t<o.length;t++)o[t].selected=e.selectedAllRecycleRecordings?!0:!1}}]).controller("RecycledCtrl",["$scope","$rootScope","$filter","$stateParams","recordingsService","calendarService","dayService","appProperties",function(e,t,r,n,i,a,o,s){e.init=function(){i.selectMode=!1,a.stateParams=angular.copy(n),o.day=a.stateParams.day,e.loading=!0,e.promise=i.getRecycleRecordings()["finally"](function(){e.getRecycleDates(),e.loading=!1}),t.$broadcast("recycleModeEnable")},e.getRecycleDates=function(){var t=i.recycled;e.dates=[];for(var r=0;r<t.length;r++)-1==_.indexOf(e.dates,t[r].createdDate)&&e.dates.push(t[r].createdDate)},e.restore=function(){var r=_.find(i.recycled,function(e){return e.selected});if(r){var n=i.restoreRecordings(i.recycled);n.then(function(){e.init(),e.reloadCalendar()},function(e){e&&t.$broadcast(s.appEvents.SHOW_ERROR,e)})}},e.gotoCalendarView=function(){e.$parent.selectMode=!1,a.gotoCalendarView()},e.getSelectedCount=function(){return _.reduce(i.recycled,function(e,t){return t.selected&&e++,e},0)},e.isVideo=function(e){return e.contentType==s.videoFormat}}]).controller("AboutCtrl",["$scope","$modal","urlService",function(e,t,r){e.init=function(){},e.displayTos=function(){e.viewMode=!0,t.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:r.getTermsUrl(),scope:e,backdrop:!0})}}]).controller("CameraOrderCtrl",["$scope","$modal","$log","$state","$filter","$timeout","appProperties","libraryService","devicesService","baseStationService","camerasService","servicePlanService","deviceEventsChannel",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(e,t){e.message=i("i18n")("camera_order_confirm_delete_camera").replace("{cameraName}",e.cameraName),e.confirmButton=i("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(){e.loading=!0,c.initDevices().then(function(){e.cameras=null,e.loading=!1})},e.$on("new_camera",function(){e.cameras=null}),e.getCameras=function(){return e.cameras?e.cameras:c.devices?(e.cameras=_.filter(angular.copy(c.devices),function(e){return e.deviceType==o.CAMERA_DEVICE_TYPE&&(e.state==o.PROVISIONED_STATE||e.state==o.SYNCED_STATE)}),e.sortDevices(),e.cameras):[]},e.sortDevices=function(){e.cameras=i("orderBy")(e.cameras,"displayOrder")},e.done=function(){var t=l.setCameraOrder(e.cameras);t.then(function(){var e=c.getDevices();e.then(function(){f.refreshCameras(),n.go("settings")})})},e.deleteCamera=function(n){e.cameraName=n.deviceName;var i=t.open({templateUrl:"partials/confirmDialog.html",controller:g,scope:e,backdrop:!0,resolve:{}});i.result.then(function(){var t=d.removeDevice(n.parentId,n.deviceId);t.then(function(){r.info("Camera have been deleted."),c.getDevices().then(function(){e.cameras=null});var t=c.getDeviceById(n.parentId);t&&t.state==o.PROVISIONED_STATE&&t.properties&&t.properties.connectionState==o.AVAILABLE_STATE&&(d.getBaseStationResource(n.parentId,"modes"),d.getBaseStationResource(n.parentId,"rules"))})})},g.$inject=["$scope","$modalInstance"]}]).controller("BaseStationCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$q","$filter","appProperties","jsonService","baseStationService","pushHandlerService","devicesService","userService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){function p(e,t){e.message=o("i18n")("base_station_settings_confirm_restart").replace("{baseStationName}",u.getDeviceById(e.deviceId).deviceName),e.confirmButton=o("i18n")("base_station_settings_activity_restart"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}function v(e,t){e.message=o("i18n")("base_station_settings_confirm_deactivate").replace("{baseStationName}",u.getDeviceById(e.deviceId).deviceName),e.confirmButton=o("i18n")("base_station_settings_activity_deactivate"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"'\}]+$/,e.init=function(){e.deviceId=decodeURIComponent(n.baseStationId),u.initDevices().then(function(){m()})},e.$on(s.appEvents.BS_REBOOTED,function(t,r){var n=u.getDeviceById(r);n&&(n.properties.connectionState=s.UNAVAILABLE_STATE,_.each(_.where(u.devices,{parentId:e.deviceId}),function(e){e.properties.connectionState=s.UNAVAILABLE_STATE})),g.info("Base Station has been restarted")});var m=function(){return e.baseStation=angular.copy(u.getBaseStationById(e.deviceId)),!e.baseStation||e.baseStation.state!=s.PROVISIONED_STATE&&e.baseStation.state!=s.SYNCED_STATE?void r.go("settings"):void(e.baseStation.owner.ownerId!=f.userId?e.admin=!0:(e.baseStation.properties&&e.baseStation.properties.timeZone&&(e.timeZones=c.timeZones().query(function(){e.baseStation.properties&&(e.timeZone=_.findWhere(e.timeZones,{id:e.baseStation.properties.timeZone}))})),e.$on(s._RESOURCE_UPDATE_,function(){e.baseStation=angular.copy(u.getBaseStationById(e.deviceId)),e.baseStation.properties&&(e.timeZone=_.findWhere(e.timeZones,{id:e.baseStation.properties.timeZone}))})))};e.toggleAutoUpdate=function(){e.baseStation.properties.autoUpdateEnabled=!e.baseStation.properties.autoUpdateEnabled},e.isBaseStationAvailable=function(){var t=u.getDeviceById(e.deviceId);return t&&t.properties&&t.properties.connectionState&&"available"==t.properties.connectionState?!0:!1},e.isBaseStationMotion=function(){if(u.devices){var t=!1;return _.each(u.devices,function(r){r.parentId!=e.deviceId||!r.properties||"startAlertStream"!=r.properties.activityState&&"alertStreamActive"!=r.properties.activityState||(t=!0)}),t}return!1},e.done=function(){var t=d.renameDevice(e.baseStation);if(!e.admin&&e.isBaseStationAvailable()){var n=d.setTimeZone(e.deviceId,e.timeZone),i=d.setAutoUpdate(e.deviceId,e.baseStation.properties.autoUpdateEnabled);a.all([t,n,i]).then(function(){u.getBaseStationById(e.deviceId).deviceName=e.baseStation.deviceName,d.getBaseStationResource(e.deviceId,"basestation")})}else t.then(function(){u.getBaseStationById(e.deviceId).deviceName=e.baseStation.deviceName});r.go("settings")},e.reboot=function(){var r=i.open({templateUrl:"partials/confirmDialog.html",controller:p,scope:e,backdrop:!0,resolve:{}});r.result.then(function(){d.restartBaseStation(e.deviceId).then(function(){},function(e){t.$broadcast(s.appEvents.SHOW_ERROR,e&&e.data&&e.data.message?e:{data:{message:"Base Station failed to restart."}})})})},p.$inject=["$scope","$modalInstance"],e.isBSRebooting=function(){return d.rebootingBS[e.deviceId]},e.deactivate=function(){var t=i.open({templateUrl:"partials/confirmDialog.html",controller:v,scope:e,backdrop:!0,resolve:{}});t.result.then(function(){var t=d.removeDevice(e.deviceId);t.then(function(){u.getDevices(),r.go("settings")})})},v.$inject=["$scope","$modalInstance"],e.gotoBSUpdate=function(){e.baseStation.properties.autoUpdateEnabled||r.go("settings.baseStationUpdate",{deviceId:e.deviceId})}}]).controller("BaseStationUpdateCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$filter","$q","appProperties","jsonService","baseStationService","devicesService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u){e.init=function(){e.deviceId=decodeURIComponent(n.deviceId);var t=l.getBaseStationById(e.deviceId);return t?void 0:void e.back()},e.getUpdateAvailable=function(){var t=l.getBaseStationById(e.deviceId);return t.properties.updateAvailable},e.isBusy=function(){return _.some(l.devices,function(t){return t.deviceType==s.CAMERA_DEVICE_TYPE&&t.state==s.PROVISIONED_STATE&&t.parentId==e.deviceId&&t.properties&&t.properties.connectionState==s.AVAILABLE_STATE&&t.properties.activityState!=s.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE?!0:!1
})},e.update=function(){var t=e.getUpdateAvailable().version;e.message=a("i18n")("manual_fw_update_confirm_update").replace("{fwVersion}",t),e.confirmMessage=a("i18n")("activity_label_update");var r=i.open({templateUrl:"partials/confirmDialog.html",controller:"ConfirmCtrl",scope:e,backdrop:!0,resolve:{}});r.result.then(function(){e.isBusy()?u.info(a("i18n")("base_station_error_4006")):(d.manualUpdate(e.deviceId,t),u.info("Base Station upgrade has been started"))})},e.back=function(){r.go("settings.baseStation",{baseStationId:n.deviceId})}}]).controller("StatusCtrl",["$scope","notifyService",function(e,t){e.init=function(){e.qStatus={},e.$on("queueStatus",function(t,r){e.qStatus[r.id]=r}),e.$on("dequeueStatus",function(t,r){delete e.qStatus[r]})},e.isActive=function(){e.count=0;for(var r in t.responseHandlers)e.count++;return!!e.count}}]).controller("SubscriptionCtrl",["$scope","$rootScope","$modal","$q","$state","$filter","appProperties","devicesService","baseStationService","recordingsService","servicePlanService","userService","billingFlowService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){function p(e,t){e.message=a("i18n")("label_confirm_delete_unlocked_files"),e.confirmButton=a("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(){f.selectServicePending=!1,e.planAmount="",e.storagePlanAmount="";var r=[s.initDevices(),l.getPurchasedPlans(),l.getOffers()];n.all(r).then(function(){e.initValues()},function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e)});var i=l.getBilling();i.then(function(){e.billingInfo=l.billingInfo}),i=u.updateStorageQuota(),i.then(function(){e.storageQuota=u.storageQuota}),i=d.getLibraryState()},e.$on(o.BILLING_EVENT,function(){e.init()}),e.initValues=function(){e.servicePlan=l.getServicePlan(),e.storageServicePlan=l.getStorageServicePlan(),e.cameras=_.where(s.devices,{deviceType:o.CAMERA_DEVICE_TYPE,userRole:"OWNER"});var t=e.servicePlan.maxCameras-e.cameras.length;e.offCameras=new Array(0>t?0:t),e.baseStations=_.where(s.getBaseStations(),{userRole:"OWNER"}),t=e.servicePlan.maxBaseStations-e.baseStations.length,e.offBaseStations=new Array(0>t?0:t);var r=l.isFreePlan(e.servicePlan);e.storage=e.servicePlan.maxStorage/o.ONE_MEGA,e.servicePlanExt=_.findWhere(l.servicePlans,{planId:e.servicePlan.planId}),e.servicePlanExt||(e.servicePlanExt=l.servicePlans[0]),e.freePlanId=_.find(l.servicePlans,function(e){return l.isFreePlan(e)}).planId,e.planAmount=r?"Free":("1"==e.servicePlan.term?"Monthly ":"12"==e.servicePlan.term?"Annual ":"")+e.servicePlan.planCurrencyAmount,e.storagePlanAmount=e.storageServicePlan&&("1"==e.storageServicePlan.term?"Monthly ":"12"==e.storageServicePlan.term?"Annual ":"")+e.storageServicePlan.planCurrencyAmount},e.cancelService=function(){f.processBillingEvent({cancel:!0}).then(function(){e.init()},function(e){e&&t.$broadcast(o.appEvents.SHOW_ERROR,e)})},e.recycleBinEmpty=function(){if(d.libraryState){var e=_.findWhere(d.libraryState,{state:"new"});if(e)return 0===e.count;throw"No 'new' library state"}return!0},e.deleteAllFiles=function(){var t=r.open({templateUrl:"partials/confirmDialog.html",controller:p,scope:e,backdrop:!0,resolve:{}});t.result.then(function(){var t=d.deleteAllRecordings();t.then(function(){g.info("All unlocked recordings have been deleted"),d.getLibraryState();var t=u.updateStorageQuota();t.then(function(){e.storageQuota=u.storageQuota})})})},p.$inject=["$scope","$modalInstance"],e.isBillingInProgress=function(){return f.inProgress||e.updating},e.changeRenew=function(){e.updating=!0,l.changeRenew(e.billingInfo.autoRenew)["catch"](function(){e.billingInfo.autoRenew=!e.billingInfo.autoRenew})["finally"](function(){e.updating=!1})}}]).controller("SubscriptionPlansCtrl",["$scope","$rootScope","$modal","$q","$state","$timeout","appProperties","servicePlanService","billingFlowService","devicesService",function(e,t,r,n,i,a,o,s,c,d){e.init=function(){c.pendingPlan=null,e.planAmount="",e.storagePlanAmount="",e.loading=!0;var r=[s.getPurchasedPlans(),s.getOffers(),s.getBilling()];n.all(r).then(function(){e.initValues()},function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e)})["finally"](function(){e.loading=!1});var a=e.$on(o.BILLING_EVENT,function(){i.go("settings.subscription")});e.$on("$destroy",function(){a()})},e.initValues=function(){e.servicePlans=_.filter(s.servicePlans,function(e){return!s.isStoragePlan(e)}),e.servicePlan=s.getServicePlan(),e.selectPlan(e.servicePlan),e.storageServicePlan=s.getStorageServicePlan(),e.selectedStorage=e.storageServicePlan||{planId:0};var t=s.isFreePlan(e.servicePlan);e.storage=e.servicePlan.maxStorage/o.ONE_MEGA,e.servicePlanExt=_.findWhere(s.servicePlans,{planId:e.servicePlan.planId}),e.servicePlanExt||(e.servicePlanExt=s.servicePlans[0]),e.freePlanId=_.find(s.servicePlans,function(e){return s.isFreePlan(e)}).planId,e.planAmount=t?"Free":("1"==e.servicePlan.term?"Monthly ":"12"==e.servicePlan.term?"Annual ":"")+e.servicePlan.planCurrencyAmount,e.storagePlanAmount=e.storageServicePlan&&e.storageServicePlan.planId?("1"==e.storageServicePlan.term?"Monthly ":"12"==e.storageServicePlan.term?"Annual ":"")+e.storageServicePlan.planCurrencyAmount:""},e.isOldPlansSelected=function(){var t=[e.selectedPlan.planId];e.selectedStorage&&e.selectedStorage.planId&&t.push(e.selectedStorage.planId);var r=_.pluck(s.purchasedPlans,"planId");return r.length==t.length&&_.intersection(r,t).length==t.length?!0:void 0},e.changeService=function(){var r=[e.selectedPlan.planId];return e.selectedStorage&&e.selectedStorage.planId&&r.push(e.selectedStorage.planId),s.billingInfo.creditCard.cardNumber?void c.processBillingEvent({toPlanId:r}).then(function(){d.getDevices(),s.getPurchasedPlans(),i.go("settings.subscription")},function(e){return e&&e.data&&("8059"==e.data.error.toString()||"8060"==e.data.error.toString())?(i.go("settings.billingInformation"),void a(function(){t.$broadcast(o.appEvents.SHOW_ERROR,e)},1e3)):void(e&&t.$broadcast(o.appEvents.SHOW_ERROR,e.data?e:{data:{message:e}}))}):(c.selectServicePending=!0,c.pendingPlan={toPlans:r},void i.go("settings.billingInformation"))},e.isBillingInProgress=function(){return c.inProgress},e.selectPlan=function(t){e.selectedPlan=t,e.selectedStorage=null;var r=s.isFreePlan(t);e.storagePlans=_.filter(s.servicePlans,function(t){return s.isStoragePlan(t)&&(r||t.term==e.selectedPlan.term)})},e.selectStorage=function(t){e.selectedStorage=t},e.goBack=function(){e.isShowDetails?e.isShowDetails=!e.isShowDetails:i.go("settings.subscription")},e.showDetails=function(){if(e.isShowDetails=!0,!e.detailsHTML){var r=s.getOffersDetails();r.then(function(t){var r=t.data.html.match(/<\s*style[^>]*>.*?<\s*\/style>/)[0],n=t.data.html.match(/<\s*body[^>]*>(.*?)<\s*\/body>/)[1];e.detailsHTML=r+n},function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e)})}}}]).controller("PreferencesCtrl",["$scope","$state","userService",function(e,t,r){e.init=function(){e.autoUpdate=!1,e.loading=!0;var t=r.updatePreferences();t.then(function(){e.preferences=r.getPreferences(),e.loading=!1})},e.done=function(){r.setPreferences(e.preferences),t.go("settings")},e.toggleStorage=function(){e.preferences.storage.enabled=!e.preferences.storage.enabled},e.toggleStorageFull=function(){e.preferences.alerts.storageAlert=!e.preferences.alerts.storageAlert},e.toggleLowBattery=function(){e.preferences.alerts.lowBatteryAlert=!e.preferences.alerts.lowBatteryAlert},e.setAutoDelete=function(t){e.preferences.storage.autoDelete=t}}]).controller("AlertErrorCtrl",["$scope","$state","$timeout","appProperties",function(e,t,r,n){e.timeout=1e4,e.hidden2=!0,e.animation=!1,e.$on(n.appEvents.SHOW_ERROR,function(t,n){e.timeoutId&&clearTimeout(e.timeoutId),n&&n.data&&n.data.message&&(e.alertMessage=n.data.message,e.animation=!1,e.hidden2=!1,r(function(){e.animation=!0},0))}),e.$on(n.appEvents.HIDE_ERROR,function(){e.hide()}),e.$on(n.appEvents.BODY_CLICK,function(){e.hide()}),e.hide=function(){e.animation=!1,e.hidden2=!0},e.getType=function(){var e=t.current.name;return-1!=e.indexOf("settings")?"settings":-1!=e.indexOf("claimBaseStation")||-1!=e.indexOf("accountRegistration")||-1!=e.indexOf("servicePlan")||-1!=e.indexOf("billingInformation")||-1!=e.indexOf("syncHardware")?"setup":-1!=e.indexOf("cameras")?"cameras":void 0}}]).controller("ShutdownCtrl",["$scope","gatewayPollingService","pushHandlerService",function(e,t,r){t.shutdown(),r.shutdown()}]).controller("motionTestCtrl",["$scope","$rootScope","$state","$stateParams","$filter","devicesService","cameraSettingsService",function(e,t,r,n,i,a,o){e.init=function(){var s=a.getCameraById(n.deviceId);return s?(e.percent=e.startPercent=s.properties.motionSetupModeSensitivity||80,o.updateSettings(s.parentId,s.deviceId,{motionSetupModeEnabled:!0,motionSetupModeSensitivity:e.percent}),e.offChangeStart=t.$on("$stateChangeStart",function(t,n,i,a){e.offChangeStart(),a.name==r.current.name&&o.updateSettings(s.parentId,s.deviceId,{motionSetupModeEnabled:!1})}),e.description=i("i18n")("label_motion_detection_test_description").replace("{cameraName}",e.getCameraName()).replace(/\n/g,"<br>"),e.camera=s,void e.$watch("camera.properties.motionSetupModeEnabled",function(){s.properties.motionSetupModeEnabled||o.updateSettings(e.camera.parentId,e.camera.deviceId,{motionSetupModeEnabled:!0})},!0)):void e.back()},e.back=function(){r.go("settings.camera",{deviceId:n.deviceId})},e.getCameraName=function(){return a.getDeviceName(n.deviceId)},e.sliderClick=function(t){var r=100*(t.layerX-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setPercent(r)},e.setPercent=function(t){e.percent=Math.round(t)||1},e.applySensivity=function(){var t=a.getCameraById(n.deviceId);t&&o.updateSettings(t.parentId,t.deviceId,{motionSetupModeSensitivity:e.percent,motionSetupModeEnabled:!0}),t.properties.motionSetupModeSensitivity=e.startPercent=e.percent}}]).controller("FooterModesCtrl",["$scope","$rootScope","$state","$modal","$filter","appProperties","userService","baseStationService","devicesService","uiService","scheduleValidationService","servicePlanService",function(e,t,r,n,i,a,o,s,c,d,l,u){function f(e){var t=p[Math.floor(e/v)].day;return t}function g(e,t){e.length||e.push({startTime:0,modeId:t[0].id}),e=_.sortBy(e,function(e){return e.startTime});var r=_.pluck(t,"id"),n=_.pluck(p,"day"),i=angular.copy(p),a=_.map(i,function(t){return t.schedule=_.chain(e).filter(function(e){return f(e.startTime)===t.day}).map(function(e){return e.color=m[_.indexOf(r,e.modeId)%m.length],e}).map(function(e){var r=_.indexOf(n,t.day)*v;return e.startTime-=r,e}).value(),t});return _.each(a,function(e,t){if(0===e.schedule.length){var r;r=0===t?_.find(angular.copy(a).reverse(),function(e){return e.schedule.length>0}):_.find(angular.copy(a).splice(0,t).reverse(),function(e){return e.schedule.length>0}),e.schedule[0]=r.schedule[r.schedule.length-1],e.schedule[0].startTime=0}}),_.map(a,function(e){if(!e.schedule.length||e.schedule[0].startTime){var t=0===_.indexOf(n,e.day)?6:_.indexOf(n,e.day)-1,i=a[t].schedule[a[t].schedule.length-1].modeId,o={startTime:0,modeId:i,color:m[_.indexOf(r,i)%m.length]};return e.schedule.unshift(o),e}}),a}var p=[{day:"Monday"},{day:"Tuesday"},{day:"Wednesday"},{day:"Thursday"},{day:"Friday"},{day:"Saturday"},{day:"Sunday"}],v=864e5,m=["#06a94e","#666666"],h=!1;e.init=function(){e.baseStation=null,e.devices=[],c.initDevices(!1).then(function(){e.updateModes()}),e.servicePlan=u.getServicePlan(),e.servicePlan||u.getPurchasedPlans().then(function(){e.servicePlan=u.getServicePlan()},function(e){t.$broadcast(a.appEvents.SHOW_ERROR,e)})},e.$watch("baseStation.scheduleOn",function(){e.baseStation&&e.baseStation.hasOwnProperty("scheduleOn")&&h&&(h=!1)},!0),e.$watch("baseStation.activeMode",function(){e.baseStation&&e.baseStation.hasOwnProperty("activeMode")&&h&&(h=!1)},!0),e.isLoading=function(){var t=!1;return(!e.devices.length&&!e.deviceId||h||!e.servicePlan)&&(t=!0),e.baseStation&&!e.baseStation.hasOwnProperty("scheduleOn")&&(t=!0),e.baseStation&&e.baseStation.hasOwnProperty("scheduleOn")&&!e.baseStation.scheduleOn&&!e.baseStation.hasOwnProperty("modes")&&(t=!0),e.baseStation&&e.baseStation.hasOwnProperty("scheduleOn")&&e.baseStation.scheduleOn&&!e.baseStation.hasOwnProperty("schedule")&&(t=!0),t&&e.baseStation&&e.baseStation.properties.connectionState==a.UNAVAILABLE_STATE?(e.init(),!1):t},e.isStateUnavailable=function(e){return!e.properties||!e.properties.hasOwnProperty("connectionState")},e.updateModes=function(){e.deviceId=null;var t=_.where(c.getBaseStations(),{state:a.PROVISIONED_STATE});t.length&&(1==t.length&&t[0].properties&&t[0].properties.connectionState==a.AVAILABLE_STATE?e.updateMode(t[0]):(e.modes=[],e.devices=t))},e.updateMode=function(t){e.baseStation=t,t&&(e.deviceId=t.deviceId,t.modes?e.modes=t.modes:s.getBaseStationResource(e.deviceId,"modes"),t.schedule||s.getBaseStationResource(e.deviceId,"schedule")),e.$on(a._RESOURCE_UPDATE_,function(){if(e.deviceId){var t=c.getBaseStationById(e.deviceId);t&&t.modes&&(e.modes=t.modes)}})},e.isBaseStationOffline=function(){return e.baseStation&&e.baseStation.properties&&"unavailable"==e.baseStation.properties.connectionState},e.selectMode=function(t){if(t.id!=e.getActiveMode().id){var r={};h=!0,r[a.DEVICE_SETTINGS_ACTIVE]=t.id,s.setActiveMode(e.deviceId,r)}},e.selectBS=function(t){t.properties&&"available"==t.properties.connectionState&&(e.scheduleChanged=!1,e.devices=[],e.updateMode(t))},e.getActiveMode=function(){return c.getBaseStationById(e.deviceId).activeMode},e.toggleScheduleOn=function(){var t=e.baseStation,r={};r[a.DEVICE_SETTINGS_ACTIVE]=t.scheduleOn?!1:!0,h=!0,e.daySchedules=null;var n=s.toggleScheduleOn(t.deviceId,r);n.then(function(){})},e.isScheduleOn=function(){return s.isScheduleOn(e.baseStation)},e.getDaySchedule=function(){if(e.daySchedules)return e.daySchedules;var t=c.getBaseStationById(e.deviceId);return S(t)?(e.scheduleChanged=!1,e.daySchedules=g(angular.copy(t.schedule),t.modes),e.origSchedules=angular.copy(e.daySchedules),e.modes=t.modes,e.daySchedules):null},e.isScheduleChanged=function(){if(e.scheduleChanged)return!0;if(e.daySchedules)for(var t=0;t<e.daySchedules.length;t++){if(e.daySchedules[t].schedule.length!=e.origSchedules[t].schedule.length)return e.scheduleChanged=!0,!0;for(var r=0;r<e.daySchedules[t].schedule.length;r++)if(e.daySchedules[t].schedule[r].modeId!=e.origSchedules[t].schedule[r].modeId||e.daySchedules[t].schedule[r].startTime!=e.origSchedules[t].schedule[r].startTime)return e.scheduleChanged=!0,!0}};var S=function(e){return e&&e.schedule&&e.modes?_.uniq(_.pluck(e.schedule,"modeId")).length<=e.modes.length:!1};e.setColor=function(e){return{"background-color":m[e%m.length]}},e.saveSchedule=function(){var t=angular.copy(e.daySchedules),r=_.map(t,function(e,t){return e.schedule=_.map(e.schedule,function(e){return e.startTime+=24*t*60*60*1e3,_.omit(e,"color")}),e.schedule});r=_.flatten(r),l.validateSchedule(r)&&(s.setSchedule(e.deviceId,r),e.origSchedules=angular.copy(e.daySchedules),e.scheduleChanged=!1)}}]).controller("ModalNotifyCtrl",["$scope","$rootScope","$timeout","userService",function(e,t,r,n){e.posY=e.settingsOffsetTopPosition||0,e.popupDisable=null,null===n.calendarSessionPopup&&n.setCalendarSessionPopup(!0),null===n.rulesSessionPopup&&n.setRulesSessionPopup(!0),"false"===n.calendarClientPopup&&n.setCalendarSessionPopup(!1),"false"===n.rulesClientPopup&&n.setRulesSessionPopup(!1),e.isPopupEnable=e.$parent.libraryMode?n.calendarSessionPopup:n.rulesSessionPopup;var i,a,o;e.$on("settingsScrollingOn",function(){e.posY=e.settingsOffsetTopPosition;for(var t=0;t<i.length;t++)a[t].style.top=e.deltaY+i[t].offsetTop-e.posY+"px"}),e.getArrows=function(){return o?o:(i=document.getElementsByClassName("modal-arrowicon-rules"),a=document.getElementsByClassName("overlay-arrow-icon"),i.length&&r(function(){e.deltaY=44,o=[];for(var t=0;2>t;t++)o.push({posY:e.deltaY+i[t].offsetTop+e.posY+"px"})},100),null)},e.rulesNotifyHide=function(){e.$parent.libraryMode?(e.popupDisable?n.setCalendarClientPopup(!1):"",n.setCalendarSessionPopup(!1)):(e.popupDisable?n.setRulesClientPopup(!1):"",n.setRulesSessionPopup(!1)),e.isPopupEnable=!1}}]),angular.module("arloApp.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]).filter("monthText",["appProperties",function(e){return function(t){if(!t)return"";var r=new Number(t.substring(4))-1,n=e.months[r]+", "+t.substring(0,4);return n}}]).filter("dayText",["appProperties",function(e){return function(t){var r=new Number(t.substring(4,6))-1,n=new Number(t.substring(6)),i=e.months[r]+" "+n.toString()+", "+t.substring(0,4);return i}}]).filter("secToString",function(){return function(e){function t(e){return(10>e?"0":"")+e}var r=Math.floor(e%60),n=Math.floor(e/3600),i=Math.floor((e-3600*n)/60);return t(n)+":"+t(i)+":"+t(r)}}).filter("ownDevices",function(){return function(e){return _.reduce(e,function(e,t){return t.userId===t.owner.ownerId&&e.push(t.parentId),e},[])}}).filter("favorites",["libraryService","routeService","dayService","recordingsService",function(e,t,r,n){return function(e,i){if("undefined"!=e&&null!=e){for(var a=[],o=0;o<e.length;o++){var s=e[o];i.favorites&&"all"!=i.favorites.value?"only"==i.favorites.value&&n.isFavorite(s)?a.push(s):"non"!=i.favorites.value||n.isFavorite(s)||a.push(s):a.push(s)}return t.currentDayRoute=t.getDayRoute(r.day),a}}}]).filter("recycled",["libraryService","routeService","dayService",function(){return function(e){if("undefined"!=e&&null!=e){for(var t=[],r=0;r<e.length;r++){var n=e[r];n.recycle||t.push(n)}return t}}}]).filter("toUTC",function(){return function(e){return e+6e4*(new Date).getTimezoneOffset()}}).filter("toBSTime",function(){return function(e,t){try{return e?e+6e4*((new Date).getTimezoneOffset()-new timezoneJS.Date(e,t).getTimezoneOffset()):""}catch(r){return e}}}).filter("motionLevel",["appProperties","camerasService",function(e,t){return function(r){return r&&t.isCameraOnline(r)?t.isMotionActive(r)?e.CSS_CAMERA_MOTION_ACTIVE:t.isCameraArmed(r)?e.CSS_CAMERA_MOTION_ARMED:e.CSS_CAMERA_MOTION_DISABLED:e.CSS_CAMERA_MOTION_DISABLED}}]).filter("batteryLevel",function(){return function(e){var t;return t=e&&e.properties?e.properties.batteryLevel:100,t>60?"3":t>15?"2":t>0?"1":"0"}}).filter("signalLevel",function(){return function(e){var t;return t=e&&e.properties&&e.properties.signalStrength?-1==e.properties.signalStrength?1:e.properties.signalStrength:4}}).filter("brightLevel",function(){return function(e){if(e&&e.properties.brightness){if(e.properties.brightness<0)return 0;if(e.properties.brightness>0)return 2}return 1}}).filter("planAmount",["servicePlanService",function(e){return function(t){return e.isFreePlan(t)?"Free":("1"==t.term?"Monthly ":"12"==t.term?"Annual ":"")+(t.planCurrencyAmount||t.amount)}}]).filter("storageSize",function(){return function(e){if(0==e)return 0;var t=1024,r=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(e)/Math.log(t));return e/Math.pow(t,n)+" "+r[n]}}),angular.module("arloApp.directives",[]).directive("scheduleHours",["$window","$timeout",function(e,t){return{link:function(r,n){function i(){a.height=n[0].offsetHeight;for(var e=1;24>e;e++){var t,r=Math.ceil(e*a.height/24);11>=e?t=e+" AM":12==e?t=e+" PM":e>12&&(t=e-12+" PM"),o.fillText(t,20,r+1),o.moveTo(65,r-1),o.lineTo(70,r-1),o.stroke()}}var a=n[0],o=a.getContext("2d");o.fillStyle="#fff",o.fillRect(0,0,70,720),o.fillStyle="#999",o.font="10px Arial",o.strokeStyle="#ccc",o.lineWidth=1;var s=angular.element(e);r.$watch(function(){return{w:s[0].innerWidth+"-"+s[0].innerHeight}},function(){i()},!0),r.$watch("baseStation.scheduleOn",function(e){e&&t(i,100)},!0),s.bind("resize",function(){r.$apply()})}}}]).directive("mode",[function(){var e=function(e){(e.originalEvent||e).dataTransfer.effectAllowed="move";var t={modeId:e.currentTarget.getAttribute("mode-id")};try{e.dataTransfer.setData("text/plain",JSON.stringify(t))}catch(r){e.dataTransfer.setData("text",JSON.stringify(t))}},t=function(e){e.preventDefault()};return{restrict:"A",link:function(r,n){n.bind("dragstart",e),n.bind("dragend",t)}}}]).directive("daySchedule",["$window","$log","$timeout",function(e,t){return{restrict:"A",scope:{daySchedule:"=",modes:"="},link:function(r,n){function i(e,t,n,i){for(var a,c,d=0,l=0;l<r.daySchedule.schedule.length;l++){if(c=r.daySchedule.schedule.length===l+1?b.height:o(r.daySchedule.schedule[l+1].startTime),t>=d&&c>t){a=l;break}d=c}var u=(d+c)/2,f=C[_.indexOf(R,i)%C.length];u>t?a&&r.daySchedule.schedule[a-1].modeId===i?r.daySchedule.schedule[a].startTime=s(u):(r.daySchedule.schedule[a].startTime=s(u),r.daySchedule.schedule.push({modeId:i,startTime:s(d),color:f})):a!==r.daySchedule.schedule.length-1&&r.daySchedule.schedule[a+1].modeId===i?r.daySchedule.schedule[a+1].startTime=s(u):r.daySchedule.schedule.push({modeId:i,startTime:s(u),color:f}),r.daySchedule.schedule=_.sortBy(r.daySchedule.schedule,function(e){return e.startTime})}function a(e,t){for(var n,i=0,a=0;a<r.daySchedule.schedule.length;a++){if(n=r.daySchedule.schedule.length===a+1?b.height:o(r.daySchedule.schedule[a+1].startTime),t>=i&&n>t)return r.daySchedule.schedule[a].modeId;i=n}}function o(e){var t=b.height;return Math.floor(e*t/T)}function s(e){var t=b.height;return 0>e?0:Math.floor(e*T/t)}function c(){b.width=n.parent()[0].offsetWidth,b.height=n.parent()[0].offsetHeight;for(var e,t=0,i=0,a=b.width,c=0;c<r.daySchedule.schedule.length;c++)e=r.daySchedule.schedule.length===c+1?b.height:o(r.daySchedule.schedule[c+1].startTime),A.beginPath(),A.fillStyle=r.daySchedule.schedule[c].color,A.fillRect(t,i,a,e),i=e,A.stroke();A.strokeStyle="#ccc";for(var l=1;24>l;l++){var u=Math.ceil(l*b.height/24);A.beginPath(),A.moveTo(0,u-1),A.lineTo(b.width,u-1),A.lineWidth=1,A.stroke()}A.font="bold 12px MorebiRounded-Regular, Arial",A.fillStyle="white";for(var f,g,p,v,m=8,h=8,c=0;c<r.daySchedule.schedule.length;c++){if(r.daySchedule.schedule.length==c+1){var S=o(r.daySchedule.schedule[c].startTime);g=Math.floor(0==c?b.height/2:S+(b.height-S)/2),p=r.daySchedule.schedule[c].startTime,v=s(b.height)}else g=Math.floor(o(r.daySchedule.schedule[c+1].startTime+r.daySchedule.schedule[c].startTime)/2),p=r.daySchedule.schedule[c].startTime,v=r.daySchedule.schedule[c+1].startTime;g-o(r.daySchedule.schedule[c].startTime)>10&&A.fillText(d(p)+" - "+d(v-6e4),h,g),f=g+=20,g-o(r.daySchedule.schedule[c].startTime)>40&&A.fillText(_.findWhere(r.modes,{id:r.daySchedule.schedule[c].modeId}).name,m,f),A.stroke()}A.strokeStyle="#000",A.lineWidth=6;for(var c=1;c<r.daySchedule.schedule.length;c++)i=e=o(r.daySchedule.schedule[c].startTime),A.beginPath(),A.moveTo(t,i),A.lineTo(a,e),A.stroke()}function d(e){e=Math.floor(e/6e4);var t="";return 0==e?t="12am":e>0&&720>e?t=Math.floor(e/60)+":"+(10>e%60?"0"+e%60:e%60)+"am":e>=720&&780>e?t="12:"+(10>e%60?"0"+e%60:e%60)+"pm":e>=780&&1440>e?t=Math.floor(e/60)-12+":"+(10>e%60?"0"+e%60:e%60)+"pm":1440==e&&(t="12pm"),t}function l(e){e&&(r.daySchedule.schedule=_.without(r.daySchedule.schedule,e));var t=[];_.each(r.daySchedule.schedule,function(e,r){(0==r||t[t.length-1].modeId!==e.modeId)&&t.push(e)}),r.daySchedule.schedule=t,c()}function u(e,t){for(var n=1;n<r.daySchedule.schedule.length;n++){var i=o(r.daySchedule.schedule[n].startTime)-3,a=o(r.daySchedule.schedule[n].startTime)+3;if(t>i&&a>t)return!0}return!1}function f(e){for(var t=1;t<r.daySchedule.schedule.length;t++){var n=o(r.daySchedule.schedule[t].startTime)-3,i=o(r.daySchedule.schedule[t].startTime)+3;if(e>n&&i>e)return o(r.daySchedule.schedule[t-1].startTime)}}function g(e){for(var t=1;t<r.daySchedule.schedule.length;t++){var n=o(r.daySchedule.schedule[t].startTime)-3,i=o(r.daySchedule.schedule[t].startTime)+3;if(e>n&&i>e)return t===r.daySchedule.schedule.length-1?b.height:o(r.daySchedule.schedule[t+1].startTime)}}function p(e){var t=_.find(r.daySchedule.schedule,function(t){return t.startTime<s(3+e)&&t.startTime>s(e-3)}),n=_.indexOf(r.daySchedule.schedule,t);return r.daySchedule.schedule[n-1]}function v(e){var t=_.find(r.daySchedule.schedule,function(t){return t.startTime<s(e+3)&&t.startTime>s(e-3)}),n=_.indexOf(r.daySchedule.schedule,t);return r.daySchedule.schedule[n]}function m(e){var t=e.target||e.srcElement,r=t.getBoundingClientRect(),n=e.clientX-r.left;return n}function h(e){var t=e.target||e.srcElement,r=t.getBoundingClientRect(),n=e.clientY-r.top;return n}var S,y,I,E,T=864e5,b=n[0],A=b.getContext("2d"),C=["#06a94e","#666666"],R=_.pluck(r.modes,"id"),w=!1,P=!1,O=!1,D=angular.element(e);r.$watch(function(){return{w:D[0].innerWidth+"-"+D[0].innerHeight}},function(){c()},!0),r.$watch("$parent.$parent.baseStation.scheduleOn",function(e){e&&c()},!0),D.bind("resize",function(){r.$apply()}),n.bind("dragenter",function(){return!1}),n.bind("dragover",function(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.dataTransfer.dropEffect="move",!1}),n.bind("drop",function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();var n,o=m(e),s=h(e);try{n=JSON.parse(e.dataTransfer.getData("text/plain"))}catch(c){n=JSON.parse(e.dataTransfer.getData("text"))}if(n&&n.modeId){var d=n.modeId,u=a(o,s);return d!==u&&(t.debug("schedule before modifying:"+JSON.stringify(r.daySchedule)),i(o,s,u,d),l(),t.debug("schedule modified:"+JSON.stringify(r.daySchedule))),!1}}),n.on("mousemove",function(e){var t=m(e),i=h(e);if(u(t,i)||w){if(n.addClass("separator"),w)return i>S+3&&y-3>i?(E.startTime=s(i),P?(r.daySchedule.schedule.push(I),r.daySchedule.schedule=_.sortBy(r.daySchedule.schedule,function(e){return e.startTime}),P=!1):O&&(r.daySchedule.schedule.push(E),r.daySchedule.schedule=_.sortBy(r.daySchedule.schedule,function(e){return e.startTime}),O=!1)):S+3>=i&&!P?(E.startTime=s(S),r.daySchedule.schedule=_.without(r.daySchedule.schedule,I),P=!0):i>=y-3&&!O&&(E.startTime=s(y),r.daySchedule.schedule=_.without(r.daySchedule.schedule,E),O=!0),c(),e.preventDefault(),!1}else n.removeClass("separator")}),n.on("mousedown",function(e){var t=m(e),r=h(e);return u(t,r)?(w=!0,I=p(r),E=v(r),P=!1,O=!1,S=f(r),y=g(r),e.preventDefault(),!1):void 0}),angular.element(document.body).on("mouseup",function(e){if(w){{m(e),h(e)}w=!1,I&&E&&(I.startTime==E.startTime&&E.startTime==s(S)&&l(I),I.startTime==E.startTime&&E.startTime==s(y)&&l(E))}})}}}]).directive("brightness",["$window",function(){return{restrict:"A",scope:{widgetX:"@",imageUrl:"@",brightness:"="},link:function(e,t){function r(){n()}function n(){s.src&&(a.setAttribute("width",d),a.setAttribute("height",c),i(50))}function i(e){if(a.width>0&&a.height>0){for(var t=o.getImageData(0,0,a.width,a.height),r=t.data,n=0;n<r.length;n+=4)r[n]+=e,r[n+1]+=e,r[n+2]+=e;o.putImageData(t,0,0),o.drawImage(s,0,0,d,c)}}var a=t[0],o=a.getContext("2d"),s=new Image;s.src=e.imageUrl,s.addEventListener("load",r);var c,d=Math.round(e.widgetX);c=s.height&&s.width?Math.round(s.height*(e.widgetX/s.width)):9*e.widgetX/16,e.$watch("imageUrl",function(){return e.imageUrl?(s.src=e.imageUrl,void r()):void(s.src=null)})}}}]).directive("invert",["$window",function(){return{restrict:"A",scope:{widgetX:"@",imageUrl:"@",flip:"=",mirror:"="},link:function(e,t){function r(){n()}function n(){s.src&&(e.flip?(a.setAttribute("width",d),a.setAttribute("height",c),o.drawImage(s,0,0,d,c),i()):(a.setAttribute("width",d),a.setAttribute("height",c),o.drawImage(s,0,0,d,c)))}function i(){o.save(),o.translate(d/2,c/2),o.rotate(Math.PI),o.drawImage(s,-d/2,-c/2,d,c),o.restore()}var a=t[0],o=a.getContext("2d"),s=new Image;s.src=e.imageUrl,s.addEventListener("load",r);var c,d=Math.round(e.widgetX);c=s.height&&s.width?Math.round(s.height*(e.widgetX/s.width)):9*e.widgetX/16,e.$watch("imageUrl",function(){return e.imageUrl?(s.src=e.imageUrl,void r()):void(s.src=null)}),t.on("click",function(){e.flip=e.flip?!1:!0,e.mirror=e.flip,n()})}}}]).directive("zoomDisplay",["$window","$log","$rootScope","appProperties",function(e,t,r,n){return{restrict:"A",scope:{imageUrl:"@",tlX:"=",tlY:"=",brX:"=",brY:"=",widgetRule:"=",cameraId:"="},link:function(i,a){function o(e,t){b&&T&&(N=1,$=1,_>b&&(N=b/_),C>T&&($=T/C),e.tlX=Math.floor(t.tlX*N),e.tlY=Math.floor(t.tlY*$),e.brX=Math.floor(t.brX*N),e.brY=Math.floor(t.brY*$))}function s(e,t,r,n){i.widgetRule?(i.tlX=Math.floor(e/N),i.tlY=Math.floor(t/$),i.brX=Math.floor(r/N),i.brY=Math.floor(n/$)):(i.tlX=16*Math.floor(e/N/16),i.tlY=9*Math.floor(t/$/9),i.brX=16*Math.floor(r/N/16),i.brY=9*Math.floor(n/$/9))}function c(){I(U.tlX,U.tlY,U.brX,U.brY)}function d(e){if(e.offsetX)return e.offsetX;var t=e.layerX;return t}function l(e){if(e.offsetY)return e.offsetY;var t=e.layerY;return t}function u(){var e=U.tlX+H.dx,t=U.tlY+H.dy,r=U.brX+H.dx,n=U.brY+H.dy;p(e,t,r,n)&&(s(e,t,r,n),U.tlX=e,U.tlY=t,U.brX=r,U.brY=n,c())}function f(){var e=U.tlX,t=U.tlY,r=U.brX,n=U.brY;W?(e+=H.dx,t+=H.dy):(r+=H.dx,n+=H.dy),p(e,t,r,n)&&g(e,t,r,n)&&(s(e,t,r,n),U.tlX=e,U.tlY=t,U.brX=r,U.brY=n,c())}function g(e,t,r,n){e/=N,t/=$,r/=N,n/=$;var a=r-e>=(i.widgetRule?D:R)&&P>=r-e&&n-t>=(i.widgetRule?D:w)&&O>=n-t;return a}function p(e,t,r,n){if(0>e||0>t)return!1;var i=Math.round(M.height*(b/M.width));return r>b||n>i?!1:!0}function v(e,t){return y(e,U.tlX,U.brX)&&y(t,U.tlY,U.brY)&&!m(e,t)}function m(e,t){return h(e,t)||S(e,t)}function h(e,t){return y(e,U.tlX,U.tlX+A)&&y(t,U.tlY,U.tlY+A)}function S(e,t){return y(e,U.brX-A,U.brX)&&y(t,U.brY-A,U.brY)}function y(e,t,r){return e>=t&&r>=e}function I(e,t,r,n){if(M.src){E.setAttribute("width",b),E.setAttribute("height",T);var i=E.getContext("2d");i.globalAlpha=.2,i.drawImage(M,0,0,b,T),i.globalAlpha=1,i.lineWidth=3,i.strokeStyle="#06a94e",i.beginPath(),i.moveTo(e,t),i.lineTo(r,t),i.lineTo(r,n),i.lineTo(e,n),i.closePath(),i.stroke(),i.save(),i.clip(),i.drawImage(M,0,0,b,T),i.restore(),i.fillStyle="#0f6d35",i.fillRect(e,t,A,A),i.fillRect(r-A,n-A,A,A)}}var E,T,b,A=16,C=720,_=1280,R=384,w=216,P=1280,O=720,D=144,M=new Image;M.src=i.imageUrl||"/img2/camera_thumb.png",E=a[0];var N,$,U={tlX:null,tlY:null,brX:null,brY:null},B=!0;i.brX>P&&(i.brX=1280),i.brY>O&&(i.brY=720),M.addEventListener("load",function(){o(U,i),c()}),M.addEventListener("error",function(){t.debug("error loading full frame snapshot"),M.src&&r.$broadcast(n.appEvents.TAKE_SNAPSHOT,i.cameraId),M.src="/img2/camera_thumb.png"}),i.$watch("tlX",function(){"undefined"!=typeof i.tlX&&B&&(i.brX>P&&(i.brX=1280),i.brY>O&&(i.brY=720),o(U,i),c(),B=!1)}),i.$watch("imageUrl",function(){M.src=i.imageUrl||"/img2/camera_thumb.png",t.debug("calling drawInitialImage from watch imageUrl handler"),"undefined"!=typeof i.tlX&&(o(U,i),c())});var V=angular.element(e);i.$watch(function(){return{w:V[0].innerWidth}},function(){b=a.parent()[0].offsetWidth,T=Math.round(9*b/16),o(U,i),c()},!0),V.bind("resize",function(){i.$apply()});var x=null,k=null,L=null,F=null,H={dx:0,dy:0},J=!1,G=!1,W=!1;a.on("mousedown",function(e){e.preventDefault(),x=d(e),k=l(e),v(x,k)?J=!0:m(x,k)&&(G=!0,W=h(x,k))}),a.on("dblclick",function(e){e.preventDefault(),i.tlX=0,i.tlY=0,i.brX=P,i.brY=O,o(U,i),c()}),a.on("mousemove",function(e){(J||G)&&(L=d(e),F=l(e),H.dx=L-x,H.dy=F-k,x=L,k=F,G?(i.widgetRule||(H.dy=9*H.dx/16),f()):J&&u())}),angular.element(document.body).on("mouseup",function(){(J||G)&&(J=!1,G=!1)})}}}]).directive("defaultImage",["$log",function(e){var t={link:function(t,r,n){r.bind("error",function(){e.warn("default image set on error"),angular.element(this).attr("src",n.defaultImage)})}};return t}]).directive("passwordVerify",[function(){return{require:"ngModel",scope:{passwordVerify:"="},link:function(e,t,r,n){e.ctrl=n,e.$watch("passwordVerify+ctrl.$viewValue",function(t){(t||""==t)&&n.$setValidity("newPasswordVerify",(e.passwordVerify||"")==e.ctrl.$viewValue)})}}}]).directive("cardNumber",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,n){var i=function(e){var t=e&&e.match(/^[\d]{16}$/);if(t){var r=e.split(""),i=r.pop();r=r.reverse();var a=_.reduce(r,function(e,t,r){return(r+1)%2&&(t*=2,t=t>9?t-9:t),e+=parseInt(t)},0);t=(10-a%10)%10===parseInt(i)}return n.$setValidity("cardNumber",t),e
},a=function(e){var t=e&&e.match(/^[\d]{16}$/);if(t){var r=e.split(""),i=r.pop();r=r.reverse();var a=_.reduce(r,function(e,t,r){return(r+1)%2&&(t*=2,t=t>9?t-9:t),e+=parseInt(t)},0);t=(10-a%10)%10===parseInt(i)}return n.$setValidity("cardNumber",t),e};n.$parsers.unshift(i),n.$formatters.unshift(a)}}}).directive("cardCvv",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,n){var i=function(e){var t=e&&e.match(/^[\d]{3,4}$/);return n.$setValidity("cardCvv",t),e},a=function(e){var t=e&&e.match(/^[\d]{3,4}$/);return n.$setValidity("cardCvv",t),e};n.$parsers.unshift(i),n.$formatters.unshift(a)}}}).directive("cardExpiration",[function(){return{require:"ngModel",scope:{monthVerify:"="},link:function(e,t,r,n){e.$watch(function(){var t;return(e.monthVerify||n.$viewValue)&&(t=e.monthVerify+"_"+n.$viewValue),t},function(){var t=n.$viewValue;if(!t||n.$error.required||e.$parent.cardInformationForm.cc_exp_mm.$error.required)return n.$setValidity("cardExpiration",!0),n.$viewValue;var r=t.match(/^[\d]{4}$/);if(r){var i=new Date,a=i.getUTCMonth()+1,o=i.getUTCFullYear(),s=parseInt(e.monthVerify);r=100*n.$viewValue+s>=100*o+a}return r||e.$parent.cardInformationForm.cc_exp_mm.$setViewValue(e.$parent.cardInformationForm.cc_exp_mm.$viewValue),e.$parent.cardInformationForm.cc_exp_mm.$setValidity("cardExpiration",r),n.$viewValue})}}}]).directive("emailUsed",["$timeout","userService",function(e,t){return{restrict:"A",require:"ngModel",link:function(r,n,i,a){var o;return r.$watch(function(){return a.$modelValue},function(r){return e.cancel(o),!r||a.$error.email||a.$error.emailArlo||r==i.emailUsed?void a.$setValidity("used",!0):void(o=e(function(){t.checkEmailUsage(r).then(function(e){return a.$setValidity("used",a.$pristine||!e.data.data.used)},function(){return a.$setValidity("used",!0)})},400))})}}}]).directive("emailUnknown",["$timeout","userService",function(e,t){return{restrict:"A",require:"ngModel",link:function(r,n,i,a){var o;return r.$watch(function(){return a.$modelValue},function(r){return e.cancel(o),!r||a.$error.email?void a.$setValidity("unknown",!0):void(o=e(function(){t.checkEmailUsage(r).then(function(e){return a.$setValidity("unknown",e.data.data.used)},function(){return a.$setValidity("unknown",!0)})},400))})}}}]).directive("friendUnique",["$timeout","friendsService",function(e,t){return{restrict:"A",require:"ngModel",link:function(e,r,n,i){return e.$watch(function(){return i.$modelValue},function(e){if(!e||i.$error.email)return void i.$setValidity("unique",!0);var r=_.findWhere(t.friends,{email:e});return r?i.$setValidity("unique",!1):i.$setValidity("unique",!0)})}}}]).directive("toggle",[function(){return{restrict:"A",scope:{model:"="},link:function(e){e.$watch("model.value",function(){e.selected=e.model.value===e.$id?"active":""}),e.toggleMe=function(){e.model.value=e.$id}}}}]).directive("autoFillFix",[function(){return function(e,t,r){t.prop("method","POST"),r.ngSubmit&&setTimeout(function(){t.unbind("submit").bind("submit",function(n){n.preventDefault(),t.find("input").triggerHandler("change"),e.$apply(r.ngSubmit)})},0)}}]).directive("sliderDrag",["$document",function(e){return function(t,r,n){function i(e){var t;t=e.pageX<c?0:e.pageX>d?100:100*(e.pageX-c)/(d-c),l.setSliderPosition&&(l.setSliderPosition(t),l.$apply()),l.setPercent&&(l.setPercent(t,n.sliderDrag),l.$apply())}function a(){e.unbind("mousemove",i),e.unbind("mouseup",a),e.unbind("mouseleave",a)}var o=0,s=0,c=0,d=0,l=t;r.on("mousedown",function(t){t.preventDefault();var n=r.parent()[0].offsetWidth-20,l=parseFloat(r.css("left"));c=t.pageX-l*n/100,d=c+n,o=t.pageX-s,e.on("mousemove",i),e.on("mouseup",a),e.on("mouseleave",a)})}}]).directive("recordingVideo",["$document","$timeout","$filter",function(){return function(e,t){t.on("timeupdate",function(){e.$apply(function(){e.time=t[0].currentTime,e.timePercent=t[0].duration?100*(t[0].currentTime/t[0].duration):0})}),t.on("ended",function(){t[0].pause(),e.$apply(function(){e.playing=!1})}),t.on("loadedmetadata",function(){e.$apply(function(){e.time=0,e.duration=t[0].duration,e.timePercent=0,e.isLoadingVideo=!1,e.play()})}),t.on("click",function(){e.$apply(function(){e.playing?e.pause():e.play()})}),t.on("error",function(){})}}]).directive("recordingBox",["$window","$timeout",function(e,t){return{link:function(r,n,i){function a(){var e=o[0].innerHeight,t=e-(i.hasOwnProperty("recordingShared")?160:274);n.css("height",t+"px"),n.css("width",1.7778*t+"px")}var o=angular.element(e);r.$watch(function(){return{w:o[0].innerHeight}},function(){a()},!0),o.bind("resize",function(){r.$apply()}),t(a)}}}]).directive("requiredTip",["$filter",function(){return{replace:!0,restrict:"E",template:"<div class='required-tip'>{{'label_required_fields' | i18n}}</div>"}}]).directive("cameraThumbnail",["$document","$timeout",function(){return function(e,t){t.on("error",function(){t[0].src="/img2/camera_thumb.png"})}}]).directive("sortable",["$document","$timeout","$log","$filter",function(e,t,r,n){return{restrict:"A",require:"?ngModel",scope:{ngModel:"="},link:function(e,r,i,a){e.$watch("ngModel",function(e){e&&e.length>1&&t(function(){r.updateSortable()},100)},!0);var o=r.sortable();o.on("sortupdate",function(t,r){e.$apply(function(){var t=n("orderBy")(a.$modelValue,"displayOrder");if(r.oldIndex<r.newIndex){t[r.oldIndex].displayOrder=r.newIndex+1;for(var i=r.oldIndex+1;i<r.newIndex+1;i++)t[i].displayOrder=i}else if(r.oldIndex>r.newIndex){t[r.oldIndex].displayOrder=r.newIndex+1;for(var i=r.newIndex;i<r.oldIndex;i++)t[i].displayOrder=i+2}e.$parent.sortDevices()})})}}}]).directive("recordTimer",function(){return{restrict:"A",require:"ngModel",scope:{model:"=ngModel"},link:function(e,t,r){function n(){e.millis=new Date-e.startTime;var t=e.millis%1e3;i(),e.timeoutId=setTimeout(function(){n(),e.$digest()},e.interval-t)}function i(){var r=Math.floor(e.millis/1e3),n=Math.floor(r%60),i=Math.floor(r/3600),a=Math.floor((r-3600*i)/60),o=10>n?"0"+n:n,s=10>a?"0"+a:a,c=10>i?"0"+i:i;t.text(c+":"+s+":"+o)}e.isRunning=!1,e.interval=1e3,e.start=function(){e.startTime=new Date,n(),e.isRunning=!0},e.stop=function(){e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=null,e.isRunning=!1},t.bind("$destroy",function(){e.stop()}),e.$parent.$watch(r.ngModel,function(t){!e.isRunning&&t?e.start():e.isRunning&&!t&&e.stop()},!0)}}}).directive("bodyEvents",["$rootScope","appProperties",function(e,t){return function(r,n){n.on("click",function(r){e.$broadcast(t.appEvents.BODY_CLICK,r)})}}]).directive("scrollTop",["$rootScope","$uiViewScroll","appProperties",function(e,t,r){return function(n,i){e.$on(r.appEvents.SCROLL_TOP,function(){t(i)})}}]).directive("emailArlo",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,n){var i=/^(?!.{191})[\w!#$%&'*+/=?`{|}~^-]+(?:\.[\w!#$%&'*+/=?`{|}~^-]+)*@?(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,6}$/,a=function(e){var t=e&&e.match(i);return n.$setValidity("emailArlo",t),e},o=function(e){var t=e&&e.match(i);return n.$setValidity("emailArlo",t),e};n.$parsers.unshift(a),n.$formatters.unshift(o)}}}).directive("selectRecording",function(){return function(e,t){t.on("click",function(){e.$parent.selectRecording(e.recording.recordingNumber),e.recording.selected?t.addClass("vlist-preview-selected"):t.removeClass("vlist-preview-selected"),e.$parent.$apply()})}}).directive("selectAllRecordings",["$rootScope",function(e){return function(t,r){e.$on("selectAllRecordings",function(){for(var e=t.$parent.getRecordings(),n=0;n<e.length;n++)t.$parent.isFriendRecording(e[n])||r.children().children().eq(n).addClass("vlist-preview-selected")})}}]).directive("selectAllRecycleRecordings",function(){return function(e,t){e.$on("selectAllRecycleRecordings",function(){t.children().children().children().addClass("vlist-preview-selected")})}}).directive("unselectAllRecycleRecordings",function(){return function(e,t){e.$on("unselectAllRecycleRecordings",function(){t.children().children().children().removeClass("vlist-preview-selected")})}}).directive("recycleModeTrigger",function(){return function(e){e.$on("recycleModeEnable",function(){e.recycleModeEnable=!0}),e.$on("recycleModeDisable",function(){e.recycleModeEnable=!1})}}).directive("footerButtons",["$timeout","$filter",function(e,t){return{restrict:"A",link:function(e,r,n){function i(e,t){var r=i.canvas||(i.canvas=document.createElement("canvas")),n=r.getContext("2d");n.font=t||"12px MorebiRounded-Regular, Arial";var a=n.measureText(e);return Math.ceil(a.width)}function a(){var e=_.max(n.hasOwnProperty("selectBar")?[i(t("i18n")("select_bar_label_favorite")),i(t("i18n")("select_bar_label_share")),i(t("i18n")("select_bar_label_download")),i(t("i18n")("select_bar_label_delete")),30]:[i(t("i18n")("navigation_label_mode")),i(t("i18n")("navigation_label_cameras")),i(t("i18n")("navigation_label_library")),i(t("i18n")("navigation_label_settings")),30]);_.each(r.children(),function(t){angular.element(t.children[0]).css("width",e+"px")})}e.$on("localizeResourcesUpdated",function(){a()}),a()}}}]).directive("scrollPosition",["$document",function(){return function(e,t){t.on("scroll",function(t){e.scrollTopPosition(t.target.scrollTop)})}}]).directive("offers",["$rootScope","$filter",function(e){return{restrict:"A",link:function(t,r){t.$on("offers",function(t,n){r.html(n);var i=r.find("a");_.each(i,function(t){var r=t.href;if(-1!=r.indexOf("planId")){var n=r.split("?")[1].split("&"),i={};_.each(n,function(e){var t=e.split("=");i[t[0]]=t[1]}),angular.element(t).on("click",function(t){e.$broadcast("plan_selected",i),t.preventDefault()}),t.href=""}})})}}}]);